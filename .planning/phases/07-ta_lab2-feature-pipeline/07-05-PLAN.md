---
phase: 07-ta_lab2-feature-pipeline
plan: 05
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - src/ta_lab2/scripts/features/ta_feature.py
  - src/ta_lab2/scripts/features/refresh_cmc_ta_daily.py
  - sql/features/042_cmc_ta_daily.sql
  - sql/lookups/021_dim_indicators.sql
  - tests/features/test_ta_feature.py
autonomous: true

must_haves:
  truths:
    - "cmc_ta_daily calculates RSI, MACD, and other indicators respecting sessions"
    - "Multiple parameter sets supported (RSI_14, RSI_21, MACD_12_26_9, MACD_8_17_9)"
    - "dim_indicators table defines which indicator parameters to calculate"
  artifacts:
    - path: "src/ta_lab2/scripts/features/ta_feature.py"
      provides: "TA indicators feature implementation"
      exports: ["TAFeature", "TAConfig"]
    - path: "src/ta_lab2/scripts/features/refresh_cmc_ta_daily.py"
      provides: "CLI refresh script"
      contains: "if __name__"
    - path: "sql/features/042_cmc_ta_daily.sql"
      provides: "TA indicators table DDL"
      contains: "CREATE TABLE"
    - path: "sql/lookups/021_dim_indicators.sql"
      provides: "Indicator parameters metadata"
      contains: "CREATE TABLE"
    - path: "tests/features/test_ta_feature.py"
      provides: "Unit tests for TA indicators"
      min_lines: 180
  key_links:
    - from: "ta_feature.py"
      to: "BaseFeature"
      via: "class TAFeature(BaseFeature)"
      pattern: "class TAFeature\\(BaseFeature\\)"
    - from: "ta_feature.py"
      to: "features/indicators.py"
      via: "rsi, macd, stoch_kd, bollinger, atr, adx"
      pattern: "from ta_lab2\\.features\\.indicators import"
    - from: "ta_feature.py"
      to: "dim_indicators"
      via: "query for parameter sets"
      pattern: "dim_indicators"
---

<objective>
Implement cmc_ta_daily feature table with RSI, MACD, Stochastic, Bollinger, ADX, and other technical indicators.

Purpose: Calculate technical indicators with multiple parameter sets, configurable via dim_indicators metadata table.
Output: TA feature module, refresh script, DDLs, and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-CONTEXT.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-01-SUMMARY.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-02-SUMMARY.md

# Key existing code:
@src/ta_lab2/features/indicators.py
@src/ta_lab2/scripts/features/base_feature.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dim_indicators and cmc_ta_daily DDL</name>
  <files>
    sql/lookups/021_dim_indicators.sql
    sql/features/042_cmc_ta_daily.sql
  </files>
  <action>
    **dim_indicators DDL (parameter configuration):**
    ```sql
    CREATE TABLE IF NOT EXISTS public.dim_indicators (
        indicator_id    SERIAL PRIMARY KEY,
        indicator_type  TEXT NOT NULL,         -- 'rsi', 'macd', 'stoch', 'bb', 'atr', 'adx'
        indicator_name  TEXT NOT NULL UNIQUE,  -- 'rsi_14', 'macd_12_26_9'
        params          JSONB NOT NULL,        -- {"period": 14} or {"fast": 12, "slow": 26, "signal": 9}
        is_active       BOOLEAN DEFAULT TRUE,
        description     TEXT,
        created_at      TIMESTAMPTZ DEFAULT now()
    );

    -- Insert standard parameter sets
    INSERT INTO public.dim_indicators (indicator_type, indicator_name, params, description)
    VALUES
        -- RSI variations
        ('rsi', 'rsi_14', '{"period": 14}', 'Standard RSI (14 periods)'),
        ('rsi', 'rsi_21', '{"period": 21}', 'RSI (21 periods)'),
        ('rsi', 'rsi_7', '{"period": 7}', 'Short-term RSI'),

        -- MACD variations
        ('macd', 'macd_12_26_9', '{"fast": 12, "slow": 26, "signal": 9}', 'Standard MACD'),
        ('macd', 'macd_8_17_9', '{"fast": 8, "slow": 17, "signal": 9}', 'Fast MACD'),

        -- Stochastic
        ('stoch', 'stoch_14_3', '{"k": 14, "d": 3}', 'Standard Stochastic'),

        -- Bollinger Bands
        ('bb', 'bb_20_2', '{"window": 20, "n_sigma": 2.0}', 'Standard Bollinger Bands'),

        -- ATR
        ('atr', 'atr_14', '{"period": 14}', 'Standard ATR'),

        -- ADX
        ('adx', 'adx_14', '{"period": 14}', 'Standard ADX')
    ON CONFLICT (indicator_name) DO NOTHING;
    ```

    **cmc_ta_daily DDL:**
    ```sql
    CREATE TABLE IF NOT EXISTS public.cmc_ta_daily (
        id              INTEGER NOT NULL,
        ts              TIMESTAMPTZ NOT NULL,

        -- Price context
        close           DOUBLE PRECISION,

        -- RSI (multiple periods)
        rsi_7           DOUBLE PRECISION,
        rsi_14          DOUBLE PRECISION,
        rsi_21          DOUBLE PRECISION,

        -- MACD (multiple parameter sets)
        macd_12_26      DOUBLE PRECISION,      -- MACD line
        macd_signal_9   DOUBLE PRECISION,      -- Signal line
        macd_hist_12_26_9 DOUBLE PRECISION,    -- Histogram
        macd_8_17       DOUBLE PRECISION,
        macd_signal_9_fast DOUBLE PRECISION,
        macd_hist_8_17_9 DOUBLE PRECISION,

        -- Stochastic
        stoch_k_14      DOUBLE PRECISION,
        stoch_d_3       DOUBLE PRECISION,

        -- Bollinger Bands
        bb_ma_20        DOUBLE PRECISION,
        bb_up_20_2      DOUBLE PRECISION,
        bb_lo_20_2      DOUBLE PRECISION,
        bb_width_20     DOUBLE PRECISION,

        -- ATR and ADX
        atr_14          DOUBLE PRECISION,
        adx_14          DOUBLE PRECISION,

        -- Normalized versions
        rsi_14_zscore   DOUBLE PRECISION,

        -- Data quality
        is_outlier      BOOLEAN DEFAULT FALSE,

        -- Metadata
        updated_at      TIMESTAMPTZ DEFAULT now(),

        PRIMARY KEY (id, ts)
    );

    CREATE INDEX IF NOT EXISTS idx_cmc_ta_daily_id_ts
    ON public.cmc_ta_daily (id, ts DESC);

    COMMENT ON TABLE public.cmc_ta_daily IS
    'Daily technical indicators. Parameter sets defined in dim_indicators.';
    ```
  </action>
  <verify>
    Both files exist with correct schema
  </verify>
  <done>
    DDL files exist for dim_indicators and cmc_ta_daily
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TAFeature class</name>
  <files>
    src/ta_lab2/scripts/features/ta_feature.py
  </files>
  <action>
    Create TAFeature extending BaseFeature.

    **TAConfig:**
    ```python
    @dataclass(frozen=True)
    class TAConfig(FeatureConfig):
        feature_type: str = "ta"
        output_table: str = "cmc_ta_daily"
        null_strategy: str = "interpolate"  # Per CONTEXT.md - indicators interpolate
        add_zscore: bool = True

        # Override to load from dim_indicators
        load_indicators_from_db: bool = True
    ```

    **TAFeature implementation:**
    ```python
    class TAFeature(BaseFeature):
        """
        Compute daily technical indicators.

        Uses existing indicators.py functions:
        - rsi(): RSI with configurable period
        - macd(): MACD with fast/slow/signal
        - stoch_kd(): Stochastic %K/%D
        - bollinger(): Bollinger Bands
        - atr(): Average True Range
        - adx(): ADX

        Parameter sets loaded from dim_indicators table.
        """

        def load_source_data(self, ids, start, end) -> pd.DataFrame:
            """Load from cmc_price_bars_1d with OHLCV."""
            # Query for id, ts, open, high, low, close, volume
            # Order by id, ts ASC

        def load_indicator_params(self) -> list[dict]:
            """Load active indicator parameters from dim_indicators."""
            # Query: SELECT * FROM dim_indicators WHERE is_active = TRUE
            # Return list of dicts with indicator_type, indicator_name, params

        def compute_features(self, df_source: pd.DataFrame) -> pd.DataFrame:
            """
            Compute all active indicators.

            For each (id):
            1. Apply null handling (interpolate per config)
            2. For each active indicator in dim_indicators:
               - Parse params from JSONB
               - Call corresponding indicators.py function
               - Add columns to result

            Handle gracefully when volume is NULL (skip volume-based indicators).
            """

        def _compute_rsi(self, df, params) -> pd.DataFrame: ...
        def _compute_macd(self, df, params) -> pd.DataFrame: ...
        def _compute_stoch(self, df, params) -> pd.DataFrame: ...
        def _compute_bollinger(self, df, params) -> pd.DataFrame: ...
        def _compute_atr(self, df, params) -> pd.DataFrame: ...
        def _compute_adx(self, df, params) -> pd.DataFrame: ...

        def get_output_schema(self) -> dict[str, str]:
            # Dynamic based on active indicators

        def get_feature_columns(self) -> list[str]:
            # Dynamic based on active indicators
    ```

    **Important details:**
    - Reuse ALL functions from indicators.py with inplace=True
    - Load parameter sets from dim_indicators (configurable)
    - Handle missing volume gracefully (skip OBV, MFI)
    - Session-aware: Use dim_sessions for market hours if needed (future)
  </action>
  <verify>
    python -c "from ta_lab2.scripts.features.ta_feature import TAFeature, TAConfig; print('imports OK')"
  </verify>
  <done>
    TAFeature imports successfully with all methods implemented
  </done>
</task>

<task type="auto">
  <name>Task 3: Create refresh script and tests</name>
  <files>
    src/ta_lab2/scripts/features/refresh_cmc_ta_daily.py
    tests/features/test_ta_feature.py
  </files>
  <action>
    **refresh_cmc_ta_daily.py CLI:**
    ```python
    """
    Incremental daily TA indicators refresh from cmc_price_bars_1d.

    Usage:
        python -m ta_lab2.scripts.features.refresh_cmc_ta_daily --ids 1,52
        python -m ta_lab2.scripts.features.refresh_cmc_ta_daily --all
        python -m ta_lab2.scripts.features.refresh_cmc_ta_daily --indicators rsi_14,macd_12_26_9

    State tracked in public.cmc_feature_state (feature_type='ta').
    """
    from ta_lab2.scripts.features.state_manager import FeatureStateManager

    def main():
        parser = argparse.ArgumentParser()
        parser.add_argument("--ids", help="Comma-separated IDs")
        parser.add_argument("--all", action="store_true")
        parser.add_argument("--start", help="Start date YYYY-MM-DD")
        parser.add_argument("--full-refresh", action="store_true")
        parser.add_argument("--indicators", help="Comma-separated indicator names")
        parser.add_argument("--dry-run", action="store_true")
        args = parser.parse_args()

        # Initialize engine, config, feature
        engine = get_engine()
        config = TAConfig()
        feature = TAFeature(engine, config)

        # CRITICAL: FeatureStateManager integration for incremental refresh
        state_manager = FeatureStateManager(engine, feature_type="ta")

        # Load state to determine dirty window
        state = state_manager.load_state(ids)
        dirty_start = state.get_dirty_window_start()

        # Compute features for dirty window
        result_df = feature.compute_for_ids(ids, start=dirty_start)

        # Update state after completion
        state_manager.update_state_from_output(ids, result_df)
    ```

    **test_ta_feature.py tests:**
    1. test_ta_config_defaults - Correct defaults
    2. test_load_indicator_params - Queries dim_indicators
    3. test_compute_rsi_14 - RSI calculation correct
    4. test_compute_rsi_multiple_periods - Multiple RSI params
    5. test_compute_macd_standard - MACD 12/26/9 correct
    6. test_compute_macd_fast - MACD 8/17/9 correct
    7. test_compute_stochastic - Stoch K/D correct
    8. test_compute_bollinger - BB with n_sigma correct
    9. test_compute_atr - ATR matches vol.py
    10. test_compute_adx - ADX calculation correct
    11. test_null_handling_interpolate - Gaps interpolated
    12. test_missing_volume_graceful - Skip volume indicators
    13. test_compute_for_ids_full_flow - Template method works
    14. test_dynamic_indicators - Only active indicators computed

    Use synthetic price data with known indicator values.
    Verify RSI stays 0-100, Stoch K/D stay 0-100.
  </action>
  <verify>
    pytest tests/features/test_ta_feature.py -v
    python -m ta_lab2.scripts.features.refresh_cmc_ta_daily --help
  </verify>
  <done>
    All tests pass, CLI shows help with --indicators option
  </done>
</task>

</tasks>

<verification>
- [ ] dim_indicators table created with standard parameter sets
- [ ] cmc_ta_daily DDL has columns for all standard indicators
- [ ] TAFeature extends BaseFeature correctly
- [ ] All indicator functions from indicators.py reused
- [ ] Parameter sets loaded from dim_indicators dynamically
- [ ] Refresh script uses FeatureStateManager for incremental logic
- [ ] --indicators CLI option filters which indicators to compute
- [ ] All 14 tests pass
</verification>

<success_criteria>
- dim_indicators defines: RSI (7,14,21), MACD (standard,fast), Stoch, BB, ATR, ADX
- cmc_ta_daily table stores all computed indicators
- Indicator params configurable via database (add new without code change)
- Z-score normalization for RSI
- Incremental refresh only computes new rows (via FeatureStateManager)
- Volume-based indicators skipped gracefully when volume NULL
</success_criteria>

<output>
After completion, create `.planning/phases/07-ta_lab2-feature-pipeline/07-05-SUMMARY.md`
</output>
