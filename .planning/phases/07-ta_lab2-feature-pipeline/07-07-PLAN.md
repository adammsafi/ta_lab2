---
phase: 07-ta_lab2-feature-pipeline
plan: 07
type: execute
wave: 4
depends_on: [07-06]
files_modified:
  - src/ta_lab2/scripts/features/validate_features.py
  - src/ta_lab2/scripts/features/run_all_feature_refreshes.py
  - tests/features/test_validate_features.py
  - tests/features/test_feature_pipeline_integration.py
autonomous: true

must_haves:
  truths:
    - "Data consistency checks detect gaps, anomalies, and outliers"
    - "Validation runs after each refresh and alerts on issues"
    - "Cross-table consistency verified (returns match price changes)"
  artifacts:
    - path: "src/ta_lab2/scripts/features/validate_features.py"
      provides: "Feature validation and consistency checks"
      exports: ["validate_features", "FeatureValidator"]
    - path: "src/ta_lab2/scripts/features/run_all_feature_refreshes.py"
      provides: "Orchestrated refresh for all feature tables"
      contains: "if __name__"
    - path: "tests/features/test_validate_features.py"
      provides: "Tests for validation logic"
      min_lines: 200
    - path: "tests/features/test_feature_pipeline_integration.py"
      provides: "Integration tests for full pipeline"
      min_lines: 150
  key_links:
    - from: "validate_features.py"
      to: "dim_timeframe"
      via: "expected date schedule"
      pattern: "dim_timeframe"
    - from: "validate_features.py"
      to: "telegram.py"
      via: "send_validation_alert"
      pattern: "from ta_lab2\\.notifications\\.telegram import"
    - from: "run_all_feature_refreshes.py"
      to: "validate_features.py"
      via: "run_validation()"
      pattern: "validate_features"
---

<objective>
Create data consistency validation and orchestrated refresh pipeline for all feature tables.

Purpose: Detect gaps, anomalies, and outliers with automated alerts; provide single command to refresh entire feature pipeline.
Output: Validation module, orchestration script, and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-CONTEXT.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-06-SUMMARY.md

# Validation patterns from Phase 6:
@src/ta_lab2/scripts/emas/validate_ema_rowcounts.py
@src/ta_lab2/notifications/telegram.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FeatureValidator class</name>
  <files>
    src/ta_lab2/scripts/features/validate_features.py
  </files>
  <action>
    Create comprehensive validation module following Phase 6 patterns.

    **FeatureValidator class:**
    ```python
    class FeatureValidator:
        """
        Validates feature data for gaps, anomalies, and cross-table consistency.

        Validation types:
        1. Gap detection: Missing dates vs expected schedule
        2. Outlier detection: Values outside normal bounds
        3. Cross-table consistency: Returns match price changes
        4. Rowcount validation: Expected vs actual counts
        5. NULL ratio: Excessive NULLs indicate data issues
        """

        def __init__(self, engine: Engine):
            self.engine = engine
            self.issues: list[ValidationIssue] = []

        def validate_all(
            self,
            ids: list[int],
            start: str,
            end: str,
        ) -> ValidationReport:
            """Run all validations and return report."""

        def check_gaps(
            self,
            table: str,
            ids: list[int],
            start: str,
            end: str,
        ) -> list[GapIssue]:
            """
            Detect missing dates vs expected schedule.

            Uses dim_timeframe + dim_sessions to know expected dates.
            For crypto: Every calendar day
            For equity: Trading days only (skip weekends, holidays)
            """

        def check_outliers(
            self,
            table: str,
            columns: list[str],
            ids: list[int],
        ) -> list[OutlierIssue]:
            """
            Detect extreme outliers.

            Thresholds (per CONTEXT.md - Claude's discretion):
            - Returns: |ret| > 50% in single day
            - Volatility: vol > 500% annualized
            - RSI: Outside 0-100 (should never happen)
            - MACD: |macd| > 10 * std

            Flag but don't fail - transparency for analysis.
            """

        def check_cross_table_consistency(
            self,
            ids: list[int],
        ) -> list[ConsistencyIssue]:
            """
            Verify cross-table relationships.

            Checks:
            - cmc_returns_daily.ret_1d_pct ~= (close - prev_close) / prev_close
            - cmc_vol_daily.close == cmc_price_bars_1d.close
            - cmc_ta_daily.close == cmc_price_bars_1d.close
            - cmc_daily_features has matching timestamps
            """

        def check_null_ratios(
            self,
            table: str,
            columns: list[str],
            threshold: float = 0.1,
        ) -> list[NullIssue]:
            """
            Check for excessive NULLs.

            > threshold (default 10%) triggers warning.
            """

        def check_rowcounts(
            self,
            table: str,
            ids: list[int],
        ) -> list[RowcountIssue]:
            """
            Validate actual vs expected row counts.

            Expected = date_range * len(ids)
            Tolerance: +/- 5% (accounts for delisted assets, etc.)
            """

    @dataclass
    class ValidationReport:
        passed: bool
        total_checks: int
        failed_checks: int
        issues: list[ValidationIssue]
        summary: str

        def send_alert(self, telegram_config: dict) -> None:
            """Send alert via Telegram if issues found."""
    ```

    **validate_features function:**
    ```python
    def validate_features(
        engine: Engine,
        ids: Optional[list[int]] = None,
        start: Optional[str] = None,
        end: Optional[str] = None,
        alert: bool = True,
    ) -> ValidationReport:
        """
        Convenience function to run all validations.

        If alert=True and issues found, sends Telegram notification.
        Graceful degradation if Telegram not configured.
        """
    ```
  </action>
  <verify>
    python -c "from ta_lab2.scripts.features.validate_features import FeatureValidator, validate_features; print('imports OK')"
  </verify>
  <done>
    FeatureValidator imports with all validation methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create orchestrated refresh pipeline</name>
  <files>
    src/ta_lab2/scripts/features/run_all_feature_refreshes.py
  </files>
  <action>
    Create single script to refresh all feature tables in correct order.

    **Pipeline orchestration:**
    ```python
    """
    Orchestrated refresh for all feature tables.

    Usage:
        python -m ta_lab2.scripts.features.run_all_feature_refreshes --ids 1,52
        python -m ta_lab2.scripts.features.run_all_feature_refreshes --all
        python -m ta_lab2.scripts.features.run_all_feature_refreshes --validate

    Refresh order (respects dependencies):
    1. cmc_returns_daily (depends on cmc_price_bars_1d)
    2. cmc_vol_daily (depends on cmc_price_bars_1d)
    3. cmc_ta_daily (depends on cmc_price_bars_1d)
    4. cmc_daily_features (depends on 1-3 + EMAs)

    Parallel execution where possible:
    - returns, vol, ta can run in parallel (same dependency)
    - daily_features runs after all complete
    """

    def run_all_refreshes(
        engine: Engine,
        ids: list[int],
        full_refresh: bool = False,
        validate: bool = True,
        parallel: bool = True,
    ) -> dict[str, RefreshResult]:
        """
        Refresh all feature tables.

        Returns dict mapping table_name -> RefreshResult
        """

    def main():
        parser = argparse.ArgumentParser()
        parser.add_argument("--ids", help="Comma-separated IDs")
        parser.add_argument("--all", action="store_true")
        parser.add_argument("--full-refresh", action="store_true")
        parser.add_argument("--validate", action="store_true", default=True)
        parser.add_argument("--no-validate", action="store_false", dest="validate")
        parser.add_argument("--parallel", action="store_true", default=True)
        parser.add_argument("--sequential", action="store_false", dest="parallel")
        args = parser.parse_args()

        # Run refreshes in dependency order
        # Optionally run validation after
        # Print summary

    @dataclass
    class RefreshResult:
        table: str
        rows_inserted: int
        duration_seconds: float
        success: bool
        error: Optional[str]
    ```

    **Follow run_all_ema_refreshes.py pattern** for CLI structure and logging.
  </action>
  <verify>
    python -m ta_lab2.scripts.features.run_all_feature_refreshes --help
  </verify>
  <done>
    CLI shows help with --validate, --parallel options
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive tests</name>
  <files>
    tests/features/test_validate_features.py
    tests/features/test_feature_pipeline_integration.py
  </files>
  <action>
    **test_validate_features.py tests:**
    1. test_check_gaps_detects_missing - Finds gap in date sequence
    2. test_check_gaps_respects_session - Skips weekends for equity
    3. test_check_gaps_no_false_positives - No issues when complete
    4. test_check_outliers_returns - Flags >50% daily return
    5. test_check_outliers_vol - Flags >500% vol
    6. test_check_outliers_rsi - Flags outside 0-100
    7. test_check_cross_table_returns - Validates ret vs price delta
    8. test_check_cross_table_close - Validates close consistency
    9. test_check_null_ratios_warn - Warns when >10% NULL
    10. test_check_null_ratios_ok - No warn when <10% NULL
    11. test_check_rowcounts_within_tolerance - Pass within 5%
    12. test_check_rowcounts_fail - Fail outside tolerance
    13. test_validation_report_summary - Report has correct counts
    14. test_send_alert_telegram - Calls telegram.send_validation_alert
    15. test_send_alert_graceful - No error if telegram not configured

    **test_feature_pipeline_integration.py tests:**
    1. test_refresh_order_returns_first - Returns before daily_features
    2. test_refresh_order_vol_parallel - Vol can run with returns
    3. test_refresh_order_daily_features_last - After all others
    4. test_parallel_execution - Concurrent where allowed
    5. test_sequential_fallback - Works without parallelism
    6. test_validate_after_refresh - Validation runs when --validate
    7. test_no_validate_flag - Validation skipped when --no-validate
    8. test_full_pipeline_end_to_end - Complete flow works
    9. test_partial_failure_continues - One failure doesn't stop all
    10. test_refresh_result_summary - Correct counts reported

    Mark integration tests with pytest.mark.skipif(not TARGET_DB_URL).
  </action>
  <verify>
    pytest tests/features/test_validate_features.py tests/features/test_feature_pipeline_integration.py -v
  </verify>
  <done>
    All tests pass (25+ tests total)
  </done>
</task>

</tasks>

<verification>
- [ ] Gap detection uses dim_timeframe + dim_sessions for expected schedule
- [ ] Outlier thresholds reasonable (returns >50%, vol >500%)
- [ ] Cross-table consistency verifies returns match price delta
- [ ] NULL ratio threshold configurable (default 10%)
- [ ] Telegram alerts sent when issues found
- [ ] Orchestrated refresh runs in correct dependency order
- [ ] Parallel execution for independent tables
- [ ] All 25 tests pass
</verification>

<success_criteria>
- FeatureValidator detects: gaps, outliers, cross-table inconsistencies, excessive NULLs
- Validation integrated with Telegram alerts (graceful degradation)
- run_all_feature_refreshes provides single-command pipeline refresh
- Dependency order respected: returns/vol/ta parallel, daily_features last
- --validate flag runs consistency checks after refresh
- Comprehensive test coverage (15 validation + 10 integration tests)
</success_criteria>

<output>
After completion, create `.planning/phases/07-ta_lab2-feature-pipeline/07-07-SUMMARY.md`
</output>
