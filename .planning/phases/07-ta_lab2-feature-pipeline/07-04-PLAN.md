---
phase: 07-ta_lab2-feature-pipeline
plan: 04
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - src/ta_lab2/scripts/features/vol_feature.py
  - src/ta_lab2/scripts/features/refresh_cmc_vol_daily.py
  - sql/features/041_cmc_vol_daily.sql
  - tests/features/test_vol_feature.py
autonomous: true

must_haves:
  truths:
    - "cmc_vol_daily computes Parkinson and GK volatility measures from OHLC"
    - "Volatility uses 'forward_fill' null strategy - missing values carried forward"
    - "Multiple volatility windows calculated (20, 63, 126 days)"
  artifacts:
    - path: "src/ta_lab2/scripts/features/vol_feature.py"
      provides: "Volatility feature implementation"
      exports: ["VolatilityFeature", "VolatilityConfig"]
    - path: "src/ta_lab2/scripts/features/refresh_cmc_vol_daily.py"
      provides: "CLI refresh script"
      contains: "if __name__"
    - path: "sql/features/041_cmc_vol_daily.sql"
      provides: "Volatility table DDL"
      contains: "CREATE TABLE"
    - path: "tests/features/test_vol_feature.py"
      provides: "Unit tests for volatility"
      min_lines: 150
  key_links:
    - from: "vol_feature.py"
      to: "BaseFeature"
      via: "class VolatilityFeature(BaseFeature)"
      pattern: "class VolatilityFeature\\(BaseFeature\\)"
    - from: "vol_feature.py"
      to: "features/vol.py"
      via: "add_parkinson_vol, add_garman_klass_vol, add_rogers_satchell_vol"
      pattern: "from ta_lab2\\.features\\.vol import"
---

<objective>
Implement cmc_vol_daily feature table with Parkinson, Garman-Klass, and Rogers-Satchell volatility estimators.

Purpose: Calculate realized volatility measures from OHLC data across multiple windows (20, 63, 126 days).
Output: Volatility feature module, refresh script, DDL, and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-CONTEXT.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-01-SUMMARY.md
@.planning/phases/07-ta_lab2-feature-pipeline/07-02-SUMMARY.md

# Key existing code:
@src/ta_lab2/features/vol.py
@src/ta_lab2/scripts/features/base_feature.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cmc_vol_daily DDL</name>
  <files>
    sql/features/041_cmc_vol_daily.sql
  </files>
  <action>
    Create table DDL for daily volatility measures.

    **Schema design:**
    ```sql
    CREATE TABLE IF NOT EXISTS public.cmc_vol_daily (
        id              INTEGER NOT NULL,
        ts              TIMESTAMPTZ NOT NULL,

        -- OHLC context (for reference)
        open            DOUBLE PRECISION,
        high            DOUBLE PRECISION,
        low             DOUBLE PRECISION,
        close           DOUBLE PRECISION,

        -- Parkinson (1980) range-based volatility
        vol_parkinson_20    DOUBLE PRECISION,  -- 20-day
        vol_parkinson_63    DOUBLE PRECISION,  -- ~3 months
        vol_parkinson_126   DOUBLE PRECISION,  -- ~6 months

        -- Garman-Klass (1980) OHLC volatility
        vol_gk_20           DOUBLE PRECISION,
        vol_gk_63           DOUBLE PRECISION,
        vol_gk_126          DOUBLE PRECISION,

        -- Rogers-Satchell (1991) drift-independent volatility
        vol_rs_20           DOUBLE PRECISION,
        vol_rs_63           DOUBLE PRECISION,
        vol_rs_126          DOUBLE PRECISION,

        -- ATR (Wilder) for reference
        atr_14              DOUBLE PRECISION,

        -- Rolling historical volatility from returns
        vol_log_roll_20     DOUBLE PRECISION,
        vol_log_roll_63     DOUBLE PRECISION,
        vol_log_roll_126    DOUBLE PRECISION,

        -- Normalized versions (z-scores)
        vol_parkinson_20_zscore  DOUBLE PRECISION,
        vol_gk_20_zscore         DOUBLE PRECISION,

        -- Data quality flags
        is_outlier          BOOLEAN DEFAULT FALSE,

        -- Metadata
        updated_at          TIMESTAMPTZ DEFAULT now(),

        PRIMARY KEY (id, ts)
    );

    -- Index for lookups
    CREATE INDEX IF NOT EXISTS idx_cmc_vol_daily_id_ts
    ON public.cmc_vol_daily (id, ts DESC);

    COMMENT ON TABLE public.cmc_vol_daily IS
    'Daily volatility measures calculated from cmc_price_bars_1d OHLC. Annualized (252 trading days).';
    ```
  </action>
  <verify>
    File exists and contains CREATE TABLE with Parkinson, GK, RS columns
  </verify>
  <done>
    DDL file exists with correct schema for all volatility estimators
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VolatilityFeature class</name>
  <files>
    src/ta_lab2/scripts/features/vol_feature.py
  </files>
  <action>
    Create VolatilityFeature extending BaseFeature.

    **VolatilityConfig:**
    ```python
    @dataclass(frozen=True)
    class VolatilityConfig(FeatureConfig):
        feature_type: str = "vol"
        output_table: str = "cmc_vol_daily"
        null_strategy: str = "forward_fill"  # Per CONTEXT.md - vol forward fills
        add_zscore: bool = True

        # Volatility windows
        vol_windows: tuple[int, ...] = (20, 63, 126)

        # Estimators to compute
        estimators: tuple[str, ...] = ("parkinson", "gk", "rs")

        # Annualization factor
        periods_per_year: int = 252

        # ATR period
        atr_period: int = 14
    ```

    **VolatilityFeature implementation:**
    ```python
    class VolatilityFeature(BaseFeature):
        """
        Compute daily volatility measures from OHLC.

        Uses existing vol.py functions for all estimators:
        - add_parkinson_vol(): Range-based (high/low)
        - add_garman_klass_vol(): OHLC-based
        - add_rogers_satchell_vol(): Drift-independent
        - add_atr(): Average True Range
        - add_rolling_vol_from_returns_batch(): Historical from log returns

        All volatility measures are annualized by default (sqrt(252)).
        """

        def load_source_data(self, ids, start, end) -> pd.DataFrame:
            """Load from cmc_price_bars_1d (daily bars with OHLC)."""
            # Query for id, time_close as ts, open, high, low, close
            # Order by id, ts ASC

        def compute_features(self, df_source: pd.DataFrame) -> pd.DataFrame:
            """
            Compute all volatility measures.

            For each (id):
            1. Apply null handling (forward_fill per config)
            2. Compute Parkinson for each window
            3. Compute Garman-Klass for each window
            4. Compute Rogers-Satchell for each window
            5. Compute ATR
            6. Compute rolling historical vol from returns

            Uses vectorized vol.py functions (mutate df in place).
            """

        def get_output_schema(self) -> dict[str, str]:
            # Return column -> SQL type mapping

        def get_feature_columns(self) -> list[str]:
            # Return list of computed volatility columns
    ```

    **Important details:**
    - Reuse ALL functions from vol.py - don't duplicate calculation logic
    - Handle OHLC data correctly (order: open < low <= high, close any)
    - Forward-fill missing OHLC before computation
    - Flag outliers (vol > 4 sigma from rolling mean)
  </action>
  <verify>
    python -c "from ta_lab2.scripts.features.vol_feature import VolatilityFeature, VolatilityConfig; print('imports OK')"
  </verify>
  <done>
    VolatilityFeature imports successfully with all methods implemented
  </done>
</task>

<task type="auto">
  <name>Task 3: Create refresh script and tests</name>
  <files>
    src/ta_lab2/scripts/features/refresh_cmc_vol_daily.py
    tests/features/test_vol_feature.py
  </files>
  <action>
    **refresh_cmc_vol_daily.py CLI:**
    Same pattern as refresh_cmc_returns_daily.py.

    ```python
    """
    Incremental daily volatility refresh from cmc_price_bars_1d.

    Usage:
        python -m ta_lab2.scripts.features.refresh_cmc_vol_daily --ids 1,52
        python -m ta_lab2.scripts.features.refresh_cmc_vol_daily --all
        python -m ta_lab2.scripts.features.refresh_cmc_vol_daily --full-refresh

    State tracked in public.cmc_feature_state (feature_type='vol').
    """
    ```

    **test_vol_feature.py tests:**
    1. test_vol_config_defaults - Correct default values
    2. test_vol_config_custom_windows - Custom windows work
    3. test_load_source_data_ohlc - Query includes all OHLC columns
    4. test_compute_parkinson_basic - Parkinson formula correct
    5. test_compute_garman_klass_basic - GK formula correct
    6. test_compute_rogers_satchell_basic - RS formula correct
    7. test_compute_features_all_estimators - All computed together
    8. test_null_handling_forward_fill - Missing OHLC filled
    9. test_annualization - Correct sqrt(252) scaling
    10. test_outlier_flagging - Extreme vol flagged
    11. test_compute_for_ids_full_flow - Template method works
    12. test_empty_ohlc_handling - Graceful on all NULLs

    Use synthetic OHLC data with known volatility for verification.
    Test that Parkinson and GK match pandas_ta or manual calculation.
  </action>
  <verify>
    pytest tests/features/test_vol_feature.py -v
    python -m ta_lab2.scripts.features.refresh_cmc_vol_daily --help
  </verify>
  <done>
    All tests pass, CLI shows help with all options
  </done>
</task>

</tasks>

<verification>
- [ ] DDL creates table with Parkinson, GK, RS columns for all windows
- [ ] VolatilityFeature extends BaseFeature correctly
- [ ] All estimators use existing vol.py functions (no duplication)
- [ ] Forward-fill applied to OHLC before computation
- [ ] Volatility annualized with sqrt(252)
- [ ] ATR computed with period=14
- [ ] Refresh script supports --ids, --all, --full-refresh
- [ ] All 12 tests pass
</verification>

<success_criteria>
- cmc_vol_daily table created with correct schema
- All estimators computed: Parkinson, Garman-Klass, Rogers-Satchell, ATR, rolling historical
- Windows: 20, 63, 126 days (matching industry standard)
- Annualization correct (252 trading days)
- Z-score normalization for key vol measures
- Incremental refresh only computes new rows
</success_criteria>

<output>
After completion, create `.planning/phases/07-ta_lab2-feature-pipeline/07-04-SUMMARY.md`
</output>
