---
phase: 27-regime-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sql/regimes/080_cmc_regimes.sql
  - sql/regimes/081_cmc_regime_flips.sql
  - sql/regimes/082_cmc_regime_stats.sql
  - sql/regimes/083_alter_signal_tables.sql
  - sql/regimes/084_cmc_regime_comovement.sql
  - sql/dim/010_dim_signals_regime_col.sql
autonomous: true

must_haves:
  truths:
    - "cmc_regimes table exists with PK (id, ts, tf) and columns for L0-L4 labels, regime_key, policy fields, and version_hash"
    - "cmc_regime_flips table exists with PK (id, ts, tf, layer) tracking regime transitions"
    - "cmc_regime_stats table exists with PK (id, tf, regime_key) for pre-computed regime summaries"
    - "cmc_regime_comovement table exists with PK (id, tf, ema_a, ema_b, computed_at) for EMA comovement stats"
    - "All 3 signal tables have regime_key TEXT column"
    - "dim_signals has regime_enabled BOOLEAN column"
  artifacts:
    - path: "sql/regimes/080_cmc_regimes.sql"
      provides: "Main regime table DDL"
      contains: "CREATE TABLE"
    - path: "sql/regimes/081_cmc_regime_flips.sql"
      provides: "Regime flips table DDL"
      contains: "CREATE TABLE"
    - path: "sql/regimes/082_cmc_regime_stats.sql"
      provides: "Regime stats table DDL"
      contains: "CREATE TABLE"
    - path: "sql/regimes/083_alter_signal_tables.sql"
      provides: "ALTER TABLE for signal tables + dim_signals"
      contains: "ALTER TABLE"
    - path: "sql/regimes/084_cmc_regime_comovement.sql"
      provides: "Comovement stats table DDL"
      contains: "CREATE TABLE"
  key_links:
    - from: "sql/regimes/080_cmc_regimes.sql"
      to: "cmc_regimes PK"
      via: "PRIMARY KEY (id, ts, tf)"
      pattern: "PRIMARY KEY.*id.*ts.*tf"
---

<objective>
Create all SQL DDL for the regime integration tables and extend existing signal/dim tables.

Purpose: Establish the database schema foundation that all subsequent regime plans depend on. Without these tables, nothing can be written. Includes comovement stats table for EMA alignment/sign agreement analytics mandated by CONTEXT.md.
Output: 6 SQL files in sql/regimes/ and sql/dim/ directories, tables created in PostgreSQL.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-regime-integration/27-RESEARCH.md
@sql/signals/060_cmc_signals_ema_crossover.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create regime table DDL files</name>
  <files>
    sql/regimes/080_cmc_regimes.sql
    sql/regimes/081_cmc_regime_flips.sql
    sql/regimes/082_cmc_regime_stats.sql
    sql/regimes/084_cmc_regime_comovement.sql
  </files>
  <action>
Create `sql/regimes/` directory and write 4 DDL files:

**080_cmc_regimes.sql** - Main regime table:
```sql
CREATE TABLE IF NOT EXISTS public.cmc_regimes (
    id                  INTEGER         NOT NULL,
    ts                  TIMESTAMPTZ     NOT NULL,
    tf                  TEXT            NOT NULL DEFAULT '1D',
    -- Layer labels
    l0_label            TEXT            NULL,   -- Monthly: "Up-Low-Normal"
    l1_label            TEXT            NULL,   -- Weekly: "Sideways-High-Normal"
    l2_label            TEXT            NULL,   -- Daily: "Down-Normal-Normal"
    l3_label            TEXT            NULL,   -- Intraday (auto-disabled)
    l4_label            TEXT            NULL,   -- Execution (auto-disabled)
    -- Resolved policy
    regime_key          TEXT            NOT NULL,
    size_mult           DOUBLE PRECISION NOT NULL DEFAULT 1.0,
    stop_mult           DOUBLE PRECISION NOT NULL DEFAULT 1.5,
    orders              TEXT            NOT NULL DEFAULT 'mixed',
    gross_cap           DOUBLE PRECISION NOT NULL DEFAULT 1.0,
    pyramids            BOOLEAN         NOT NULL DEFAULT TRUE,
    -- Data budget info
    feature_tier        TEXT            NOT NULL DEFAULT 'lite',
    l0_enabled          BOOLEAN         NOT NULL DEFAULT FALSE,
    l1_enabled          BOOLEAN         NOT NULL DEFAULT FALSE,
    l2_enabled          BOOLEAN         NOT NULL DEFAULT FALSE,
    -- Reproducibility
    regime_version_hash TEXT            NULL,
    -- Metadata
    updated_at          TIMESTAMPTZ     DEFAULT now(),
    PRIMARY KEY (id, ts, tf)
);
```
Add indexes: (id, tf, regime_key) for lookups, (regime_key) for stats queries, (id, tf, ts DESC) for latest-regime queries.
Add COMMENT ON TABLE and key columns.

**081_cmc_regime_flips.sql** - Regime transition tracking:
```sql
CREATE TABLE IF NOT EXISTS public.cmc_regime_flips (
    id                  INTEGER         NOT NULL,
    ts                  TIMESTAMPTZ     NOT NULL,
    tf                  TEXT            NOT NULL DEFAULT '1D',
    layer               TEXT            NOT NULL,  -- 'L0', 'L1', 'L2', 'composite'
    old_regime          TEXT            NULL,
    new_regime          TEXT            NOT NULL,
    duration_bars       INTEGER         NULL,
    updated_at          TIMESTAMPTZ     DEFAULT now(),
    PRIMARY KEY (id, ts, tf, layer)
);
```
Add index on (id, tf, layer) for per-asset flip queries.

**082_cmc_regime_stats.sql** - Pre-computed regime statistics:
```sql
CREATE TABLE IF NOT EXISTS public.cmc_regime_stats (
    id                  INTEGER         NOT NULL,
    tf                  TEXT            NOT NULL DEFAULT '1D',
    regime_key          TEXT            NOT NULL,
    n_bars              INTEGER         NOT NULL DEFAULT 0,
    pct_of_history      DOUBLE PRECISION NULL,
    avg_ret_1d          DOUBLE PRECISION NULL,
    std_ret_1d          DOUBLE PRECISION NULL,
    computed_at         TIMESTAMPTZ     DEFAULT now(),
    PRIMARY KEY (id, tf, regime_key)
);
```

**084_cmc_regime_comovement.sql** - EMA comovement stats (CONTEXT.md mandate: "Include comovement stats (EMA alignment, sign agreement, lead-lag) in the refresh pipeline"):
```sql
CREATE TABLE IF NOT EXISTS public.cmc_regime_comovement (
    id                  INTEGER         NOT NULL,
    tf                  TEXT            NOT NULL DEFAULT '1D',
    ema_a               TEXT            NOT NULL,  -- e.g. 'close_ema_20'
    ema_b               TEXT            NOT NULL,  -- e.g. 'close_ema_50'
    correlation         DOUBLE PRECISION NULL,     -- spearman corr between EMA levels
    sign_agree_rate     DOUBLE PRECISION NULL,     -- fraction of days where sign(dEMA_a) == sign(dEMA_b)
    best_lead_lag       INTEGER         NULL,      -- lag maximizing cross-corr (positive = b leads a)
    best_lead_lag_corr  DOUBLE PRECISION NULL,     -- correlation at best lag
    n_obs               INTEGER         NULL,      -- number of observations used
    computed_at         TIMESTAMPTZ     NOT NULL DEFAULT now(),
    PRIMARY KEY (id, tf, ema_a, ema_b, computed_at)
);

COMMENT ON TABLE public.cmc_regime_comovement IS 'Pairwise EMA comovement stats: correlation, sign agreement, and lead-lag per asset/TF. Refreshed alongside regimes.';
```
Add index on (id, tf) for per-asset queries.

All tables should use CREATE TABLE IF NOT EXISTS for idempotency. Match existing SQL style conventions from sql/signals/ directory (comments, index naming).
  </action>
  <verify>
Run each SQL file against the database:
```bash
python -c "
from sqlalchemy import create_engine, text
import os
engine = create_engine(os.environ['TARGET_DB_URL'])
with engine.begin() as conn:
    for f in ['sql/regimes/080_cmc_regimes.sql', 'sql/regimes/081_cmc_regime_flips.sql', 'sql/regimes/082_cmc_regime_stats.sql', 'sql/regimes/084_cmc_regime_comovement.sql']:
        conn.execute(text(open(f).read()))
        print(f'OK: {f}')
    # Verify tables exist
    for t in ['cmc_regimes', 'cmc_regime_flips', 'cmc_regime_stats', 'cmc_regime_comovement']:
        r = conn.execute(text(f\"SELECT COUNT(*) FROM information_schema.tables WHERE table_name = '{t}'\"))
        assert r.scalar() == 1, f'Table {t} not found'
        print(f'Verified: {t}')
"
```
  </verify>
  <done>Four regime tables exist in PostgreSQL with correct PKs and columns, including cmc_regime_comovement for EMA alignment/sign agreement analytics.</done>
</task>

<task type="auto">
  <name>Task 2: Extend signal and dimension tables</name>
  <files>
    sql/regimes/083_alter_signal_tables.sql
    sql/dim/010_dim_signals_regime_col.sql
  </files>
  <action>
**083_alter_signal_tables.sql** - Add regime_key column to all 3 signal tables:
```sql
ALTER TABLE public.cmc_signals_ema_crossover ADD COLUMN IF NOT EXISTS regime_key TEXT;
ALTER TABLE public.cmc_signals_rsi_mean_revert ADD COLUMN IF NOT EXISTS regime_key TEXT;
ALTER TABLE public.cmc_signals_atr_breakout ADD COLUMN IF NOT EXISTS regime_key TEXT;

COMMENT ON COLUMN public.cmc_signals_ema_crossover.regime_key IS 'Active regime at signal entry time. NULL if regime not computed.';
COMMENT ON COLUMN public.cmc_signals_rsi_mean_revert.regime_key IS 'Active regime at signal entry time. NULL if regime not computed.';
COMMENT ON COLUMN public.cmc_signals_atr_breakout.regime_key IS 'Active regime at signal entry time. NULL if regime not computed.';
```

**010_dim_signals_regime_col.sql** - Add regime_enabled flag to dim_signals:
```sql
ALTER TABLE public.dim_signals ADD COLUMN IF NOT EXISTS regime_enabled BOOLEAN DEFAULT TRUE;
COMMENT ON COLUMN public.dim_signals.regime_enabled IS 'If FALSE, regime filtering/sizing is skipped for this signal.';
```

Execute both files against the database after writing.
  </action>
  <verify>
```bash
python -c "
from sqlalchemy import create_engine, text
import os
engine = create_engine(os.environ['TARGET_DB_URL'])
with engine.begin() as conn:
    conn.execute(text(open('sql/regimes/083_alter_signal_tables.sql').read()))
    conn.execute(text(open('sql/dim/010_dim_signals_regime_col.sql').read()))
    # Verify columns exist
    for t in ['cmc_signals_ema_crossover', 'cmc_signals_rsi_mean_revert', 'cmc_signals_atr_breakout']:
        r = conn.execute(text(f\"SELECT column_name FROM information_schema.columns WHERE table_name = '{t}' AND column_name = 'regime_key'\"))
        assert r.fetchone() is not None, f'regime_key column missing from {t}'
        print(f'OK: {t}.regime_key')
    r = conn.execute(text(\"SELECT column_name FROM information_schema.columns WHERE table_name = 'dim_signals' AND column_name = 'regime_enabled'\"))
    assert r.fetchone() is not None, 'regime_enabled missing from dim_signals'
    print('OK: dim_signals.regime_enabled')
"
```
  </verify>
  <done>All 3 signal tables have regime_key column. dim_signals has regime_enabled column.</done>
</task>

</tasks>

<verification>
- All 6 SQL files exist and are syntactically valid
- All 4 new tables created with correct PKs (cmc_regimes, cmc_regime_flips, cmc_regime_stats, cmc_regime_comovement)
- Signal tables extended with regime_key
- dim_signals extended with regime_enabled
- All SQL is idempotent (IF NOT EXISTS)
</verification>

<success_criteria>
- 4 regime tables exist in PostgreSQL: cmc_regimes, cmc_regime_flips, cmc_regime_stats, cmc_regime_comovement
- 3 signal tables have regime_key TEXT column
- dim_signals has regime_enabled BOOLEAN column
- SQL files follow project conventions (numbered, commented)
</success_criteria>

<output>
After completion, create `.planning/phases/27-regime-integration/27-01-SUMMARY.md`
</output>
