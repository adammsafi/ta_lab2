---
phase: 27-regime-integration
plan: 07
type: execute
wave: 4
depends_on: ["27-05", "27-06"]
files_modified:
  - src/ta_lab2/scripts/run_daily_refresh.py
  - src/ta_lab2/scripts/regimes/regime_inspect.py
autonomous: false

must_haves:
  truths:
    - "run_daily_refresh.py supports --regimes and --all includes regimes in the pipeline"
    - "Execution order is bars -> EMAs -> features -> regimes -> signals"
    - "regime_inspect.py reads from DB by default, supports --live flag for on-the-fly computation"
    - "End-to-end pipeline produces regime labels that affect signal generation for at least one asset"
  artifacts:
    - path: "src/ta_lab2/scripts/run_daily_refresh.py"
      provides: "Updated daily refresh orchestrator with regime step"
      contains: "regimes"
    - path: "src/ta_lab2/scripts/regimes/regime_inspect.py"
      provides: "Regime inspection CLI tool"
      exports: ["main"]
  key_links:
    - from: "src/ta_lab2/scripts/run_daily_refresh.py"
      to: "src/ta_lab2/scripts/regimes/refresh_cmc_regimes.py"
      via: "subprocess.run"
      pattern: "refresh_cmc_regimes"
    - from: "src/ta_lab2/scripts/regimes/regime_inspect.py"
      to: "cmc_regimes table"
      via: "SQL query"
      pattern: "SELECT.*FROM.*cmc_regimes"
---

<objective>
Wire regimes into the daily refresh orchestrator and create the regime inspection tool for ad-hoc analysis.

Purpose: The regime refresh must run automatically as part of the daily pipeline (after features, before signals). The inspect tool allows the user to check current regime state for any asset.
Output: Updated run_daily_refresh.py with --regimes step, regime_inspect.py CLI tool.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-regime-integration/27-RESEARCH.md
@src/ta_lab2/scripts/run_daily_refresh.py

# Prior plan summaries
@.planning/phases/27-regime-integration/27-05-SUMMARY.md
@.planning/phases/27-regime-integration/27-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --regimes step to run_daily_refresh.py</name>
  <files>
    src/ta_lab2/scripts/run_daily_refresh.py
  </files>
  <action>
Extend run_daily_refresh.py to include a regime refresh step:

1. Add CLI flags:
   - `--regimes`: Run regime refresh only
   - Update `--all` to include regimes: now runs bars -> EMAs -> regimes (features not in orchestrator yet, per research)
   - `--no-regime-hysteresis`: Pass --no-hysteresis to regime refresher subprocess

2. Add `run_regime_refresher(args, db_url, parsed_ids)` function following the same pattern as `run_ema_refreshers()`:
   ```python
   def run_regime_refresher(args, db_url, ids) -> ComponentResult:
       script = Path(__file__).parent / "regimes" / "refresh_cmc_regimes.py"
       cmd = [sys.executable, str(script)]

       # Format IDs
       if ids is None:
           cmd.extend(["--all"])
       else:
           cmd.extend(["--ids", ",".join(str(i) for i in ids)])

       cmd.extend(["--db-url", db_url])

       if args.verbose:
           cmd.append("--verbose")
       if getattr(args, 'no_regime_hysteresis', False):
           cmd.append("--no-hysteresis")

       # CRITICAL: Propagate --dry-run to subprocess
       if getattr(args, 'dry_run', False):
           cmd.append("--dry-run")

       # ... subprocess.run pattern matching existing bar/ema functions ...
   ```

3. In main(), update execution order:
   ```python
   run_bars = args.bars or args.all
   run_emas = args.emas or args.all
   run_regimes = args.regimes or args.all

   # Order: bars -> EMAs -> regimes
   if run_bars: ...
   if run_emas: ...
   if run_regimes:
       regime_result = run_regime_refresher(args, db_url, parsed_ids)
       results.append(("regimes", regime_result))
   ```

4. Update help text and docstring to document the new --regimes flag and updated --all behavior.

5. Update combined summary to include regimes component.

IMPORTANT: The feature refresh (run_all_feature_refreshes.py) is NOT in run_daily_refresh.py currently. The actual execution order for the full pipeline is:
- run_daily_refresh.py --all (bars -> EMAs -> regimes)
- run_all_feature_refreshes.py (separate command)
- run_all_signal_refreshes.py (separate command)

Do NOT add features or signals to run_daily_refresh.py -- that's outside scope.
  </action>
  <verify>
```bash
python -m ta_lab2.scripts.run_daily_refresh --help
```
Should show --regimes flag.

```bash
python -m ta_lab2.scripts.run_daily_refresh --regimes --ids 1 --dry-run --verbose
```
Should show regime refresh would be executed, and --dry-run MUST be passed to the subprocess (verify in output logs that refresh_cmc_regimes.py receives --dry-run and does not write to DB).
  </verify>
  <done>run_daily_refresh.py supports --regimes flag, --all includes regimes after EMAs, and --dry-run is propagated to regime subprocess.</done>
</task>

<task type="auto">
  <name>Task 2: Create regime_inspect.py DB-backed inspection tool</name>
  <files>
    src/ta_lab2/scripts/regimes/regime_inspect.py
  </files>
  <action>
Create `src/ta_lab2/scripts/regimes/regime_inspect.py` that replaces the existing CSV-based `src/ta_lab2/regimes/regime_inspect.py` with a DB-backed version.

**Default mode (DB read):**
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1
```
- Query cmc_regimes for the latest regime row for this asset:
  ```sql
  SELECT * FROM public.cmc_regimes WHERE id = :id AND tf = '1D' ORDER BY ts DESC LIMIT 1
  ```
- Print formatted output:
  ```
  Asset: BTC (id=1)
  As of: 2026-02-19
  Feature tier: full | Bars: M=120 W=520 D=3650

  L0 (Monthly):  Up-Low-Normal     [enabled]
  L1 (Weekly):   Up-Normal-Normal   [enabled]
  L2 (Daily):    Sideways-High-Normal [enabled]
  L3 (Intra):    -                  [disabled]

  Resolved Policy:
    regime_key = Sideways-High-Normal
    size_mult  = 0.40
    stop_mult  = 2.00
    orders     = passive
    pyramids   = True
    gross_cap  = 1.00

  Version hash: a1b2c3d4e5f6g7h8
  Last updated: 2026-02-19 12:00:00 UTC
  ```

**--live flag (on-the-fly computation):**
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1 --live
```
- Call `load_regime_input_data()` and `compute_regimes_for_id()` directly
- Print same formatted output but labeled "LIVE (not stored)"
- Useful for testing changes before writing to DB

**--history N flag:**
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1 --history 30
```
- Show last N days of regime history from cmc_regimes
- Print as a table (date, regime_key, size_mult, stop_mult)

**--flips flag:**
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1 --flips
```
- Query cmc_regime_flips for this asset
- Print recent transitions (last 20)

CLI flags: --id (required), --tf (default '1D'), --live, --history N, --flips, --db-url, --verbose
  </action>
  <verify>
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --help
```
Should show all flags.

```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1
```
Should print regime info for BTC (assuming regimes have been computed).

```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1 --live
```
Should compute on-the-fly and print results.
  </verify>
  <done>regime_inspect.py provides DB-backed regime inspection with --live, --history, and --flips modes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete regime integration pipeline:
1. DDL for 4 regime tables + signal table extensions (Plan 01)
2. EMA pivot and data loading utilities (Plan 02)
3. Core refresh_cmc_regimes.py with labeling, policy resolution, and proxy fallback (Plan 03)
4. Hysteresis tracker, flip detection, stats, and comovement computation (Plan 04)
5. Full refresh pipeline with all 4 tables (Plan 05)
6. Signal generator regime awareness with --no-regime flag + RSI feature_snapshot fix (Plan 06)
7. Orchestrator integration and inspection tool (this plan)

NOTE: Plan 06 fixes the RSI feature_snapshot dict serialization bug (json.dumps). If any RSI-related step fails below, check that the fix was applied correctly in generate_signals_rsi.py (~line 449).
  </what-built>
  <how-to-verify>
**End-to-end pipeline test:**

1. Run regime refresh for a few assets:
```bash
python -m ta_lab2.scripts.regimes.refresh_cmc_regimes --ids 1,52,1027 -v
```
Verify: Should complete without errors, showing regime labels per asset.

2. Check regime data in DB:
```bash
python -c "
from sqlalchemy import create_engine, text
import os
engine = create_engine(os.environ['TARGET_DB_URL'])
with engine.connect() as conn:
    for t in ['cmc_regimes', 'cmc_regime_flips', 'cmc_regime_stats', 'cmc_regime_comovement']:
        r = conn.execute(text(f'SELECT COUNT(*) FROM {t}'))
        print(f'{t}: {r.scalar()} rows')
    # Show sample regime
    r = conn.execute(text('SELECT id, ts, regime_key, size_mult, stop_mult, orders FROM cmc_regimes WHERE id = 1 ORDER BY ts DESC LIMIT 5'))
    for row in r:
        print(row)
"
```
Verify: Tables should have data, regime_key should not all be the same value.

3. Inspect a specific asset:
```bash
python -m ta_lab2.scripts.regimes.regime_inspect --id 1
```
Verify: Should show formatted regime info with layers and policy.

4. Run EMA signal generation with regime context:
```bash
python -m ta_lab2.scripts.signals.refresh_cmc_signals_ema_crossover --ids 1 --full-refresh --dry-run -v
```
Verify: Should show regime context being loaded and applied.

5. Run signal generation WITHOUT regime (A/B):
```bash
python -m ta_lab2.scripts.signals.refresh_cmc_signals_ema_crossover --ids 1 --full-refresh --dry-run -v --no-regime
```
Verify: Should show "Regime disabled" message.

6. Run RSI signal generation (tests feature_snapshot fix):
```bash
python -m ta_lab2.scripts.signals.refresh_cmc_signals_rsi_mean_revert --ids 1 --full-refresh -v
```
Verify: Should complete without 'can't adapt type dict' error. If this fails, the RSI bug fix in Plan 06 Task 1 did not apply correctly.

7. Check daily refresh orchestrator:
```bash
python -m ta_lab2.scripts.run_daily_refresh --regimes --ids 1 --dry-run -v
```
Verify: Should show regime refresh would be executed, with --dry-run propagated to subprocess.
  </how-to-verify>
  <resume-signal>Type "approved" if the end-to-end pipeline works, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- run_daily_refresh.py --all includes regime step
- regime_inspect.py reads from DB and shows formatted output
- End-to-end: bars -> EMAs -> regimes -> signals all connected
- At least BTC (id=1) has regime data that influences signal generation
- --dry-run propagated from orchestrator to regime subprocess
- RSI signal generator writes to DB without serialization error
</verification>

<success_criteria>
- Full pipeline: refresh_cmc_regimes.py --ids 1 completes and writes to all 4 tables
- regime_inspect.py --id 1 shows meaningful regime labels and policy
- Signal generators load regime context and record regime_key
- run_daily_refresh.py --all includes regimes in the workflow
- Data budget correctly disables layers for young assets with insufficient history
- RSI generator works end-to-end (feature_snapshot serialization fixed)
</success_criteria>

<output>
After completion, create `.planning/phases/27-regime-integration/27-07-SUMMARY.md`
</output>
