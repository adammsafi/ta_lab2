---
phase: 10-release-validation
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - tests/validation/test_time_alignment.py
  - tests/validation/test_data_consistency.py
autonomous: true

must_haves:
  truths:
    - "Time alignment validation confirms all calculations use dim_timeframe"
    - "Data consistency validation detects gaps and rowcount mismatches"
    - "EMA calculations validate against expected precision"
  artifacts:
    - path: "tests/validation/test_time_alignment.py"
      provides: "Time alignment validation tests"
      min_lines: 100
    - path: "tests/validation/test_data_consistency.py"
      provides: "Data consistency validation tests"
      min_lines: 150
  key_links:
    - from: "tests/validation/test_time_alignment.py"
      to: "dim_timeframe"
      via: "SQL query"
      pattern: "dim_timeframe"
    - from: "tests/validation/test_data_consistency.py"
      to: "cmc_ema"
      via: "SQL query"
      pattern: "cmc_ema"
---

<objective>
Create time alignment and data consistency validation tests

Purpose: Implement SIG-04 (time alignment validation) and SIG-05 (data consistency validation) as CI blockers. These tests verify that all calculations use correct timeframes from dim_timeframe and that data has no gaps with correct rowcounts.

Output: Two test modules that validate time alignment and data consistency against real database
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-release-validation/10-CONTEXT.md
@.planning/phases/10-release-validation/10-RESEARCH.md

# Validation fixtures from Plan 01
@tests/validation/conftest.py

# Existing time model infrastructure
@src/ta_lab2/scripts/time/ensure_dim_tables.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create time alignment validation tests</name>
  <files>tests/validation/test_time_alignment.py</files>
  <action>
Create comprehensive time alignment validation tests (SIG-04):

1. Imports: pytest, sqlalchemy, pandas, numpy

2. Class `TestTimeAlignmentValidation`:

   a. `test_dim_timeframe_populated`:
      - Query dim_timeframe, assert has >= 50 rows (we have 199 TFs)
      - Verify required columns: tf, tf_days, is_calendar, is_canonical, etc.
      - Mark as `@pytest.mark.validation_gate`

   b. `test_dim_sessions_populated`:
      - Query dim_sessions, verify CRYPTO and EQUITY sessions exist
      - Verify session_hours, timezone columns populated

   c. `test_all_ema_tables_reference_valid_timeframes`:
      - Query distinct TFs from cmc_ema_multi_tf, cmc_ema_multi_tf_cal, cmc_ema_multi_tf_u
      - Join to dim_timeframe, verify 100% match (no orphan TFs)
      - Assert: `orphan_tfs == []`

   d. `test_calendar_emas_use_calendar_timeframes`:
      - Query cmc_ema_multi_tf_cal for distinct TFs
      - Join to dim_timeframe WHERE is_calendar = TRUE
      - Assert all calendar EMAs use calendar TFs

   e. `test_trading_emas_use_trading_timeframes`:
      - Query cmc_ema_multi_tf for distinct TFs
      - Join to dim_timeframe WHERE is_calendar = FALSE
      - Assert all trading EMAs use trading TFs

   f. `test_tf_days_matches_actual_data_cadence`:
      - For sample assets (id IN (1, 2, 3)), query EMA timestamps
      - Calculate actual day gaps between consecutive rows
      - Compare to tf_days from dim_timeframe
      - Allow 10% tolerance for holidays/missing days

3. All tests use `db_session` fixture from conftest
4. Use @pytest.mark.validation_gate marker on each test
5. Zero tolerance for orphan TFs (strict validation per CONTEXT.md)
  </action>
  <verify>
`pytest tests/validation/test_time_alignment.py --collect-only` shows 6 test methods collected
  </verify>
  <done>Time alignment tests verify all EMA calculations reference valid dim_timeframe entries</done>
</task>

<task type="auto">
  <name>Task 2: Create data consistency validation tests</name>
  <files>tests/validation/test_data_consistency.py</files>
  <action>
Create comprehensive data consistency validation tests (SIG-05):

1. Imports: pytest, sqlalchemy, pandas, numpy, datetime

2. Class `TestDataConsistencyValidation`:

   a. `test_no_duplicate_ema_rows`:
      - Query each EMA table for duplicates: (id, ts, tf, period) should be unique
      - Assert duplicate_count == 0 for each table

   b. `test_ema_rowcounts_within_expected_range`:
      - For each active TF in dim_timeframe:
        - Calculate expected rows based on date range and tf_days
        - Query actual rowcount
        - Assert actual within +/- 5% of expected
      - Use sample assets (id IN (1, 2, 3)) for performance

   c. `test_no_null_ema_values`:
      - Query EMA tables for NULL ema column values
      - Assert null_count == 0 (EMAs should always have values)

   d. `test_ema_values_in_reasonable_range`:
      - Query EMA values, verify all positive (price-based)
      - Verify no extreme outliers (ema > close * 10 or ema < close / 10)
      - Sample check: 1000 random rows

   e. `test_price_ema_alignment`:
      - Join cmc_price_histories7 to EMA tables on (id, ts)
      - Verify ts dates align (no orphan EMA rows without prices)
      - Allow small tolerance for weekend/holiday differences

   f. `test_gap_detection_for_crypto_assets`:
      - For crypto assets (24/7 trading), verify no date gaps
      - Query consecutive ts values, calculate day deltas
      - For 1D TF, assert all deltas == 1 (no missing days)
      - Allow gaps only before asset start date

   g. `test_returns_table_consistency` (if cmc_returns_daily exists):
      - Verify returns calculated correctly: return = (close - prev_close) / prev_close
      - Spot check 100 random rows
      - Tolerance: 1e-10 for floating point

   h. `test_volatility_table_consistency` (if cmc_vol_daily exists):
      - Verify volatility values positive and reasonable (< 500%)
      - Spot check bounds

3. Helper functions:
   - `get_date_range(db_session, table_name)` -> (min_ts, max_ts)
   - `count_gaps(db_session, table_name, asset_id, tf)` -> gap_count

4. All tests use @pytest.mark.validation_gate marker
5. Zero tolerance for duplicates and NULL EMAs (strict validation)
  </action>
  <verify>
`pytest tests/validation/test_data_consistency.py --collect-only` shows 7-8 test methods collected
  </verify>
  <done>Data consistency tests verify no gaps, correct rowcounts, and EMA calculation integrity</done>
</task>

</tasks>

<verification>
1. `pytest tests/validation/ --collect-only` shows all validation tests discovered
2. Test files have proper imports and pytest markers
3. Each test has clear assertion messages for debugging
4. Tests skip gracefully if TARGET_DB_URL not set
</verification>

<success_criteria>
- test_time_alignment.py validates SIG-04 (6+ tests)
- test_data_consistency.py validates SIG-05 (7+ tests)
- All tests use validation_gate marker
- Zero tolerance for critical issues (orphan TFs, duplicates, NULLs)
- 5% tolerance for rowcount variations
</success_criteria>

<output>
After completion, create `.planning/phases/10-release-validation/10-02-SUMMARY.md`
</output>
