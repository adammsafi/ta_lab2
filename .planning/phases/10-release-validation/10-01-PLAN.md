---
phase: 10-release-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/validation.yml
  - tests/validation/conftest.py
  - tests/validation/__init__.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "CI runs validation tests against real PostgreSQL"
    - "Validation workflow blocks merge on failure"
    - "Coverage reports generated in both JSON and markdown"
  artifacts:
    - path: ".github/workflows/validation.yml"
      provides: "CI validation gates with PostgreSQL service"
      contains: "services:"
    - path: "tests/validation/conftest.py"
      provides: "Database fixtures for validation tests"
      exports: ["db_engine", "db_session"]
    - path: "tests/validation/__init__.py"
      provides: "Validation test package marker"
  key_links:
    - from: ".github/workflows/validation.yml"
      to: "tests/validation/"
      via: "pytest command"
      pattern: "pytest tests/validation"
---

<objective>
Create CI validation infrastructure with PostgreSQL service container

Purpose: Enable automated validation gates that run against real database (per CONTEXT.md requirement - no mock mode for CI). This is the foundation for all three validation types (time alignment, data consistency, backtest reproducibility).

Output: GitHub Actions workflow with PostgreSQL service, validation test fixtures, coverage configuration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-release-validation/10-CONTEXT.md
@.planning/phases/10-release-validation/10-RESEARCH.md

# Existing CI workflow (to understand current structure)
@.github/workflows/ci.yml

# Existing pyproject.toml (for pytest config)
@pyproject.toml

# Existing conftest for test markers
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation CI workflow with PostgreSQL</name>
  <files>.github/workflows/validation.yml</files>
  <action>
Create new GitHub Actions workflow for validation gates:

1. Trigger: push to main, pull_request to main
2. PostgreSQL 16 service container with health checks:
   - POSTGRES_USER: postgres
   - POSTGRES_PASSWORD: postgres
   - POSTGRES_DB: ta_lab2_validation
   - Health check: pg_isready with 10s interval, 5s timeout, 5 retries
   - Port: 5432:5432

3. Python 3.11 setup (match primary CI version)

4. Install dependencies: `pip install -e ".[orchestrator,dev]" pytest-cov pytest-json-report`

5. Run validation with fail-fast and coverage:
```yaml
env:
  TARGET_DB_URL: postgresql://postgres:postgres@localhost:5432/ta_lab2_validation
run: |
  pytest tests/validation/ \
    --maxfail=1 \
    -v \
    --cov=src/ta_lab2 \
    --cov-report=json:reports/coverage.json \
    --cov-report=markdown:reports/coverage.md \
    --cov-fail-under=70 \
    --json-report \
    --json-report-file=reports/validation.json
```

6. Upload artifacts (if: always()):
   - reports/coverage.json
   - reports/coverage.md
   - reports/validation.json

7. Add permissions: contents: read
  </action>
  <verify>YAML is valid: `python -c "import yaml; yaml.safe_load(open('.github/workflows/validation.yml'))"`</verify>
  <done>Validation workflow exists, configures PostgreSQL service, runs pytest with coverage</done>
</task>

<task type="auto">
  <name>Task 2: Create validation test fixtures and package</name>
  <files>tests/validation/conftest.py, tests/validation/__init__.py</files>
  <action>
Create validation test infrastructure:

1. `tests/validation/__init__.py`:
   - Empty file (package marker)

2. `tests/validation/conftest.py`:
   - Import pytest, os, sqlalchemy
   - Get TARGET_DB_URL from env with fallback to None
   - Create `skip_without_db` fixture that skips if TARGET_DB_URL not set
   - Create `db_engine` session-scoped fixture:
     ```python
     @pytest.fixture(scope="session")
     def db_engine():
         url = os.environ.get("TARGET_DB_URL")
         if not url:
             pytest.skip("TARGET_DB_URL not set")
         from sqlalchemy import create_engine
         engine = create_engine(url)
         yield engine
         engine.dispose()
     ```
   - Create `db_session` function-scoped fixture with transaction rollback:
     ```python
     @pytest.fixture
     def db_session(db_engine):
         from sqlalchemy.orm import sessionmaker
         Session = sessionmaker(bind=db_engine)
         session = Session()
         yield session
         session.rollback()
         session.close()
     ```
   - Create `ensure_schema` session-scoped fixture that ensures dim_timeframe and dim_sessions exist (calls ensure_dim_tables if needed)
  </action>
  <verify>
`python -c "from tests.validation.conftest import db_engine, db_session; print('Fixtures importable')"` succeeds (syntax check)
  </verify>
  <done>Validation test fixtures exist with database session management and graceful skip without DB</done>
</task>

<task type="auto">
  <name>Task 3: Update pyproject.toml with validation markers and coverage config</name>
  <files>pyproject.toml</files>
  <action>
Update pytest and coverage configuration:

1. Add pytest-cov and pytest-json-report to dev dependencies (if not present)

2. Add marker for validation tests:
   ```toml
   "validation_gate: CI validation gate tests (require real database)",
   ```

3. Add coverage configuration section:
   ```toml
   [tool.coverage.run]
   source = ["src"]
   omit = [
       "*/tests/*",
       "*/migrations/*",
       "*/__pycache__/*",
   ]

   [tool.coverage.report]
   exclude_lines = [
       "pragma: no cover",
       "def __repr__",
       "raise AssertionError",
       "raise NotImplementedError",
       "if __name__ == .__main__.:",
       "if TYPE_CHECKING:",
   ]
   ```

Note: Keep existing pytest markers, just add the new one
  </action>
  <verify>`pip install -e ".[dev]" && python -c "import pytest; print('pytest installed')"` succeeds</verify>
  <done>pyproject.toml has validation marker and coverage configuration</done>
</task>

</tasks>

<verification>
1. Workflow YAML is valid and contains PostgreSQL service configuration
2. Validation fixtures can be imported
3. pyproject.toml has coverage configuration
4. `pytest --collect-only tests/validation/` shows validation test directory is recognized
</verification>

<success_criteria>
- validation.yml workflow exists with PostgreSQL service container
- tests/validation/ package exists with database fixtures
- Coverage configured to fail under 70%
- Validation tests will skip gracefully without TARGET_DB_URL
</success_criteria>

<output>
After completion, create `.planning/phases/10-release-validation/10-01-SUMMARY.md`
</output>
