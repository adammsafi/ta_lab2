---
phase: 03-memory-advanced-mem0-migration
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/memory/health.py
  - tests/orchestrator/test_memory_health.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Stale memories (not verified in 90+ days) are detected"
    - "Deprecated memories are flagged with timestamp and reason"
    - "Health report shows memory age distribution"
    - "Monitoring detects outdated context before it poisons decisions"
  artifacts:
    - path: "src/ta_lab2/tools/ai_orchestrator/memory/health.py"
      provides: "Memory health monitoring module"
      exports: ["MemoryHealthMonitor", "HealthReport", "scan_stale_memories"]
    - path: "tests/orchestrator/test_memory_health.py"
      provides: "Health monitoring tests"
      min_lines: 80
  key_links:
    - from: "health.py"
      to: "metadata.py"
      via: "validate_metadata, mark_deprecated"
      pattern: "mark_deprecated"
    - from: "health.py"
      to: "Mem0Client"
      via: "get_all(), update()"
      pattern: "get_mem0_client"
---

<objective>
Build memory health monitoring to detect stale and deprecated memories (MEMO-06)

Purpose: Outdated memories poison AI decisions. A memory stating "EMA refresh runs at 2 PM" becomes dangerous when the schedule changes to midnight. Health monitoring detects memories not verified recently and flags them for review or automatic deprecation.

Output: Memory health scanner that detects stale memories, generates health reports, and supports automatic deprecation workflows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-advanced-mem0-migration/03-RESEARCH.md

# Prior plan outputs needed
@src/ta_lab2/tools/ai_orchestrator/memory/mem0_client.py
@src/ta_lab2/tools/ai_orchestrator/memory/metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create memory health monitoring module</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/health.py
  </files>
  <action>
    1. Create health.py with:

       HealthReport dataclass:
       - total_memories: int
       - healthy: int (verified within threshold)
       - stale: int (not verified in staleness_days)
       - deprecated: int (has deprecated_since set)
       - missing_metadata: int (no created_at or last_verified)
       - age_distribution: dict[str, int] (e.g., {"0-30d": 100, "30-60d": 50, "60-90d": 30, "90+d": 20})
       - stale_memories: list[dict] (details of stale memories for review)
       - scan_timestamp: str (ISO 8601 when scan ran)

       MemoryHealthMonitor class:
       - __init__(client: Mem0Client = None, staleness_days: int = 90)
         - If client is None, use get_mem0_client()
         - staleness_days: threshold for marking as stale (default 90 per requirements)
       - scan_stale_memories() -> list[dict]
         - Get all memories via client.get_all()
         - Check each memory's last_verified timestamp
         - Return list of stale memories with: id, content[:100], last_verified, age_days
       - generate_health_report() -> HealthReport
         - Scan all memories
         - Categorize by age, status, metadata completeness
         - Build HealthReport with full details
       - flag_stale_memories(dry_run: bool = True) -> int
         - For each stale memory, call mark_deprecated() with reason
         - If not dry_run, update memory with deprecated metadata
         - Return count of flagged memories
       - refresh_verification(memory_ids: list[str]) -> int
         - Update last_verified to now for given memories
         - Use when human confirms memory is still accurate
         - Return count of refreshed memories

       Standalone function:
       - def scan_stale_memories(staleness_days: int = 90, client: Mem0Client = None) -> list[dict]
         - Convenience function that creates monitor and calls scan

    2. Export: MemoryHealthMonitor, HealthReport, scan_stale_memories

    IMPORTANT: Health monitoring should be non-destructive by default (dry_run=True). Only flag/deprecate when explicitly requested.
  </action>
  <verify>
    python -c "
from ta_lab2.tools.ai_orchestrator.memory.health import HealthReport, MemoryHealthMonitor
report = HealthReport(
    total_memories=100, healthy=80, stale=15, deprecated=5, missing_metadata=0,
    age_distribution={'0-30d': 50, '30-60d': 30, '60-90d': 15, '90+d': 5},
    stale_memories=[], scan_timestamp='2026-01-28T00:00:00'
)
print(f'HealthReport works: {report.total_memories} total, {report.stale} stale')
"
  </verify>
  <done>
    Memory health monitoring module exists with MemoryHealthMonitor class and HealthReport
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive health monitoring tests</name>
  <files>
    tests/orchestrator/test_memory_health.py
  </files>
  <action>
    1. Create test_memory_health.py with:

       Test HealthReport:
       - test_health_report_creation: All fields populated
       - test_health_report_age_distribution: Distribution dict works

       Test MemoryHealthMonitor (with mocks):
       - test_monitor_creation: Monitor initializes with client
       - test_monitor_default_staleness: Default staleness is 90 days
       - test_scan_finds_stale_memories: Memories older than threshold flagged
       - test_scan_ignores_recent_memories: Recent memories not flagged
       - test_scan_handles_missing_metadata: Missing last_verified detected

       Test generate_health_report:
       - test_report_categorizes_by_age: Age distribution calculated correctly
       - test_report_counts_deprecated: Deprecated memories counted
       - test_report_includes_stale_list: Stale memories included for review

       Test flag_stale_memories:
       - test_flag_dry_run_no_update: Dry run does not modify memories
       - test_flag_updates_metadata: Real run adds deprecated_since
       - test_flag_includes_reason: Deprecation reason set

       Test refresh_verification:
       - test_refresh_updates_timestamp: last_verified updated
       - test_refresh_multiple_memories: Batch refresh works

       Integration test:
       - test_health_scan_real_db: Scan against real ChromaDB
       - Mark with @pytest.mark.integration

    2. Run tests: pytest tests/orchestrator/test_memory_health.py -v
  </action>
  <verify>
    pytest tests/orchestrator/test_memory_health.py -v --tb=short

    All tests should pass.
  </verify>
  <done>
    Comprehensive test suite validates health monitoring functionality
  </done>
</task>

<task type="auto">
  <name>Task 3: Update exports and create CLI entry point</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/__init__.py
    src/ta_lab2/tools/ai_orchestrator/memory/health.py
  </files>
  <action>
    1. Update memory/__init__.py to export:
       - MemoryHealthMonitor, HealthReport, scan_stale_memories

    2. Add CLI entry point to health.py:
       if __name__ == "__main__":
           import sys
           import json

           # Parse args
           staleness_days = 90
           dry_run = True
           for arg in sys.argv[1:]:
               if arg.startswith("--staleness="):
                   staleness_days = int(arg.split("=")[1])
               if arg == "--flag":
                   dry_run = False

           # Run health check
           monitor = MemoryHealthMonitor(staleness_days=staleness_days)
           report = monitor.generate_health_report()

           print(f"Memory Health Report")
           print(f"====================")
           print(f"Total: {report.total_memories}")
           print(f"Healthy: {report.healthy}")
           print(f"Stale: {report.stale}")
           print(f"Deprecated: {report.deprecated}")
           print(f"Missing metadata: {report.missing_metadata}")
           print(f"\nAge distribution: {json.dumps(report.age_distribution, indent=2)}")

           if report.stale > 0 and not dry_run:
               count = monitor.flag_stale_memories(dry_run=False)
               print(f"\nFlagged {count} stale memories as deprecated")

    3. Verify CLI works:
       python -c "
from ta_lab2.tools.ai_orchestrator.memory import MemoryHealthMonitor, HealthReport, scan_stale_memories
print('All health monitoring exports available')
"

    4. Run full test suite:
       pytest tests/orchestrator/ -v --tb=short -k "health"
  </action>
  <verify>
    pytest tests/orchestrator/test_memory_health.py -v --tb=short

    All tests pass. CLI entry point documented.
  </verify>
  <done>
    Health monitoring integrated with exports and CLI entry point
  </done>
</task>

</tasks>

<verification>
1. HealthReport captures comprehensive memory statistics
2. MemoryHealthMonitor detects stale memories (>90 days since verification)
3. flag_stale_memories adds deprecated_since with reason
4. refresh_verification updates last_verified for confirmed memories
5. CLI entry point allows manual health checks
6. All tests pass
</verification>

<success_criteria>
- Stale memories detected based on last_verified timestamp
- Health report shows age distribution and status breakdown
- Deprecation workflow flags outdated memories
- Verification refresh keeps accurate memories healthy
- Ready for REST API integration
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-advanced-mem0-migration/03-04-SUMMARY.md`
</output>
