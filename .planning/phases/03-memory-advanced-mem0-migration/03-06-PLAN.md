---
phase: 03-memory-advanced-mem0-migration
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/memory/migration.py
  - tests/orchestrator/test_full_migration.py
autonomous: false
user_setup: []

must_haves:
  truths:
    - "All 3,763 memories accessible through Mem0 layer"
    - "All memories have enhanced metadata (created_at, last_verified)"
    - "Memory health report shows 0 missing_metadata"
    - "Conflict detection operational for new additions"
  artifacts:
    - path: "tests/orchestrator/test_full_migration.py"
      provides: "Full migration validation tests"
      min_lines: 60
  key_links:
    - from: "migration.py"
      to: "Mem0Client"
      via: "Full migration execution"
      pattern: "migrate_metadata"
    - from: "test_full_migration.py"
      to: "health.py"
      via: "HealthReport validation"
      pattern: "MemoryHealthMonitor"
---

<objective>
Run full metadata migration and validate Phase 3 success criteria

Purpose: Execute the metadata migration on all 3,763 memories and validate that Phase 3 success criteria are met: all memories migrated to Mem0, conflicts detected, stale memories flagged, and metadata enhanced.

Output: Validated migration with health report confirming all success criteria.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-advanced-mem0-migration/03-RESEARCH.md

# Prior plan outputs needed
@src/ta_lab2/tools/ai_orchestrator/memory/migration.py
@src/ta_lab2/tools/ai_orchestrator/memory/health.py
@src/ta_lab2/tools/ai_orchestrator/memory/mem0_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full migration validation test suite</name>
  <files>
    tests/orchestrator/test_full_migration.py
  </files>
  <action>
    1. Create test_full_migration.py with comprehensive validation tests:

       Pre-migration checks:
       - test_chromadb_has_expected_memories: Verify 3,763 memories exist
       - test_mem0_can_access_chromadb: Mem0 client initializes and connects

       Migration validation:
       - test_migration_dry_run_safe: Dry run reports counts without changes
       - test_migration_result_structure: MigrationResult has all fields

       Post-migration validation (mark as @pytest.mark.integration):
       - test_all_memories_have_created_at: Every memory has created_at
       - test_all_memories_have_last_verified: Every memory has last_verified
       - test_health_report_no_missing_metadata: missing_metadata == 0
       - test_memory_count_unchanged: Still 3,763 memories after migration

       Success criteria validation:
       - test_phase3_criteria_1_migration_complete: All memories in Mem0
       - test_phase3_criteria_2_conflict_detection_works: detect_conflicts returns results
       - test_phase3_criteria_3_health_monitoring_works: HealthReport generated
       - test_phase3_criteria_4_metadata_enhanced: created_at, last_verified present
       - test_phase3_criteria_5_stale_detection_works: Stale memories identified

    2. Add pytest markers:
       - @pytest.mark.integration for tests requiring real DB
       - @pytest.mark.slow for full migration test

    3. Run validation tests in dry-run mode first
  </action>
  <verify>
    pytest tests/orchestrator/test_full_migration.py -v --tb=short -k "not integration"

    Non-integration tests pass.
  </verify>
  <done>
    Full migration validation test suite created
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute metadata migration programmatically</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/migration.py
  </files>
  <action>
    Execute migration using the migrate_metadata() function created in Plan 03-02.

    1. First, run a dry-run to preview changes:
       - Import migrate_metadata from migration module
       - Call migrate_metadata(dry_run=True, batch_size=100)
       - Inspect the MigrationResult: expect total ~3763, updated ~3763, skipped 0, errors 0

    2. If dry-run results look correct, execute actual migration:
       - Call migrate_metadata(dry_run=False, batch_size=100)
       - Store the MigrationResult

    3. Validate the migration completed:
       - Check result.errors == 0
       - Check result.error_ids is empty list
       - Log the counts: total, updated, skipped

    4. Run validation function:
       - Import validate_migration from migration module
       - Call validate_migration(sample_size=100)
       - Verify returns (True, success_message)

    IMPORTANT: Migration is idempotent. If any step fails, re-running will not corrupt data - it will simply skip already-migrated memories.
  </action>
  <verify>
    python -m ta_lab2.tools.ai_orchestrator.memory.migration --dry-run

    Expected dry-run output: Total: ~3763, Updated: ~3763, Skipped: 0, Errors: 0

    Then verify post-migration:
    python -c "
from ta_lab2.tools.ai_orchestrator.memory.migration import validate_migration
success, message = validate_migration(sample_size=100)
print(f'Validation: {\"PASS\" if success else \"FAIL\"} - {message}')
"

    Output should show: Validation: PASS
  </verify>
  <done>
    Metadata migration executed successfully on all 3,763 memories with result.errors == 0
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full Phase 3 migration: Mem0 integration with conflict detection, health monitoring, and REST API endpoints
  </what-built>
  <how-to-verify>
    1. Start the API server:
       uvicorn ta_lab2.tools.ai_orchestrator.memory.api:app --port 8080

    2. Check health endpoint:
       curl http://localhost:8080/api/v1/memory/health
       - Verify total_memories is 3,763
       - Verify missing_metadata is 0
       - Verify stale count is reasonable

    3. Check conflict detection:
       curl -X POST http://localhost:8080/api/v1/memory/conflict/check \
         -H "Content-Type: application/json" \
         -d '{"content": "EMA calculation uses 20 periods"}'
       - Should return potential conflicts if similar memories exist

    4. Check stale memories:
       curl http://localhost:8080/api/v1/memory/health/stale
       - Should return list of memories to review

    5. Run full test suite:
       pytest tests/orchestrator/ -v --tb=short
       - All tests should pass
  </how-to-verify>
  <resume-signal>Type "approved" if all endpoints work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 Success Criteria Validation:

1. All 3,763 memories accessible through Mem0 layer
   - Verify: GET /api/v1/memory/health returns total_memories=3763

2. Conflicting memories detected and resolved
   - Verify: POST /api/v1/memory/conflict/check returns results
   - Verify: POST /api/v1/memory/conflict/add resolves conflicts

3. Stale memories flagged with deprecated_since
   - Verify: GET /api/v1/memory/health/stale returns aged memories
   - Verify: Health report shows stale count

4. Memory health monitoring detects outdated context
   - Verify: HealthReport.age_distribution shows memory ages
   - Verify: flag_stale_memories adds deprecated_since

5. All memories have enhanced metadata
   - Verify: HealthReport.missing_metadata == 0
   - Verify: Sample memories have created_at, last_verified
</verification>

<success_criteria>
- [ ] 3,763 memories accessible via Mem0 layer
- [ ] Migration completed with 0 errors
- [ ] Health report shows missing_metadata == 0
- [ ] Conflict detection endpoint returns valid results
- [ ] Stale memory detection works
- [ ] All REST API endpoints operational
- [ ] Full test suite passes
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-advanced-mem0-migration/03-06-SUMMARY.md`
</output>
