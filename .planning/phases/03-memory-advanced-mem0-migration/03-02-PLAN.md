---
phase: 03-memory-advanced-mem0-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/memory/metadata.py
  - src/ta_lab2/tools/ai_orchestrator/memory/migration.py
  - tests/orchestrator/test_metadata_migration.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All memories have created_at timestamp (backfilled or original)"
    - "All memories have last_verified timestamp"
    - "Metadata schema supports deprecated_since field"
    - "Migration is idempotent (re-running does not corrupt data)"
  artifacts:
    - path: "src/ta_lab2/tools/ai_orchestrator/memory/metadata.py"
      provides: "Enhanced metadata schema and utilities"
      exports: ["MemoryMetadata", "create_metadata", "validate_metadata"]
    - path: "src/ta_lab2/tools/ai_orchestrator/memory/migration.py"
      provides: "Metadata migration script"
      exports: ["migrate_metadata", "MigrationResult"]
    - path: "tests/orchestrator/test_metadata_migration.py"
      provides: "Migration tests"
      min_lines: 60
  key_links:
    - from: "migration.py"
      to: "Mem0Client"
      via: "get_mem0_client()"
      pattern: "get_mem0_client"
    - from: "metadata.py"
      to: "datetime"
      via: "timestamp generation"
      pattern: "datetime\\.utcnow"
---

<objective>
Add enhanced metadata to all memories (MEMO-08)

Purpose: Memory health monitoring requires timestamps to detect stale memories. This plan enriches all 3,763 memories with created_at, last_verified, and deprecated_since fields. The migration is idempotent to support incremental updates.

Output: All memories have enhanced metadata ready for health monitoring and staleness detection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-advanced-mem0-migration/03-RESEARCH.md

# Prior plan outputs needed
@src/ta_lab2/tools/ai_orchestrator/memory/mem0_client.py
@src/ta_lab2/tools/ai_orchestrator/memory/mem0_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhanced metadata schema module</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/metadata.py
  </files>
  <action>
    1. Create metadata.py with:

       MemoryMetadata dataclass:
       - created_at: str (ISO 8601 timestamp, required)
       - last_verified: str (ISO 8601 timestamp, required)
       - deprecated_since: Optional[str] = None (ISO 8601 timestamp, set when memory flagged stale)
       - deprecation_reason: Optional[str] = None (why memory was deprecated)
       - source: str = "unknown" (where memory originated: "chromadb_phase2", "manual", "conversation")
       - category: Optional[str] = None (e.g., "pipeline_schedule", "api_design", "decision")
       - migration_version: int = 1 (schema version for future migrations)

       Utility functions:
       - create_metadata(source: str = "manual", category: str = None, existing: dict = None) -> dict
         - If existing has created_at, preserve it
         - If existing has no created_at, use current UTC time
         - Always update last_verified to current UTC time
         - Return dict suitable for Mem0 metadata parameter
       - validate_metadata(metadata: dict) -> tuple[bool, list[str]]
         - Returns (is_valid, issues)
         - Checks required fields exist and are valid ISO 8601 timestamps
       - mark_deprecated(metadata: dict, reason: str) -> dict
         - Adds deprecated_since and deprecation_reason
         - Returns updated metadata dict

    2. Export: MemoryMetadata, create_metadata, validate_metadata, mark_deprecated

    IMPORTANT: All timestamps MUST be ISO 8601 format (datetime.utcnow().isoformat()) for consistent parsing.
  </action>
  <verify>
    python -c "
from ta_lab2.tools.ai_orchestrator.memory.metadata import create_metadata, validate_metadata
meta = create_metadata(source='test')
valid, issues = validate_metadata(meta)
print(f'Valid: {valid}, Fields: {list(meta.keys())}')
"
    Output should show Valid: True and include created_at, last_verified, source, migration_version
  </verify>
  <done>
    Metadata schema module exists with MemoryMetadata dataclass and utility functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create metadata migration script</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/migration.py
  </files>
  <action>
    1. Create migration.py with:

       MigrationResult dataclass:
       - total: int (total memories processed)
       - updated: int (memories with metadata added)
       - skipped: int (memories already had valid metadata)
       - errors: int (memories that failed)
       - error_ids: list[str] (memory IDs that failed for debugging)

       migrate_metadata function:
       - def migrate_metadata(client: Mem0Client = None, batch_size: int = 100, dry_run: bool = False) -> MigrationResult
       - If client is None, get from get_mem0_client()
       - Iterate through all memories using client.get_all()
       - For each memory:
         - Check if metadata already has created_at and last_verified
         - If both exist and are valid: increment skipped
         - If missing or invalid: use create_metadata() to enrich, source="chromadb_phase2"
         - If not dry_run: call client.update(memory_id, metadata=enhanced_metadata)
         - Handle errors: increment errors, append to error_ids, continue (don't fail entire migration)
       - Return MigrationResult with counts
       - Log progress every batch_size memories

       validate_migration function:
       - def validate_migration(client: Mem0Client = None, sample_size: int = 100) -> tuple[bool, str]
       - Sample random memories and verify they have valid metadata
       - Return (success, message)

    2. Add CLI entrypoint if run directly:
       if __name__ == "__main__":
           import sys
           dry_run = "--dry-run" in sys.argv
           result = migrate_metadata(dry_run=dry_run)
           print(f"Migration result: {result}")

    3. Export: migrate_metadata, validate_migration, MigrationResult

    IMPORTANT: Migration MUST be idempotent. Running twice should not corrupt data or duplicate updates.
  </action>
  <verify>
    python -c "
from ta_lab2.tools.ai_orchestrator.memory.migration import MigrationResult
r = MigrationResult(total=100, updated=90, skipped=10, errors=0, error_ids=[])
print(f'MigrationResult works: {r.total} total, {r.updated} updated')
"
  </verify>
  <done>
    Migration script exists with idempotent metadata enrichment and MigrationResult tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tests and validate migration</name>
  <files>
    tests/orchestrator/test_metadata_migration.py
    src/ta_lab2/tools/ai_orchestrator/memory/__init__.py
  </files>
  <action>
    1. Create test_metadata_migration.py with:

       Test metadata module:
       - test_create_metadata_sets_timestamps: created_at and last_verified populated
       - test_create_metadata_preserves_existing_created_at: Existing created_at not overwritten
       - test_validate_metadata_valid: Valid metadata passes validation
       - test_validate_metadata_missing_field: Missing required field detected
       - test_mark_deprecated_adds_fields: deprecated_since and reason added

       Test migration (with mocks):
       - test_migrate_metadata_dry_run: Dry run does not call update
       - test_migrate_metadata_updates_missing: Memories without metadata get enriched
       - test_migrate_metadata_skips_existing: Memories with valid metadata skipped
       - test_migrate_metadata_handles_errors: Errors logged but don't stop migration
       - test_migration_is_idempotent: Running twice produces same result

       Integration test:
       - test_validate_migration_sample: Sample validation works
       - Mark with @pytest.mark.integration

    2. Update memory/__init__.py to export:
       - MemoryMetadata, create_metadata, validate_metadata, mark_deprecated
       - migrate_metadata, validate_migration, MigrationResult

    3. Run tests: pytest tests/orchestrator/test_metadata_migration.py -v
  </action>
  <verify>
    pytest tests/orchestrator/test_metadata_migration.py -v --tb=short

    All tests should pass.
  </verify>
  <done>
    Test suite validates metadata schema and migration script functionality
  </done>
</task>

</tasks>

<verification>
1. MemoryMetadata dataclass has all required fields
2. create_metadata() generates valid timestamps
3. Migration script is idempotent (re-running is safe)
4. All tests pass
5. Memory module exports new functions
</verification>

<success_criteria>
- Enhanced metadata schema created (created_at, last_verified, deprecated_since)
- Migration script can enrich existing memories
- Migration is idempotent and handles errors gracefully
- Ready for health monitoring plan (03-04)
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-advanced-mem0-migration/03-02-SUMMARY.md`
</output>
