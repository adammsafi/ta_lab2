---
phase: 24-pattern-consistency
plan: 04
type: execute
wave: 3
depends_on: ["24-02", "24-03"]
files_modified:
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
  - sql/ddl/calendar_state_tables.sql
autonomous: true

must_haves:
  truths:
    - "All 4 calendar builders inherit from BaseBarBuilder"
    - "Calendar alignment logic preserved (US Sunday vs ISO Monday)"
    - "Anchor vs full-period semantics preserved"
    - "tz column documented with rationale"
    - "CLI interfaces unchanged"
  artifacts:
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py"
      provides: "US calendar bar builder using BaseBarBuilder"
      exports: ["CalendarUSBarBuilder"]
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py"
      provides: "ISO calendar bar builder using BaseBarBuilder"
      exports: ["CalendarISOBarBuilder"]
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py"
      provides: "Anchored US calendar bar builder using BaseBarBuilder"
      exports: ["AnchorCalendarUSBarBuilder"]
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py"
      provides: "Anchored ISO calendar bar builder using BaseBarBuilder"
      exports: ["AnchorCalendarISOBarBuilder"]
  key_links:
    - from: "calendar builders"
      to: "BaseBarBuilder"
      via: "class inheritance"
      pattern: "class.*CalendarBarBuilder\\(BaseBarBuilder\\)"
---

<objective>
Refactor all 4 calendar bar builders to use BaseBarBuilder and document the tz column design rationale.

Purpose: Complete the bar builder standardization by refactoring the 4 calendar variants. These builders share 90%+ code structure with each other and with the main multi-TF builder, differing only in calendar alignment (US vs ISO week start) and partial bar policies (full-period vs anchored). This plan also addresses GAP-M03 by documenting why tz column is NOT in PRIMARY KEY.

Output: All 4 calendar builders using BaseBarBuilder (total ~5991 LOC reduced to ~1500 LOC), plus documentation clarifying tz column design.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Base class and proof of concept
@src/ta_lab2/scripts/bars/base_bar_builder.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_1d.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py

# Calendar builders to refactor
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py

# Gap analysis reference for GAP-M03
@.planning/phases/21-comprehensive-review/deliverables/gap-analysis.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor cal_us and cal_iso builders</name>
  <files>src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py, src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py</files>
  <action>
Analyze the two calendar builders and identify differences:
- cal_us: Weeks start Sunday (US convention)
- cal_iso: Weeks start Monday (ISO convention)
- Both: Full-period semantics (only complete periods emitted)

The difference between them is minimal (WEEK_START constant and calendar alignment function).

Refactor cal_us first:
1. Create CalendarUSBarBuilder(BaseBarBuilder) class
2. Constants: STATE_TABLE, OUTPUT_TABLE, WEEK_START=6 (Sunday)
3. Implement abstract methods mirroring MultiTFBarBuilder pattern
4. Calendar-specific: _get_calendar_week_start(), _align_to_calendar_period()
5. Keep Polars optimization if currently used

Then refactor cal_iso:
1. Create CalendarISOBarBuilder(BaseBarBuilder) class
2. Same structure as cal_us, but WEEK_START=0 (Monday)
3. Could consider shared base class CalendarBarBuilder for these two,
   but only if it reduces duplication significantly without adding complexity

For both:
- Keep CLI interface unchanged (--tz argument especially)
- Preserve dim_timeframe query for calendar alignment_type
- Preserve full-period-only semantics

Verify:
- Both scripts import BaseBarBuilder
- Both scripts have ~300-400 LOC after refactoring (from ~1494/1538)
- CLI --help shows same arguments as before
  </action>
  <verify>
- grep "class CalendarUSBarBuilder" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
- grep "class CalendarISOBarBuilder" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
- python -c "from ta_lab2.scripts.bars.refresh_cmc_price_bars_multi_tf_cal_us import CalendarUSBarBuilder; print('OK')"
- python -c "from ta_lab2.scripts.bars.refresh_cmc_price_bars_multi_tf_cal_iso import CalendarISOBarBuilder; print('OK')"
  </verify>
  <done>Both cal_us and cal_iso builders refactored to use BaseBarBuilder, LOC reduced by 70%+</done>
</task>

<task type="auto">
  <name>Task 2: Refactor anchor_us and anchor_iso builders</name>
  <files>src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py, src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py</files>
  <action>
Analyze anchor builders vs non-anchor:
- Anchor: Year-anchored calendar alignment, partial bars allowed at year boundaries
- Non-anchor (cal_us/cal_iso): Only complete periods emitted

The anchor builders have additional complexity:
- is_partial_start/is_partial_end flags more nuanced
- Year boundary handling
- Potentially different bar_seq assignment

Refactor anchor_us:
1. Create AnchorCalendarUSBarBuilder(BaseBarBuilder) class
2. Constants: STATE_TABLE, OUTPUT_TABLE with _anchor suffix
3. Implement abstract methods with anchor-specific logic
4. Key method: _handle_year_boundary() for partial bar logic

Then refactor anchor_iso:
1. Create AnchorCalendarISOBarBuilder(BaseBarBuilder) class
2. Same structure, different week start

Consider whether to create intermediate class:
- If anchor_us and anchor_iso share 95%+ code, create AnchorCalendarBarBuilder base
- If differences are minimal (just WEEK_START), keep as separate classes

For both:
- Keep CLI interface unchanged
- Preserve anchor semantics (partial bars at year boundaries)
- Preserve quality flag handling
  </action>
  <verify>
- grep "class AnchorCalendarUSBarBuilder" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
- grep "class AnchorCalendarISOBarBuilder" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
- python -c "from ta_lab2.scripts.bars.refresh_cmc_price_bars_multi_tf_cal_anchor_us import AnchorCalendarUSBarBuilder; print('OK')"
- python -c "from ta_lab2.scripts.bars.refresh_cmc_price_bars_multi_tf_cal_anchor_iso import AnchorCalendarISOBarBuilder; print('OK')"
  </verify>
  <done>Both anchor builders refactored to use BaseBarBuilder, anchor semantics preserved</done>
</task>

<task type="auto">
  <name>Task 3: Document tz column design rationale (GAP-M03)</name>
  <files>sql/ddl/calendar_state_tables.sql, src/ta_lab2/scripts/bars/base_bar_builder.py</files>
  <action>
Address GAP-M03 from Phase 21 gap analysis:
"Calendar builders: tz column NOT in PRIMARY KEY (looks like design bug)"

The gap analysis notes this is actually CORRECT design:
- tz column is metadata only
- Calendar builders process one timezone per run (--tz flag)
- Multiple timezones for same (id, tf) not supported in same state table
- If multi-tz support needed in future, PK would change to (id, tf, tz)

Add documentation:

1. In sql/ddl/calendar_state_tables.sql (create if doesn't exist):
```sql
-- Calendar Builder State Tables
-- Design Note: tz column is intentionally NOT part of PRIMARY KEY
--
-- Rationale:
-- - Calendar builders process single timezone per run (--tz CLI flag)
-- - Multiple timezones for same (id, tf) not supported in same state table
-- - tz column is metadata/audit only, not a discriminator
-- - If multi-timezone support needed in future, change PK to (id, tf, tz)
--
-- Current PK: (id, tf)
-- tz column: Tracks which timezone was used for this state entry

CREATE TABLE IF NOT EXISTS public.cmc_price_bars_multi_tf_cal_us_state (
    id INTEGER NOT NULL,
    tf TEXT NOT NULL,
    tz TEXT,  -- NOT in PRIMARY KEY - see rationale above
    daily_min_seen TIMESTAMPTZ,
    daily_max_seen TIMESTAMPTZ,
    last_bar_snapshot_ts TIMESTAMPTZ,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (id, tf)
);
-- (similar for cal_iso, cal_anchor_us, cal_anchor_iso)
```

2. In base_bar_builder.py, add docstring note:
```python
def get_state_table_name(self) -> str:
    """
    Return state table name for this builder variant.

    Note on calendar builder state tables:
    tz column is metadata only, NOT part of PRIMARY KEY.
    Calendar builders process single timezone per run (--tz flag).
    See sql/ddl/calendar_state_tables.sql for full rationale.
    """
```

3. Update each calendar builder's class docstring to reference the design note.
  </action>
  <verify>
- cat sql/ddl/calendar_state_tables.sql shows design rationale comment
- grep "tz column" src/ta_lab2/scripts/bars/base_bar_builder.py shows documentation
- grep "tz" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py shows preserved handling
  </verify>
  <done>GAP-M03 closed: tz column design rationale documented in DDL and code comments</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All 4 calendar builders import and run: python script.py --help for each
2. Total LOC reduction: Sum of all 4 scripts reduced from ~5991 to ~1500-2000
3. tz column documentation exists in DDL file
4. All builders export their class and main function
</verification>

<success_criteria>
1. All 4 calendar builders inherit from BaseBarBuilder
2. Calendar alignment logic preserved (US Sunday vs ISO Monday)
3. Anchor semantics preserved (partial bars at year boundaries)
4. CLI interfaces unchanged for all 4 scripts
5. Total LOC reduced by at least 50% across all 4 scripts
6. GAP-M03 closed: tz column design rationale documented
</success_criteria>

<output>
After completion, create `.planning/phases/24-pattern-consistency/24-04-SUMMARY.md`
</output>
