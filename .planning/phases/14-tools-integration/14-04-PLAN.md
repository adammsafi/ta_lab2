---
phase: 14-tools-integration
plan: 04
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - src/ta_lab2/tools/data_tools/database_utils/write_daily_emas.py
  - src/ta_lab2/tools/data_tools/database_utils/write_multi_tf_emas.py
  - src/ta_lab2/tools/data_tools/database_utils/write_ema_multi_tf_cal.py
  - src/ta_lab2/tools/data_tools/database_utils/upsert_new_emas.py
  - src/ta_lab2/tools/data_tools/database_utils/__init__.py
autonomous: true

must_haves:
  truths:
    - "Database utility scripts migrated with working imports"
    - "No hardcoded database connection strings or file paths"
    - "Scripts use existing ta_lab2 database patterns (dbtool)"
  artifacts:
    - path: "src/ta_lab2/tools/data_tools/database_utils/write_daily_emas.py"
      provides: "Daily EMA write utility"
    - path: "src/ta_lab2/tools/data_tools/database_utils/__init__.py"
      provides: "Package exports"
      contains: "__all__"
  key_links:
    - from: "src/ta_lab2/tools/data_tools/database_utils/*.py"
      to: "ta_lab2.tools.dbtool"
      via: "database connection"
      pattern: "from ta_lab2.tools.dbtool import|dbtool"
---

<objective>
Migrate database utility scripts (write_*_emas, upsert_*) from Data_Tools root

Purpose: Move EMA-related database utilities that complement ta_lab2's existing EMA infrastructure. These scripts should integrate with existing dbtool patterns.

Output: Working database_utils module with EMA utilities
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-tools-integration/14-CONTEXT.md
@.planning/phases/14-tools-integration/14-01-SUMMARY.md
@.planning/phases/14-tools-integration/14-02-SUMMARY.md

# Existing ta_lab2 database patterns
@src/ta_lab2/tools/dbtool.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate EMA write utilities</name>
  <files>
    src/ta_lab2/tools/data_tools/database_utils/write_daily_emas.py
    src/ta_lab2/tools/data_tools/database_utils/write_multi_tf_emas.py
    src/ta_lab2/tools/data_tools/database_utils/write_ema_multi_tf_cal.py
  </files>
  <action>
Migrate the three EMA write scripts from C:\Users\asafi\Downloads\Data_Tools\:

For each script (write_daily_emas.py, write_multi_tf_emas.py, write_ema_multi_tf_cal.py):

1. Read source file to understand purpose and dependencies

2. Update imports:
   - Use `from ta_lab2.tools.dbtool import get_connection` (or similar pattern from existing dbtool)
   - Remove any sys.path manipulation
   - Add module-level logger

3. Replace hardcoded paths/credentials:
   - Database connection strings -> use dbtool patterns or environment variables
   - File paths -> use pathlib.Path with config.project_root() or CLI args

4. Add docstring explaining:
   - What table(s) the script writes to
   - Expected input format
   - Usage example

5. If scripts are very small/simple (< 50 lines), consider combining related ones into a single module with multiple functions

Note: These scripts likely interact with PostgreSQL tables like cmc_ema_daily, cmc_ema_multi_tf, etc. Preserve table names and SQL logic.
  </action>
  <verify>
    python -c "from ta_lab2.tools.data_tools.database_utils import write_daily_emas"
  </verify>
  <done>EMA write utilities migrated with dbtool integration</done>
</task>

<task type="auto">
  <name>Task 2: Migrate upsert utility</name>
  <files>src/ta_lab2/tools/data_tools/database_utils/upsert_new_emas.py</files>
  <action>
Migrate C:\Users\asafi\Downloads\Data_Tools\upsert_new_emas_canUpdate.py:

1. Read source file (note: original name has "canUpdate" - check if this indicates update capability)

2. Rename to simpler name: upsert_new_emas.py (or upsert_emas.py)

3. Update imports and patterns (same as Task 1)

4. Key considerations for upsert logic:
   - Preserve ON CONFLICT handling
   - Keep transaction management intact
   - Document which columns are used for conflict detection

5. If this duplicates functionality in existing ta_lab2 EMA scripts, note in docstring and consider whether to keep or mark as legacy
  </action>
  <verify>
    python -c "from ta_lab2.tools.data_tools.database_utils.upsert_new_emas import upsert_emas"
  </verify>
  <done>Upsert utility migrated with proper conflict handling preserved</done>
</task>

<task type="auto">
  <name>Task 3: Update database_utils __init__.py</name>
  <files>src/ta_lab2/tools/data_tools/database_utils/__init__.py</files>
  <action>
Update __init__.py with exports:

```python
"""
Database utilities migrated from Data_Tools.

EMA-related utilities for:
- Writing daily EMAs to cmc_ema_daily
- Writing multi-timeframe EMAs to cmc_ema_multi_tf
- Writing calendar-adjusted EMAs to cmc_ema_multi_tf_cal
- Upserting new EMA records with conflict handling

Usage:
    These utilities complement ta_lab2.scripts.emas/ refresh scripts
    by providing lower-level database operations.

Note:
    Use ta_lab2.tools.dbtool for database connections.
"""
from ta_lab2.tools.data_tools.database_utils.write_daily_emas import (
    write_daily_emas,
)
from ta_lab2.tools.data_tools.database_utils.write_multi_tf_emas import (
    write_multi_tf_emas,
)
from ta_lab2.tools.data_tools.database_utils.write_ema_multi_tf_cal import (
    write_ema_multi_tf_cal,
)
from ta_lab2.tools.data_tools.database_utils.upsert_new_emas import (
    upsert_emas,
)

__all__ = [
    "write_daily_emas",
    "write_multi_tf_emas",
    "write_ema_multi_tf_cal",
    "upsert_emas",
]
```

Adjust exports based on actual function names found in scripts.

Commit with message:
```
feat(14): migrate database utilities from Data_Tools

- write_daily_emas.py: Daily EMA writes
- write_multi_tf_emas.py: Multi-timeframe EMA writes
- write_ema_multi_tf_cal.py: Calendar-adjusted EMA writes
- upsert_new_emas.py: EMA upsert with conflict handling
- Integrated with ta_lab2.tools.dbtool patterns
```
  </action>
  <verify>
    python -c "from ta_lab2.tools.data_tools import database_utils; print(database_utils.__all__)"
  </verify>
  <done>database_utils module exports all EMA utilities; imports work from package level</done>
</task>

</tasks>

<verification>
- `python -c "from ta_lab2.tools.data_tools.database_utils import write_daily_emas"` succeeds
- `grep -r "C:\\\\Users" src/ta_lab2/tools/data_tools/database_utils/` returns nothing
- Scripts reference dbtool or use environment variables for database connections
</verification>

<success_criteria>
1. All 4 database utility scripts migrated
2. Scripts use dbtool patterns for database connections
3. No hardcoded connection strings or file paths
4. database_utils/__init__.py exports public functions
5. Imports work: `from ta_lab2.tools.data_tools.database_utils import ...`
</success_criteria>

<output>
After completion, create `.planning/phases/14-tools-integration/14-04-SUMMARY.md`
</output>
