---
phase: 06-ta-lab2-time-model
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/time/test_ema_unification.py
  - tests/time/test_sync_ema_u.py
  - src/ta_lab2/scripts/setup/ensure_ema_unified_table.py
autonomous: true

must_haves:
  truths:
    - "Querying cmc_ema_multi_tf_u returns EMA data for multiple alignment strategies"
    - "Different EMA calculation methods (calendar vs trading day) can be distinguished by alignment_source column"
    - "Running sync script twice produces same result (idempotent)"
    - "Missing unified table gets created and populated from source tables"
  artifacts:
    - path: "tests/time/test_ema_unification.py"
      provides: "Validation tests for EMA unified table schema"
      min_lines: 60
    - path: "tests/time/test_sync_ema_u.py"
      provides: "Validation tests for sync script behavior"
      min_lines: 40
    - path: "src/ta_lab2/scripts/setup/ensure_ema_unified_table.py"
      provides: "Conditional creation script for unified EMA table"
      min_lines: 60
  key_links:
    - from: "tests/time/test_ema_unification.py"
      to: "cmc_ema_multi_tf_u"
      via: "SQL queries to validate schema and data"
      pattern: "cmc_ema_multi_tf_u"
    - from: "tests/time/test_sync_ema_u.py"
      to: "src/ta_lab2/scripts/emas/sync_cmc_ema_multi_tf_u.py"
      via: "imports sync functions"
      pattern: "from ta_lab2.scripts.emas.sync_cmc_ema_multi_tf_u"
    - from: "src/ta_lab2/scripts/setup/ensure_ema_unified_table.py"
      to: "sql/features/030_cmc_ema_multi_tf_u_create.sql"
      via: "executes DDL if table missing"
      pattern: "cmc_ema_multi_tf_u"
---

<objective>
Validate EMA unification infrastructure and ensure table exists

Purpose: Confirm that the unified EMA table (cmc_ema_multi_tf_u) exists, has the correct schema with alignment_source discriminator, and that the sync script handles all source tables with proper watermarking. If table is missing, create it.

Output: Test suite validating EMA unification + conditional creation script
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# EMA unification infrastructure
@src/ta_lab2/scripts/emas/sync_cmc_ema_multi_tf_u.py
@sql/features/030_cmc_ema_multi_tf_u_create.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conditional unified EMA table setup script</name>
  <files>src/ta_lab2/scripts/setup/ensure_ema_unified_table.py</files>
  <action>
Create src/ta_lab2/scripts/setup/ensure_ema_unified_table.py with conditional table creation:

**Imports:**
- argparse, pathlib
- sqlalchemy (create_engine, text)
- from ta_lab2.config import resolve_db_url

**Core Functions:**

1. **table_exists(engine, schema, table_name)** -> bool:
   - Query information_schema.tables
   - Return True/False

2. **execute_sql_file(engine, filepath)** -> None:
   - Read SQL file content
   - Execute with engine.execute(text(content))

3. **ensure_cmc_ema_multi_tf_u(engine, sql_dir)** -> dict:
   - Check if cmc_ema_multi_tf_u exists
   - If missing:
     - Execute sql/features/030_cmc_ema_multi_tf_u_create.sql
     - Log creation
   - If exists:
     - Verify schema has alignment_source column
     - Log validation
   - Return {"existed": bool, "created": bool, "has_alignment_source": bool}

4. **main()** CLI:
   - Parse args: --sql-dir (default: sql/features), --dry-run, --sync-after
   - Run ensure_cmc_ema_multi_tf_u
   - If --sync-after: invoke sync_cmc_ema_multi_tf_u.py to populate from sources
   - Print summary
   - Exit 0 on success

**Note:** This script ensures the table exists. Population is handled by sync_cmc_ema_multi_tf_u.py which already exists.
  </action>
  <verify>
python -c "from ta_lab2.scripts.setup.ensure_ema_unified_table import table_exists, ensure_cmc_ema_multi_tf_u; print('imports OK')"
  </verify>
  <done>
Conditional setup script created that ensures cmc_ema_multi_tf_u exists before validation tests run
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EMA unified table validation tests</name>
  <files>tests/time/test_ema_unification.py</files>
  <action>
Create tests/time/test_ema_unification.py with schema and data validation:

1. **test_unified_table_exists** - Query information_schema to verify cmc_ema_multi_tf_u exists in public schema

2. **test_unified_table_has_pk_columns** - Verify primary key columns exist: id, ts, tf, period, alignment_source

3. **test_unified_table_has_value_columns** - Verify value columns: ema, ingested_at, d1, d2, tf_days, roll, d1_roll, d2_roll

4. **test_unified_table_has_bar_columns** - Verify bar-space columns (for calendar variants): ema_bar, d1_bar, d2_bar, roll_bar, d1_roll_bar, d2_roll_bar

5. **test_alignment_source_values** - Query DISTINCT alignment_source and verify expected values present. Expected: multi_tf, multi_tf_v2, multi_tf_cal_us, multi_tf_cal_iso, multi_tf_cal_anchor_us, multi_tf_cal_anchor_iso (only those that have source tables)

6. **test_unified_table_has_data** - Verify table has at least 1000 rows (reasonable minimum for production)

7. **test_pk_uniqueness** - Run COUNT(*) vs COUNT(DISTINCT (id, ts, tf, period, alignment_source)) and verify equal (no duplicates)

8. **test_tf_values_match_dim_timeframe** - Query DISTINCT tf from unified table and verify all values exist in dim_timeframe table (referential integrity)

Use pytest fixtures for db_url. Skip if TARGET_DB_URL not set.
  </action>
  <verify>
pytest tests/time/test_ema_unification.py -v passes all 8 tests
  </verify>
  <done>
8 validation tests confirm cmc_ema_multi_tf_u exists with correct schema and referential integrity to dim_timeframe
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sync script validation tests</name>
  <files>tests/time/test_sync_ema_u.py</files>
  <action>
Create tests/time/test_sync_ema_u.py with sync behavior validation:

1. **test_sources_list** - Import SOURCES from sync_cmc_ema_multi_tf_u and verify contains 6 expected table names

2. **test_alignment_source_extraction** - Import alignment_source_from_table and test:
   - alignment_source_from_table("public.cmc_ema_multi_tf") == "multi_tf"
   - alignment_source_from_table("public.cmc_ema_multi_tf_v2") == "multi_tf_v2"
   - alignment_source_from_table("public.cmc_ema_multi_tf_cal_us") == "multi_tf_cal_us"

3. **test_get_watermark_returns_none_for_empty** - Test get_watermark with a non-existent alignment_source returns None (not crash)

4. **test_build_select_expr_required_columns** - Test build_select_expr raises RuntimeError when required columns (id, ts, tf, period, ema) are missing

5. **test_build_select_expr_success** - Test build_select_expr with all required columns returns valid SQL select clause

6. **test_table_exists_helper** - Import table_exists and verify it correctly identifies existing vs non-existing tables

Use unittest.mock to avoid actual database modifications during tests. For database validation tests, use read-only queries.
  </action>
  <verify>
pytest tests/time/test_sync_ema_u.py -v passes all 6 tests
  </verify>
  <done>
6 tests validate sync script helper functions work correctly and source list is complete
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/test_ema_unification.py tests/time/test_sync_ema_u.py -v
2. All 14 tests pass (or skip gracefully if no database)
3. Tests confirm SUCCESS CRITERION #3: "Single unified EMA table"
4. python -m ta_lab2.scripts.setup.ensure_ema_unified_table --dry-run shows table status
</verification>

<success_criteria>
- test_ema_unification.py validates unified table schema and data
- test_sync_ema_u.py validates sync script functions
- Unified table has alignment_source discriminator
- Primary key is (id, ts, tf, period, alignment_source)
- TF values in unified table exist in dim_timeframe
- ensure_ema_unified_table.py creates table if missing
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-02-SUMMARY.md`
</output>
