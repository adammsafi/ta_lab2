---
phase: 06-ta-lab2-time-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/time/__init__.py
  - tests/time/test_dim_timeframe.py
  - tests/time/test_dim_sessions.py
autonomous: true

must_haves:
  truths:
    - "dim_timeframe table exists and contains TF definitions"
    - "dim_sessions table exists and contains session definitions"
    - "dim_timeframe Python class loads successfully from database"
    - "dim_sessions Python class loads successfully from database"
    - "list_tfs() returns expected canonical timeframes"
  artifacts:
    - path: "tests/time/__init__.py"
      provides: "Test package for time module"
    - path: "tests/time/test_dim_timeframe.py"
      provides: "Validation tests for dim_timeframe table and class"
      min_lines: 50
    - path: "tests/time/test_dim_sessions.py"
      provides: "Validation tests for dim_sessions table and class"
      min_lines: 40
  key_links:
    - from: "tests/time/test_dim_timeframe.py"
      to: "src/ta_lab2/time/dim_timeframe.py"
      via: "imports DimTimeframe, list_tfs, get_tf_days"
      pattern: "from ta_lab2.time.dim_timeframe import"
    - from: "tests/time/test_dim_sessions.py"
      to: "src/ta_lab2/time/dim_sessions.py"
      via: "imports DimSessions, SessionKey"
      pattern: "from ta_lab2.time.dim_sessions import"
---

<objective>
Validate dimension tables exist and are populated correctly

Purpose: Confirm that dim_timeframe and dim_sessions tables exist in PostgreSQL with expected data before proceeding with dependent work. The Python classes already exist - we need to verify the database tables are populated.

Output: Test suite validating dimension table existence and basic population
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# Existing infrastructure
@src/ta_lab2/time/dim_timeframe.py
@src/ta_lab2/time/dim_sessions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/time package and dim_timeframe validation tests</name>
  <files>tests/time/__init__.py, tests/time/test_dim_timeframe.py</files>
  <action>
Create tests/time/__init__.py (empty package file).

Create tests/time/test_dim_timeframe.py with validation tests:

1. **test_dim_timeframe_table_exists** - Query information_schema to verify dim_timeframe table exists in public schema

2. **test_dim_timeframe_has_required_columns** - Verify all required columns exist: tf, label, base_unit, tf_qty, tf_days_nominal, alignment_type, calendar_anchor, roll_policy, has_roll_flag, is_intraday, sort_order, is_canonical, calendar_scheme, allow_partial_start, allow_partial_end, tf_days_min, tf_days_max

3. **test_dim_timeframe_has_data** - Verify table has at least 5 rows (minimum viable population)

4. **test_list_tfs_returns_canonical** - Call list_tfs(db_url, canonical_only=True) and verify returns non-empty list containing at least "1D"

5. **test_list_tfs_tf_day_alignment** - Call list_tfs(db_url, alignment_type="tf_day") and verify returns expected TFs (1D, 7D, etc.)

6. **test_get_tf_days_1d** - Call get_tf_days("1D", db_url) and verify returns 1

7. **test_dimtimeframe_from_db_loads** - Call DimTimeframe.from_db(db_url) and verify returns instance with non-empty _meta dict

Use pytest fixtures for db_url (from TARGET_DB_URL env var). Skip tests if TARGET_DB_URL not set using pytest.mark.skipif.

Pattern: Use `from ta_lab2.config import TARGET_DB_URL` for database URL.
  </action>
  <verify>
pytest tests/time/test_dim_timeframe.py -v passes all tests (or skips gracefully if no database)
  </verify>
  <done>
7 validation tests for dim_timeframe exist and pass, confirming table is populated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dim_sessions validation tests</name>
  <files>tests/time/test_dim_sessions.py</files>
  <action>
Create tests/time/test_dim_sessions.py with validation tests:

1. **test_dim_sessions_table_exists** - Query information_schema to verify dim_sessions table exists

2. **test_dim_sessions_has_required_columns** - Verify columns: asset_class, region, venue, asset_key_type, asset_key, session_type, asset_id, timezone, session_open_local, session_close_local, is_24h

3. **test_dim_sessions_has_data** - Verify table has at least 1 row

4. **test_dimsessions_from_db_loads** - Call DimSessions.from_db(db_url) and verify returns instance

5. **test_crypto_session_is_24h** - Query for asset_class='CRYPTO' and verify is_24h=True

6. **test_timezone_is_iana_format** - Verify timezone column contains valid IANA timezone names (not numeric offsets like "+05:00")

Use same pytest fixture pattern as dim_timeframe tests. Skip if TARGET_DB_URL not set.

Pattern: Import DimSessions, SessionKey from ta_lab2.time.dim_sessions.
  </action>
  <verify>
pytest tests/time/test_dim_sessions.py -v passes all tests
  </verify>
  <done>
6 validation tests for dim_sessions exist and pass, confirming table is populated with IANA timezones
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/ -v shows all tests passing (or skipped if no database)
2. Tests verify database tables exist with expected schema
3. Tests confirm Python classes can load from database successfully
</verification>

<success_criteria>
- tests/time/ package exists with __init__.py
- test_dim_timeframe.py has 7 validation tests
- test_dim_sessions.py has 6 validation tests
- All tests pass when TARGET_DB_URL is set
- Tests skip gracefully when TARGET_DB_URL is not set
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-01-SUMMARY.md`
</output>
