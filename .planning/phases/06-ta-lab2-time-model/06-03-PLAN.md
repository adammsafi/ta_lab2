---
phase: 06-ta-lab2-time-model
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/time/test_refresh_scripts_dim_usage.py
  - tests/time/test_refresh_scripts_state_usage.py
autonomous: true

must_haves:
  truths:
    - "All active EMA refresh scripts import from dim_timeframe module"
    - "Scripts call list_tfs() to get timeframe definitions"
    - "No hardcoded TF lists in active refresh scripts"
    - "Scripts use get_tf_days() for tf_days lookups"
    - "All production refresh scripts use EMAStateManager for incremental state"
  artifacts:
    - path: "tests/time/test_refresh_scripts_dim_usage.py"
      provides: "Static analysis tests verifying dim_timeframe usage"
      min_lines: 60
    - path: "tests/time/test_refresh_scripts_state_usage.py"
      provides: "Static analysis tests verifying EMAStateManager usage in production"
      min_lines: 40
  key_links:
    - from: "tests/time/test_refresh_scripts_dim_usage.py"
      to: "src/ta_lab2/scripts/emas/refresh_*.py"
      via: "AST analysis or file content inspection"
      pattern: "from ta_lab2.time.dim_timeframe import"
    - from: "tests/time/test_refresh_scripts_state_usage.py"
      to: "src/ta_lab2/scripts/emas/refresh_*.py"
      via: "file content inspection for EMAStateManager"
      pattern: "EMAStateManager|ema_state_manager"
---

<objective>
Validate EMA refresh scripts reference dim_timeframe and use EMAStateManager

Purpose: Confirm SUCCESS CRITERION #4 - All EMA refresh scripts reference dim_timeframe instead of hardcoded values. Also verify that production scripts use EMAStateManager for incremental state tracking (addresses blocker #6). Use static analysis to verify imports and function calls.

Output: Test suite proving scripts use centralized TF definitions and state management
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# EMA refresh scripts
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_from_bars.py
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_v2.py
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_from_bars.py
@src/ta_lab2/scripts/emas/ema_state_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dim_timeframe usage validation tests</name>
  <files>tests/time/test_refresh_scripts_dim_usage.py</files>
  <action>
Create tests/time/test_refresh_scripts_dim_usage.py with static analysis tests:

Define ACTIVE_REFRESH_SCRIPTS list:
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_from_bars.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_v2.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_from_bars.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py"

Tests:

1. **test_scripts_import_dim_timeframe** - For each script in ACTIVE_REFRESH_SCRIPTS:
   - Read file content
   - Assert "from ta_lab2.time.dim_timeframe import" appears in content
   - Use pytest.param with ids for readable output

2. **test_scripts_call_list_tfs** - For each script:
   - Assert "list_tfs(" appears in content (function call to get TF definitions)

3. **test_no_hardcoded_tf_arrays** - For each script:
   - Search for hardcoded patterns like `["1D", "7D"` or `tfs = ["1D"`
   - Assert NO matches found (TFs should come from dim_timeframe)
   - Note: DEFAULT_PERIODS for EMA periods is OK - we're checking TF definitions

4. **test_base_ema_refresher_uses_dim** - Read base_ema_refresher.py and verify it imports from dim_timeframe

5. **test_stats_scripts_use_dim** - Check stats scripts also use dim_timeframe:
   - stats/multi_tf/refresh_ema_multi_tf_stats.py
   - stats/multi_tf_cal/refresh_ema_multi_tf_cal_stats.py
   - stats/multi_tf_v2/refresh_ema_multi_tf_v2_stats.py
   - stats/multi_tf_cal_anchor/refresh_ema_multi_tf_cal_anchor_stats.py

6. **test_old_scripts_are_deprecated** - Verify scripts in old/ directory exist (not deleted) but are NOT imported by active scripts

7. **test_count_active_vs_deprecated** - Report ratio:
   - Count active scripts (4 main + 4 stats = 8)
   - Count old scripts (expected ~14)
   - Assert active < old (confirms refactoring reduced duplication)

8. **test_no_active_script_imports_old** - For each active script:
   - Assert "from ta_lab2.scripts.emas.old" NOT in content
   - Confirms active scripts don't depend on deprecated code

Use Path from pathlib for cross-platform file reading. Use PROJECT_ROOT fixture to locate files.
  </action>
  <verify>
pytest tests/time/test_refresh_scripts_dim_usage.py -v passes all 8 tests
  </verify>
  <done>
8 tests validating dim_timeframe usage and deprecation of old scripts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EMAStateManager usage validation tests</name>
  <files>tests/time/test_refresh_scripts_state_usage.py</files>
  <action>
Create tests/time/test_refresh_scripts_state_usage.py with static analysis verifying EMAStateManager usage:

Define PRODUCTION_SCRIPTS list (same 4 main refresh scripts):
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_from_bars.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_v2.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_from_bars.py"
- "src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py"

Tests:

1. **test_scripts_import_ema_state_manager** - For each script:
   - Read file content
   - Assert "EMAStateManager" OR "ema_state_manager" appears (import or usage)
   - Use pytest.param with ids

2. **test_scripts_call_state_manager_methods** - For each script:
   - Assert at least one of: "load_state", "save_state", "compute_dirty_window" appears
   - Verifies scripts actually USE state management, not just import it

3. **test_state_manager_module_exists** - Verify src/ta_lab2/scripts/emas/ema_state_manager.py exists

4. **test_state_manager_has_required_exports** - Import EMAStateManager and verify:
   - Has load_state method
   - Has save_state method (or upsert_state)
   - Has EMAStateConfig or similar config class

5. **test_base_refresher_integrates_state** - Read base_ema_refresher.py:
   - Verify it imports or references EMAStateManager
   - This confirms state management is in shared base, not duplicated

6. **test_state_table_referenced** - For each production script:
   - Assert reference to state table name (e.g., "cmc_ema_multi_tf_state" or "cmc_ema_state")
   - Or assert EMAStateConfig is used (which specifies state table)

Use parametrize for clean test output showing each script checked.
  </action>
  <verify>
pytest tests/time/test_refresh_scripts_state_usage.py -v passes all 6 tests
  </verify>
  <done>
6 tests confirming all production refresh scripts use EMAStateManager for incremental state (addresses blocker #6)
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/test_refresh_scripts_dim_usage.py tests/time/test_refresh_scripts_state_usage.py -v
2. All 14 tests pass
3. Tests confirm SUCCESS CRITERION #4 via static analysis
4. Tests confirm EMAStateManager is wired into production scripts (blocker #6)
5. No database connection required for these tests
</verification>

<success_criteria>
- All active EMA refresh scripts import dim_timeframe
- Scripts call list_tfs() for TF definitions
- No hardcoded TF arrays in active scripts
- Old scripts are preserved but deprecated
- Active scripts don't import from old/
- All production scripts use EMAStateManager
- State management methods are called (not just imported)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-03-SUMMARY.md`
</output>
