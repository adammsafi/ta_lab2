---
phase: 06-ta-lab2-time-model
plan: 06
type: execute
wave: 3
depends_on:
  - "06-01"
  - "06-02"
files_modified:
  - tests/time/test_rowcount_validation.py
  - src/ta_lab2/scripts/emas/validate_ema_rowcounts.py
autonomous: true

must_haves:
  truths:
    - "Rowcount validation compares actual vs expected counts per (id, tf)"
    - "Expected counts derive from dim_timeframe tf_days and date range"
    - "Validation identifies gaps (actual < expected) and duplicates (actual > expected)"
    - "Validation script can run as CLI tool for production monitoring"
  artifacts:
    - path: "tests/time/test_rowcount_validation.py"
      provides: "Tests for rowcount validation logic"
      min_lines: 50
    - path: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      provides: "CLI script for rowcount validation"
      min_lines: 80
  key_links:
    - from: "tests/time/test_rowcount_validation.py"
      to: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      via: "imports validation functions"
      pattern: "from ta_lab2.scripts.emas.validate_ema_rowcounts import"
    - from: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      to: "src/ta_lab2/time/dim_timeframe.py"
      via: "uses get_tf_days for expected count calculation"
      pattern: "from ta_lab2.time.dim_timeframe import"
---

<objective>
Create rowcount validation for EMA tables

Purpose: Implement SUCCESS CRITERION #7 - Rowcount validation confirms actual counts match tf-defined expectations. Create validation script and tests that detect gaps and duplicates in EMA data.

Output: Validation script and test suite for EMA rowcount checking
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# Related infrastructure
@src/ta_lab2/time/dim_timeframe.py
@src/ta_lab2/scripts/emas/audit_ema_expected_coverage.py
@src/ta_lab2/scripts/emas/audit_ema_integrity.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rowcount validation script</name>
  <files>src/ta_lab2/scripts/emas/validate_ema_rowcounts.py</files>
  <action>
Create src/ta_lab2/scripts/emas/validate_ema_rowcounts.py:

**Imports:**
- argparse for CLI
- pandas, sqlalchemy
- from ta_lab2.time.dim_timeframe import get_tf_days, list_tfs
- from ta_lab2.config import TARGET_DB_URL

**Core Functions:**

1. **compute_expected_rowcount(start_date, end_date, tf, tf_days)** -> int:
   - Calculate expected canonical closes in date range for given TF
   - For tf_day alignment: (end_date - start_date).days // tf_days + 1
   - Return expected count

2. **get_actual_rowcount(engine, table, schema, id_, tf, period, start_date, end_date)** -> int:
   - Query COUNT(*) from table WHERE id=id_ AND tf=tf AND period=period AND ts BETWEEN start_date AND end_date AND roll=FALSE (canonical only)
   - Return actual count

3. **validate_rowcounts(engine, table, schema, ids, tfs, periods, start_date, end_date, db_url)** -> pd.DataFrame:
   - For each (id, tf, period) combination:
     - Get tf_days from dim_timeframe
     - Compute expected
     - Get actual
     - Calculate diff = actual - expected
     - Status: "OK" if diff == 0, "GAP" if diff < 0, "DUPLICATE" if diff > 0
   - Return DataFrame with columns: id, tf, period, expected, actual, diff, status

4. **main()** CLI:
   - Parse args: --table, --schema, --ids, --tfs, --periods, --start, --end
   - Defaults: table=cmc_ema_multi_tf_u, schema=public
   - Run validation
   - Print summary: total checks, OK count, GAP count, DUPLICATE count
   - Exit code: 0 if all OK, 1 if any issues

**CLI Help:**
```
python validate_ema_rowcounts.py --help
Validate EMA rowcounts against dim_timeframe expectations.

Options:
  --table    EMA table name (default: cmc_ema_multi_tf_u)
  --schema   Schema name (default: public)
  --ids      Comma-separated IDs to check (default: all)
  --tfs      Comma-separated TFs to check (default: all canonical)
  --periods  Comma-separated periods (default: 9,10,20,50)
  --start    Start date YYYY-MM-DD
  --end      End date YYYY-MM-DD
```
  </action>
  <verify>
python -c "from ta_lab2.scripts.emas.validate_ema_rowcounts import compute_expected_rowcount, validate_rowcounts; print('imports OK')"
  </verify>
  <done>
Rowcount validation script created with compute_expected_rowcount, get_actual_rowcount, validate_rowcounts functions and CLI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rowcount validation tests</name>
  <files>tests/time/test_rowcount_validation.py</files>
  <action>
Create tests/time/test_rowcount_validation.py:

**Unit Tests (no database):**
1. **test_compute_expected_1d** - compute_expected_rowcount for 1D TF over 30 days = 30 (approximately)
2. **test_compute_expected_7d** - compute_expected_rowcount for 7D TF over 28 days = 4
3. **test_compute_expected_30d** - compute_expected_rowcount for 30D TF over 90 days = 3
4. **test_compute_expected_edge_case** - Test with date range shorter than tf_days (should be 0 or 1)

**Status Logic Tests:**
5. **test_status_ok** - When actual == expected, status is "OK"
6. **test_status_gap** - When actual < expected, status is "GAP"
7. **test_status_duplicate** - When actual > expected, status is "DUPLICATE"

**Integration Tests (database required):**
8. **test_validate_rowcounts_returns_dataframe** - Call validate_rowcounts with small scope, verify returns DataFrame with expected columns
9. **test_validate_rowcounts_no_crash_on_empty** - Call with non-existent ID, verify no crash (returns empty or zeros)

**CLI Tests:**
10. **test_cli_help** - Run script with --help, verify exits 0 with usage text

Use unittest.mock for database-free tests. Use pytest.mark.skipif for database tests.
  </action>
  <verify>
pytest tests/time/test_rowcount_validation.py -v passes all 10 tests
  </verify>
  <done>
10 tests validating rowcount computation logic and CLI (SUCCESS CRITERION #7)
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/test_rowcount_validation.py -v
2. All 10 tests pass
3. python -m ta_lab2.scripts.emas.validate_ema_rowcounts --help shows usage
4. With database: script reports OK/GAP/DUPLICATE status for EMA data
</verification>

<success_criteria>
- validate_ema_rowcounts.py script created with CLI interface
- compute_expected_rowcount calculates from tf_days
- validate_rowcounts compares actual vs expected per (id, tf, period)
- Tests cover unit logic and integration
- SUCCESS CRITERION #7 satisfied: rowcount validation implemented
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-06-SUMMARY.md`
</output>
