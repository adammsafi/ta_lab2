---
phase: 06-ta-lab2-time-model
plan: 06
type: execute
wave: 3
depends_on:
  - "06-01"
  - "06-02"
files_modified:
  - tests/time/test_rowcount_validation.py
  - src/ta_lab2/scripts/emas/validate_ema_rowcounts.py
  - src/ta_lab2/scripts/emas/run_all_ema_refreshes.py
  - src/ta_lab2/notifications/telegram.py
autonomous: true

must_haves:
  truths:
    - "Running rowcount validation identifies EMA tables with missing or duplicate rows"
    - "Validation errors trigger Telegram alerts with actionable details"
    - "run_all_ema_refreshes.py runs rowcount validation after refresh completes"
    - "Users receive notification when EMA refresh detects data quality issues"
  artifacts:
    - path: "tests/time/test_rowcount_validation.py"
      provides: "Tests for rowcount validation logic"
      min_lines: 50
    - path: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      provides: "CLI script for rowcount validation"
      min_lines: 100
    - path: "src/ta_lab2/notifications/telegram.py"
      provides: "Telegram notification helper for alerts"
      min_lines: 40
  key_links:
    - from: "tests/time/test_rowcount_validation.py"
      to: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      via: "imports validation functions"
      pattern: "from ta_lab2.scripts.emas.validate_ema_rowcounts import"
    - from: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      to: "src/ta_lab2/time/dim_timeframe.py"
      via: "uses get_tf_days for expected count calculation"
      pattern: "from ta_lab2.time.dim_timeframe import"
    - from: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      to: "src/ta_lab2/notifications/telegram.py"
      via: "sends alerts on validation errors"
      pattern: "from ta_lab2.notifications.telegram import"
    - from: "src/ta_lab2/scripts/emas/run_all_ema_refreshes.py"
      to: "src/ta_lab2/scripts/emas/validate_ema_rowcounts.py"
      via: "calls validation after refresh"
      pattern: "validate_ema_rowcounts|validate_rowcounts"
---

<objective>
Create rowcount validation with Telegram alerts and pipeline integration

Purpose: Implement SUCCESS CRITERION #7 - Rowcount validation confirms actual counts match tf-defined expectations. Create validation script and tests that detect gaps and duplicates in EMA data. Integrate with Telegram for alerts (per CONTEXT.md) and wire into run_all_ema_refreshes.py for automated post-refresh validation.

Output: Validation script, Telegram alerting, pipeline integration, and test suite
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# Related infrastructure
@src/ta_lab2/time/dim_timeframe.py
@src/ta_lab2/scripts/emas/audit_ema_expected_coverage.py
@src/ta_lab2/scripts/emas/audit_ema_integrity.py
@src/ta_lab2/scripts/emas/run_all_ema_refreshes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Telegram notification helper</name>
  <files>src/ta_lab2/notifications/__init__.py, src/ta_lab2/notifications/telegram.py</files>
  <action>
Create src/ta_lab2/notifications/__init__.py (empty package file).

Create src/ta_lab2/notifications/telegram.py with Telegram alerting:

**Imports:**
- os, logging, requests (or httpx)
- from typing import Optional

**Configuration:**
- TELEGRAM_BOT_TOKEN: Read from env var TELEGRAM_BOT_TOKEN
- TELEGRAM_CHAT_ID: Read from env var TELEGRAM_CHAT_ID

**Core Functions:**

1. **is_configured()** -> bool:
   - Return True if both TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID are set
   - Return False otherwise (allows graceful degradation)

2. **send_message(text: str, parse_mode: str = "HTML")** -> bool:
   - If not is_configured(): log warning, return False
   - POST to https://api.telegram.org/bot{token}/sendMessage
   - Body: {"chat_id": chat_id, "text": text, "parse_mode": parse_mode}
   - Return True on success (2xx response)
   - Return False on failure (log error with response)

3. **send_alert(title: str, message: str, severity: str = "warning")** -> bool:
   - Format message with emoji prefix based on severity:
     - "critical": RED_CIRCLE + title
     - "warning": YELLOW_CIRCLE + title
     - "info": BLUE_CIRCLE + title
   - Call send_message with formatted text
   - Return result

4. **send_validation_alert(validation_result: dict)** -> bool:
   - Format validation errors for Telegram:
     - Header: "EMA Validation Failed"
     - Summary: gaps count, duplicate count
     - Details: List first 5 issues (truncate if more)
     - Footer: "Run validate_ema_rowcounts.py for full report"
   - Call send_alert with severity based on issue count
   - Return result

**Environment Variables:**
- TELEGRAM_BOT_TOKEN: Bot token from @BotFather
- TELEGRAM_CHAT_ID: Chat ID to send messages to

**Graceful degradation:** If Telegram not configured, log warning and continue (don't fail validation).
  </action>
  <verify>
python -c "from ta_lab2.notifications.telegram import is_configured, send_message, send_alert; print('imports OK')"
  </verify>
  <done>
Telegram notification module created with is_configured, send_message, send_alert, send_validation_alert functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rowcount validation script with Telegram integration</name>
  <files>src/ta_lab2/scripts/emas/validate_ema_rowcounts.py</files>
  <action>
Create src/ta_lab2/scripts/emas/validate_ema_rowcounts.py:

**Imports:**
- argparse for CLI
- pandas, sqlalchemy
- from ta_lab2.time.dim_timeframe import get_tf_days, list_tfs
- from ta_lab2.config import TARGET_DB_URL
- from ta_lab2.notifications.telegram import send_validation_alert, is_configured as telegram_configured

**Core Functions:**

1. **compute_expected_rowcount(start_date, end_date, tf, tf_days)** -> int:
   - Calculate expected canonical closes in date range for given TF
   - For tf_day alignment: (end_date - start_date).days // tf_days + 1
   - Return expected count

2. **get_actual_rowcount(engine, table, schema, id_, tf, period, start_date, end_date)** -> int:
   - Query COUNT(*) from table WHERE id=id_ AND tf=tf AND period=period AND ts BETWEEN start_date AND end_date AND roll=FALSE (canonical only)
   - Return actual count

3. **validate_rowcounts(engine, table, schema, ids, tfs, periods, start_date, end_date, db_url)** -> pd.DataFrame:
   - For each (id, tf, period) combination:
     - Get tf_days from dim_timeframe
     - Compute expected
     - Get actual
     - Calculate diff = actual - expected
     - Status: "OK" if diff == 0, "GAP" if diff < 0, "DUPLICATE" if diff > 0
   - Return DataFrame with columns: id, tf, period, expected, actual, diff, status

4. **summarize_validation(df: pd.DataFrame)** -> dict:
   - Return {"total": N, "ok": N, "gaps": N, "duplicates": N, "issues": list of dicts with details}

5. **main()** CLI:
   - Parse args: --table, --schema, --ids, --tfs, --periods, --start, --end, --alert (enable Telegram alerts)
   - Defaults: table=cmc_ema_multi_tf_u, schema=public
   - Run validation
   - Print summary: total checks, OK count, GAP count, DUPLICATE count
   - If issues AND --alert: call send_validation_alert(summary)
   - Exit code: 0 if all OK, 1 if any issues

**CLI Help:**
```
python validate_ema_rowcounts.py --help
Validate EMA rowcounts against dim_timeframe expectations.

Options:
  --table    EMA table name (default: cmc_ema_multi_tf_u)
  --schema   Schema name (default: public)
  --ids      Comma-separated IDs to check (default: all)
  --tfs      Comma-separated TFs to check (default: all canonical)
  --periods  Comma-separated periods (default: 9,10,20,50)
  --start    Start date YYYY-MM-DD
  --end      End date YYYY-MM-DD
  --alert    Send Telegram alert on validation errors
```
  </action>
  <verify>
python -c "from ta_lab2.scripts.emas.validate_ema_rowcounts import compute_expected_rowcount, validate_rowcounts, summarize_validation; print('imports OK')"
  </verify>
  <done>
Rowcount validation script created with Telegram alerting integration via --alert flag
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire validation into run_all_ema_refreshes.py</name>
  <files>src/ta_lab2/scripts/emas/run_all_ema_refreshes.py</files>
  <action>
Update src/ta_lab2/scripts/emas/run_all_ema_refreshes.py to run rowcount validation after refresh:

**Add to imports:**
- from pathlib import Path

**Add new CLI argument in parse_args():**
- --validate: Run rowcount validation after refresh (default: False)
- --alert-on-validation-error: Send Telegram alert if validation fails (default: False)

**Add new function:**

```python
def run_validation(args, logger) -> bool:
    """Run rowcount validation on unified EMA table."""
    from ta_lab2.scripts.emas.validate_ema_rowcounts import validate_rowcounts, summarize_validation
    from ta_lab2.notifications.telegram import send_validation_alert, is_configured
    from ta_lab2.config import resolve_db_url
    from sqlalchemy import create_engine
    from datetime import datetime

    logger.info("Running post-refresh rowcount validation...")

    db_url = resolve_db_url()
    engine = create_engine(db_url)

    # Use same date range as refresh
    start = args.start
    end = args.end or datetime.now().strftime("%Y-%m-%d")

    # Validate unified table
    df = validate_rowcounts(
        engine=engine,
        table="cmc_ema_multi_tf_u",
        schema="public",
        ids=None,  # all
        tfs=None,  # all canonical
        periods=args.periods.split(",") if args.periods != "lut" else None,
        start_date=start,
        end_date=end,
        db_url=db_url
    )

    summary = summarize_validation(df)

    if summary["gaps"] > 0 or summary["duplicates"] > 0:
        logger.warning(f"Validation found issues: {summary['gaps']} gaps, {summary['duplicates']} duplicates")

        if args.alert_on_validation_error and is_configured():
            send_validation_alert(summary)
            logger.info("Telegram alert sent")

        return False

    logger.info(f"Validation passed: {summary['ok']}/{summary['total']} checks OK")
    return True
```

**Update main():**

After the refresh loop completes successfully, add:

```python
# Run validation if requested
if args.validate:
    validation_passed = run_validation(args, logger)
    if not validation_passed:
        logger.warning("Validation found issues - check logs for details")
        # Don't fail the overall run, just warn
```

**Summary:** This wires rowcount validation into the refresh pipeline. Users can enable with --validate, and optionally get Telegram alerts with --alert-on-validation-error.
  </action>
  <verify>
python -c "from ta_lab2.scripts.emas.run_all_ema_refreshes import main; print('import OK')"
  </verify>
  <done>
run_all_ema_refreshes.py updated with --validate and --alert-on-validation-error flags, runs validation after refresh
  </done>
</task>

<task type="auto">
  <name>Task 4: Create rowcount validation tests</name>
  <files>tests/time/test_rowcount_validation.py</files>
  <action>
Create tests/time/test_rowcount_validation.py:

**Unit Tests (no database):**
1. **test_compute_expected_1d** - compute_expected_rowcount for 1D TF over 30 days = 30 (approximately)
2. **test_compute_expected_7d** - compute_expected_rowcount for 7D TF over 28 days = 4
3. **test_compute_expected_30d** - compute_expected_rowcount for 30D TF over 90 days = 3
4. **test_compute_expected_edge_case** - Test with date range shorter than tf_days (should be 0 or 1)

**Status Logic Tests:**
5. **test_status_ok** - When actual == expected, status is "OK"
6. **test_status_gap** - When actual < expected, status is "GAP"
7. **test_status_duplicate** - When actual > expected, status is "DUPLICATE"

**Summary Tests:**
8. **test_summarize_validation_counts** - Verify summarize_validation returns correct counts

**Telegram Integration Tests (mock):**
9. **test_telegram_alert_not_sent_when_disabled** - Verify alert not sent when --alert not passed
10. **test_telegram_alert_sent_on_issues** - Mock telegram, verify send_validation_alert called when issues found and --alert set

**CLI Tests:**
11. **test_cli_help** - Run script with --help, verify exits 0 with usage text

**Integration Tests (database required):**
12. **test_validate_rowcounts_returns_dataframe** - Call validate_rowcounts with small scope, verify returns DataFrame with expected columns
13. **test_validate_rowcounts_no_crash_on_empty** - Call with non-existent ID, verify no crash (returns empty or zeros)

Use unittest.mock for database-free tests and Telegram mocking. Use pytest.mark.skipif for database tests.
  </action>
  <verify>
pytest tests/time/test_rowcount_validation.py -v passes all 13 tests
  </verify>
  <done>
13 tests validating rowcount computation logic, Telegram integration, and CLI (SUCCESS CRITERION #7)
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/test_rowcount_validation.py -v
2. All 13 tests pass
3. python -m ta_lab2.scripts.emas.validate_ema_rowcounts --help shows usage with --alert flag
4. python -m ta_lab2.scripts.emas.run_all_ema_refreshes --help shows --validate and --alert-on-validation-error flags
5. With database: validation script reports OK/GAP/DUPLICATE status for EMA data
</verification>

<success_criteria>
- validate_ema_rowcounts.py script created with CLI interface and --alert flag
- compute_expected_rowcount calculates from tf_days
- validate_rowcounts compares actual vs expected per (id, tf, period)
- Telegram module sends alerts when validation finds issues
- run_all_ema_refreshes.py runs validation after refresh (when --validate passed)
- Tests cover unit logic, Telegram integration, and database integration
- SUCCESS CRITERION #7 satisfied: rowcount validation implemented with alerting
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-06-SUMMARY.md`
</output>
