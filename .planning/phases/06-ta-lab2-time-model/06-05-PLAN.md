---
phase: 06-ta-lab2-time-model
plan: 05
type: execute
wave: 2
depends_on:
  - "06-02"
files_modified:
  - tests/time/test_incremental_refresh.py
  - tests/time/test_ema_state_manager.py
autonomous: true

must_haves:
  truths:
    - "EMAStateManager creates state table with idempotent upserts"
    - "State tracking per (id, tf, period) enables incremental refresh"
    - "Watermarking prevents reprocessing already-synced data"
    - "compute_dirty_window_starts returns correct incremental boundaries"
  artifacts:
    - path: "tests/time/test_incremental_refresh.py"
      provides: "Integration tests for incremental refresh behavior"
      min_lines: 50
    - path: "tests/time/test_ema_state_manager.py"
      provides: "Unit tests for EMAStateManager class"
      min_lines: 60
  key_links:
    - from: "tests/time/test_ema_state_manager.py"
      to: "src/ta_lab2/scripts/emas/ema_state_manager.py"
      via: "imports EMAStateManager, EMAStateConfig"
      pattern: "from ta_lab2.scripts.emas.ema_state_manager import"
    - from: "tests/time/test_incremental_refresh.py"
      to: "src/ta_lab2/scripts/emas/sync_cmc_ema_multi_tf_u.py"
      via: "tests watermarking behavior"
      pattern: "get_watermark"
---

<objective>
Validate incremental refresh infrastructure

Purpose: Confirm SUCCESS CRITERION #6 - Incremental EMA refresh computes only new rows. Test the EMAStateManager and watermarking logic that enables incremental computation.

Output: Test suite proving state tracking and watermarking work correctly
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-ta-lab2-time-model/06-CONTEXT.md
@.planning/phases/06-ta-lab2-time-model/06-RESEARCH.md

# State management infrastructure
@src/ta_lab2/scripts/emas/ema_state_manager.py
@src/ta_lab2/scripts/emas/sync_cmc_ema_multi_tf_u.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EMAStateManager unit tests</name>
  <files>tests/time/test_ema_state_manager.py</files>
  <action>
Create tests/time/test_ema_state_manager.py with unit tests:

**Configuration Tests:**
1. **test_ema_state_config_defaults** - Verify EMAStateConfig defaults (state_schema="public", state_table="cmc_ema_state", etc.)
2. **test_ema_state_config_custom** - Create config with custom values and verify all fields set

**State Schema Tests:**
3. **test_unified_state_schema_has_pk** - Verify UNIFIED_STATE_SCHEMA string contains PRIMARY KEY (id, tf, period)
4. **test_unified_state_schema_has_timestamps** - Verify schema has daily_min_seen, daily_max_seen, last_time_close, last_canonical_ts columns

**Manager Initialization:**
5. **test_manager_init** - Create EMAStateManager with mock engine and config, verify attributes set
6. **test_manager_repr** - Verify __repr__ returns readable string with table info

**Load State Tests (with mock):**
7. **test_load_state_empty** - Mock pd.read_sql to return empty DataFrame, verify load_state returns empty DataFrame with correct columns
8. **test_load_state_with_filters** - Mock read_sql, call load_state(ids=[1], tfs=["1D"]), verify SQL contains WHERE clauses

**Dirty Window Tests:**
9. **test_compute_dirty_window_no_state** - When load_state returns empty for an ID, dirty window should be default_start
10. **test_compute_dirty_window_with_state** - When load_state has data, dirty window should be based on last_canonical_ts or last_time_close

Use unittest.mock to avoid database dependency. Test logic, not DB integration.
  </action>
  <verify>
pytest tests/time/test_ema_state_manager.py -v passes all 10 tests
  </verify>
  <done>
10 unit tests for EMAStateManager covering config, schema, init, load, and dirty window computation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create incremental refresh integration tests</name>
  <files>tests/time/test_incremental_refresh.py</files>
  <action>
Create tests/time/test_incremental_refresh.py with integration tests:

**State Table Existence (database required):**
1. **test_ema_state_table_exists** - Query information_schema for common state tables (cmc_ema_multi_tf_state, etc.)

**Watermark Tests:**
2. **test_get_watermark_returns_datetime_or_none** - Import get_watermark from sync script, verify returns datetime or None (not crash)
3. **test_watermark_per_alignment_source** - Verify different alignment_sources can have different watermarks

**Idempotency Tests:**
4. **test_sync_idempotent_dry_run** - Run sync with --dry-run twice, verify same candidate counts (demonstrates idempotency detection)

**State Update Tests (database required):**
5. **test_state_has_recent_updated_at** - Query state table and verify some rows have updated_at within last 30 days (proves state is being maintained)
6. **test_state_covers_multiple_ids** - Query state table and verify multiple distinct IDs present
7. **test_state_covers_multiple_tfs** - Query state table and verify multiple distinct TFs present

**Incremental Behavior:**
8. **test_state_watermarks_advance** - Document: After a sync, watermarks should advance (integration test for production monitoring, can be marked as slow)

Use pytest.mark.skipif for database-dependent tests. Use pytest.mark.slow for tests that take time.
  </action>
  <verify>
pytest tests/time/test_incremental_refresh.py -v passes all 8 tests (some may skip without database)
  </verify>
  <done>
8 integration tests validating incremental refresh infrastructure works (SUCCESS CRITERION #6)
  </done>
</task>

</tasks>

<verification>
1. pytest tests/time/test_ema_state_manager.py tests/time/test_incremental_refresh.py -v
2. All 18 tests pass (unit tests always, integration tests with database)
3. Tests confirm state tracking enables incremental computation
</verification>

<success_criteria>
- EMAStateManager unit tests pass without database
- State table exists and has data (when database available)
- Watermarking logic is sound (per alignment_source)
- Dirty window computation returns correct boundaries
- SUCCESS CRITERION #6 satisfied: incremental refresh infrastructure validated
</success_criteria>

<output>
After completion, create `.planning/phases/06-ta-lab2-time-model/06-05-SUMMARY.md`
</output>
