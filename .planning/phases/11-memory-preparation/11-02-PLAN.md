---
phase: 11-memory-preparation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/memory/snapshot/run_ta_lab2_snapshot.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ta_lab2 codebase is fully indexed in memory with pre_reorg_v0.5.0 tag"
    - "Memory queries can find files in ta_lab2 directory"
    - "AST structure (functions, classes) captured for all Python files"
  artifacts:
    - path: "src/ta_lab2/tools/ai_orchestrator/memory/snapshot/run_ta_lab2_snapshot.py"
      provides: "Executable script for ta_lab2 snapshot"
      exports: ["run_ta_lab2_snapshot", "main"]
    - path: ".planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json"
      provides: "Snapshot metadata file"
      contains: "directory_stats"
  key_links:
    - from: "run_ta_lab2_snapshot.py"
      to: "extract_codebase.py"
      via: "extract_directory_tree call"
      pattern: "extract_directory_tree"
    - from: "run_ta_lab2_snapshot.py"
      to: "batch_indexer.py"
      via: "batch_add_memories call"
      pattern: "batch_add_memories"
---

<objective>
Index ta_lab2 codebase into memory system with pre_reorg_v0.5.0 tag as baseline before reorganization.

Purpose: Requirement MEMO-11 requires capturing current state of ta_lab2 before any file moves. This creates the baseline snapshot that will be compared against after v0.5.0 reorganization completes.

Output: All ta_lab2 Python files indexed in Mem0 with structured metadata, plus snapshot manifest file for validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-memory-preparation/11-CONTEXT.md
@.planning/phases/11-memory-preparation/11-RESEARCH.md
@.planning/phases/11-memory-preparation/11-01-SUMMARY.md

# Snapshot infrastructure from Plan 01
@src/ta_lab2/tools/ai_orchestrator/memory/snapshot/extract_codebase.py
@src/ta_lab2/tools/ai_orchestrator/memory/snapshot/batch_indexer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ta_lab2 snapshot script</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/snapshot/run_ta_lab2_snapshot.py
  </files>
  <action>
Create run_ta_lab2_snapshot.py with:

1. Define exclusions list per CONTEXT.md:
   ```python
   EXCLUSIONS = [
       "__pycache__", ".pyc", ".venv", "venv", "env",
       ".git", "dist", "build", "*.egg-info",
       ".csv", ".xlsx", ".json"  # data files
   ]
   ```

2. `run_ta_lab2_snapshot(repo_path: Path, dry_run: bool = False) -> dict`:
   - Get current git commit hash for versioning
   - Call extract_directory_tree() on src/ta_lab2/ directory with exclusions
   - For each file_info, create memory dict:
     - content: format_file_content_for_memory(file_info)
     - metadata: create_snapshot_metadata with:
       - source="pre_reorg_v0.5.0"
       - directory="ta_lab2"
       - file_type="source_code" (or "test" if in tests/)
       - file_path=relative path from repo root
       - function_count, class_count, line_count from file_info
       - commit_hash from git metadata
   - If not dry_run: call batch_add_memories() with client from get_mem0_client()
   - Return stats dict: {total_files, total_functions, total_classes, memories_added, errors}

3. `save_snapshot_manifest(stats: dict, output_path: Path)`:
   - Save JSON file with:
     - snapshot_type: "ta_lab2_pre_reorg"
     - timestamp: ISO format
     - commit_hash: current HEAD
     - directory_stats: stats from run_ta_lab2_snapshot
     - files_indexed: list of file paths
   - Create .planning/phases/11-memory-preparation/snapshots/ if needed

4. `main()` function with CLI:
   - Parse --dry-run flag
   - Configure logging (INFO level)
   - Call run_ta_lab2_snapshot()
   - Call save_snapshot_manifest()
   - Print summary

5. `if __name__ == "__main__": main()`

Use pathlib for paths. Handle Qdrant connection errors gracefully with retry logic.
  </action>
  <verify>
Run dry-run: `python src/ta_lab2/tools/ai_orchestrator/memory/snapshot/run_ta_lab2_snapshot.py --dry-run`
Expected output: Shows file counts without actually adding to memory.
  </verify>
  <done>
run_ta_lab2_snapshot.py exists and dry-run mode shows file discovery working. Script ready for actual execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute ta_lab2 snapshot and validate</name>
  <files>
    .planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json
  </files>
  <action>
Execute the snapshot process:

1. Run the snapshot script (not dry-run):
   ```bash
   python src/ta_lab2/tools/ai_orchestrator/memory/snapshot/run_ta_lab2_snapshot.py
   ```

2. Verify memories were added by querying:
   ```python
   from ta_lab2.tools.ai_orchestrator.memory.mem0_client import get_mem0_client
   client = get_mem0_client()

   # Query for ta_lab2 files
   results = client.search(
       query="Files in ta_lab2 directory",
       user_id="orchestrator",
       limit=20
   )
   print(f"Found {len(results)} memories")

   # Verify tag filtering works
   results_tagged = client.search(
       query="pre_reorg snapshot",
       user_id="orchestrator",
       limit=10
   )
   print(f"Found {len(results_tagged)} tagged memories")
   ```

3. Verify snapshot manifest was created at:
   .planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json

4. Document results:
   - Total files indexed
   - Total functions discovered
   - Total classes discovered
   - Any errors encountered
  </action>
  <verify>
Check manifest exists: `cat .planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json`
Verify memory count increased from baseline 3,763.
Query test: `python -c "from ta_lab2.tools.ai_orchestrator.memory.mem0_client import get_mem0_client; c = get_mem0_client(); print(f'Memory count: {c.memory_count}')"`
  </verify>
  <done>
ta_lab2_snapshot.json exists with file counts. Memory system contains pre_reorg_v0.5.0 tagged memories for ta_lab2. Queries return ta_lab2 files.
  </done>
</task>

</tasks>

<verification>
1. Snapshot manifest exists: `.planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json`
2. Memory count increased from 3,763 baseline
3. Search query "Files in ta_lab2" returns results
4. Search query with pre_reorg filter returns ta_lab2 memories
</verification>

<success_criteria>
- run_ta_lab2_snapshot.py exists and is executable
- ta_lab2_snapshot.json contains complete file inventory
- All ta_lab2 Python files indexed in memory with pre_reorg_v0.5.0 tag
- Memory queries can find specific files by path
- No errors in snapshot process (or errors documented if any)
</success_criteria>

<output>
After completion, create `.planning/phases/11-memory-preparation/11-02-SUMMARY.md`
</output>
