---
phase: 11-memory-preparation
plan: 05
type: execute
wave: 3
depends_on: ["11-02", "11-03", "11-04"]
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/memory/snapshot/validate_coverage.py
  - .planning/phases/11-memory-preparation/validation/coverage_report.json
autonomous: true
user_setup: []

# NOTE: Wave 3 dependency on ALL Wave 2 plans (11-02, 11-03, 11-04) is intentional.
# This plan validates 100% coverage across ALL snapshots. If any Wave 2 plan fails,
# this validation cannot proceed because the coverage check would be incomplete.
# Partial validation is not acceptable per CONTEXT.md "100% files indexed" requirement.

must_haves:
  truths:
    - "Memory queries can answer 'What files exist in directory X?' for all indexed directories"
    - "100% of Python files are queryable in memory (excluding explicit exclusions)"
    - "Coverage validation report documents query success rates"
  artifacts:
    - path: "src/ta_lab2/tools/ai_orchestrator/memory/snapshot/validate_coverage.py"
      provides: "Query-based coverage validation script"
      exports: ["validate_memory_coverage", "run_validation", "main"]
    - path: ".planning/phases/11-memory-preparation/validation/coverage_report.json"
      provides: "Validation results documenting coverage"
      contains: "coverage_percentage"
  key_links:
    - from: "validate_coverage.py"
      to: "mem0_client.py"
      via: "search queries for validation"
      pattern: "client.search"
---

<objective>
Validate 100% memory coverage through query-based testing for all indexed directories.

Purpose: Per CONTEXT.md, validation must prove that memory queries can answer "What files exist in directory X?" for all 5 directories (ta_lab2 + 4 external: Data_Tools, ProjectTT, fredtools2, fedtools2). This is query-based validation, not file counting - we must prove memories are actually queryable.

Output: Coverage validation script and detailed report documenting query success rates for all directories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-memory-preparation/11-CONTEXT.md
@.planning/phases/11-memory-preparation/11-RESEARCH.md
@.planning/phases/11-memory-preparation/11-02-SUMMARY.md
@.planning/phases/11-memory-preparation/11-03-SUMMARY.md
@.planning/phases/11-memory-preparation/11-04-SUMMARY.md

# Snapshot manifests for expected files
@.planning/phases/11-memory-preparation/snapshots/ta_lab2_snapshot.json
@.planning/phases/11-memory-preparation/snapshots/external_dirs_snapshot.json
@.planning/phases/11-memory-preparation/snapshots/conversations_snapshot.json

# Memory client
@src/ta_lab2/tools/ai_orchestrator/memory/mem0_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coverage validation script</name>
  <files>
    src/ta_lab2/tools/ai_orchestrator/memory/snapshot/validate_coverage.py
  </files>
  <action>
Create validate_coverage.py with:

1. `load_snapshot_manifests(snapshots_dir: Path) -> dict`:
   - Load ta_lab2_snapshot.json, external_dirs_snapshot.json, conversations_snapshot.json
   - Extract list of expected files from each
   - Return combined dict: {directory: [file_paths]}

2. `test_directory_inventory_query(client, directory: str) -> dict`:
   - Query: f"List all files in {directory}"
   - Return: {query, results_count, sample_files: [first 5 results]}
   - This tests Success Criteria #5: "Memory queries can answer 'What files exist in directory X?'"

3. `test_function_lookup_query(client, file_path: str) -> dict`:
   - Query: f"Functions in {file_path}"
   - Return: {query, found: bool, results_count}
   - Tests that AST data is queryable

4. `test_tag_filtering_query(client, tag: str) -> dict`:
   - Query: f"pre_reorg snapshot files"
   - Use filter: {"source": {"$eq": tag}}
   - Return: {query, results_count, tag_filter_works: bool}

5. `test_cross_reference_query(client) -> dict`:
   - Query: f"What functions call X?" (pick a common function)
   - Return: {query, results_count}
   - Tests relationship queries

6. `validate_file_coverage(client, expected_files: list[str], sample_size: int = 50) -> dict`:
   - Sample expected_files (up to sample_size for efficiency)
   - For each file, test if it's findable via search query
   - Return: {total: N, found: M, missing: [list], coverage_percentage: float}

7. `validate_memory_coverage(snapshots_dir: Path, sample_size: int = 50) -> dict`:
   - Load manifests
   - Run all validation queries
   - Aggregate results for ALL 5 directories (ta_lab2, Data_Tools, ProjectTT, fredtools2, fedtools2):
     ```python
     {
         "timestamp": ISO,
         "directories": {
             "ta_lab2": {"inventory_query": {...}, "file_coverage": {...}},
             "Data_Tools": {...},
             "ProjectTT": {...},
             "fredtools2": {...},
             "fedtools2": {...}
         },
         "tag_filtering": {...},
         "cross_reference": {...},
         "overall_coverage_percentage": float,
         "success": bool  # True if >= 100% (per CONTEXT.md requirement)
     }
     ```
   - Return full validation report

8. `run_validation(output_path: Path)`:
   - Call validate_memory_coverage()
   - Save report to output_path
   - Print human-readable summary

9. `main()` with CLI

Log each query and result for debugging. Handle search errors gracefully.
  </action>
  <verify>
Run: `python -c "from ta_lab2.tools.ai_orchestrator.memory.snapshot.validate_coverage import validate_memory_coverage; print('Import OK')"`
Dry check: `python src/ta_lab2/tools/ai_orchestrator/memory/snapshot/validate_coverage.py --help` (if argparse used)
  </verify>
  <done>
validate_coverage.py exports validate_memory_coverage, run_validation. Script tests all 5 directories for required query types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute validation and create coverage report</name>
  <files>
    .planning/phases/11-memory-preparation/validation/coverage_report.json
  </files>
  <action>
Execute the validation and document results:

1. Create validation directory:
   ```bash
   mkdir -p .planning/phases/11-memory-preparation/validation
   ```

2. Run validation script:
   ```bash
   python src/ta_lab2/tools/ai_orchestrator/memory/snapshot/validate_coverage.py
   ```

3. Verify coverage_report.json created with:
   - overall_coverage_percentage >= 100% (or documented gaps)
   - Directory inventory queries work for all 5 directories (ta_lab2, Data_Tools, ProjectTT, fredtools2, fedtools2)
   - Tag filtering queries work
   - Function lookup queries work

4. If coverage < 100%, document:
   - Which files are missing
   - Possible reasons (indexing error, excluded file, etc.)
   - Whether gaps are acceptable per CONTEXT.md Claude discretion clause

5. Create summary of validation results:
   - Total memory count (should be > 3,763 baseline)
   - Per-directory file counts (all 5 directories)
   - Query success rates
   - Any concerns or gaps

6. Final verification - test the key Success Criteria query:
   ```python
   from ta_lab2.tools.ai_orchestrator.memory.mem0_client import get_mem0_client
   client = get_mem0_client()

   # This exact query type must work per Success Criteria #5
   for dir_name in ["ta_lab2", "Data_Tools", "ProjectTT", "fredtools2", "fedtools2"]:
       results = client.search(
           query=f"What files exist in {dir_name}?",
           user_id="orchestrator",
           limit=20
       )
       print(f"{dir_name}: {len(results)} files found")
       assert len(results) > 0, f"No files found for {dir_name}!"
   ```
  </action>
  <verify>
Check report exists: `cat .planning/phases/11-memory-preparation/validation/coverage_report.json`
Check success flag: `python -c "import json; r = json.load(open('.planning/phases/11-memory-preparation/validation/coverage_report.json')); print(f'Coverage: {r.get(\"overall_coverage_percentage\", 0)}%, Success: {r.get(\"success\", False)}')"`
  </verify>
  <done>
coverage_report.json exists with validation results for all 5 directories. overall_coverage_percentage documented. Query "What files exist in directory X?" works for all indexed directories.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document final memory state</name>
  <files>
    .planning/phases/11-memory-preparation/MEMORY_STATE.md
  </files>
  <action>
Create MEMORY_STATE.md documenting the complete Phase 11 memory state:

```markdown
# Phase 11: Memory Preparation - Final State

## Memory Statistics

- **Baseline (pre-Phase 11)**: 3,763 memories
- **Post-Phase 11**: {new count}
- **Added by Phase 11**: {difference}

## Snapshots Created

### ta_lab2 (MEMO-11)
- Files indexed: {count}
- Functions discovered: {count}
- Classes discovered: {count}
- Tag: pre_reorg_v0.5.0
- Manifest: snapshots/ta_lab2_snapshot.json

### External Directories (MEMO-12)
| Directory | Files | Functions | Tag |
|-----------|-------|-----------|-----|
| Data_Tools | {X} | {Y} | pre_integration_v0.5.0 |
| ProjectTT | {X} | {Y} | pre_integration_v0.5.0 |
| fredtools2 | {X} | {Y} | pre_integration_v0.5.0 |
| fedtools2 | {X} | {Y} | pre_integration_v0.5.0 |

- Manifest: snapshots/external_dirs_snapshot.json

### Conversation History (MEMO-10)
- Phases covered: 1-10
- Conversations indexed: {count}
- Phase boundaries documented: Yes
- Manifest: snapshots/conversations_snapshot.json

## Validation Results

- **Overall Coverage**: {X}%
- **Query Tests**: {passed}/{total}
- **Success Criteria Met**: {Yes/No}

### Required Queries Working
- [x] "What files exist in ta_lab2?" - {count} results
- [x] "What files exist in Data_Tools?" - {count} results
- [x] "What files exist in ProjectTT?" - {count} results
- [x] "What files exist in fredtools2?" - {count} results
- [x] "What files exist in fedtools2?" - {count} results

## Artifacts

- snapshots/ta_lab2_snapshot.json
- snapshots/external_dirs_snapshot.json
- snapshots/conversations_snapshot.json
- validation/coverage_report.json

## Ready for Phase 12

Memory system now contains pre-reorganization baseline:
1. ta_lab2 codebase captured with pre_reorg_v0.5.0 tag
2. External directories (4) captured with pre_integration_v0.5.0 tag
3. v0.4.0 development context captured from conversations

Phase 12 can proceed with archive foundation.
```

Fill in actual values from snapshot manifests and coverage report.
  </action>
  <verify>
File exists: `cat .planning/phases/11-memory-preparation/MEMORY_STATE.md | head -30`
Values filled in (not placeholder text).
  </verify>
  <done>
MEMORY_STATE.md documents complete Phase 11 memory state with actual statistics for all 5 directories. All requirements (MEMO-10, MEMO-11, MEMO-12) status documented.
  </done>
</task>

</tasks>

<verification>
1. validate_coverage.py exists and runs without errors
2. coverage_report.json exists with success: true (or documented gaps)
3. MEMORY_STATE.md documents complete memory statistics
4. Query "What files exist in directory X?" works for all 5 directories (ta_lab2 + 4 external)
5. All three snapshot manifests referenced and validated
</verification>

<success_criteria>
- validate_coverage.py can run query-based validation on all 5 directories
- coverage_report.json documents >= 100% coverage (or acceptable gaps per CONTEXT.md)
- MEMORY_STATE.md provides complete Phase 11 summary
- All MEMO-10, MEMO-11, MEMO-12 requirements marked complete
- Phase 12 can proceed knowing pre-reorganization baseline exists
</success_criteria>

<output>
After completion, create `.planning/phases/11-memory-preparation/11-05-SUMMARY.md`
</output>
