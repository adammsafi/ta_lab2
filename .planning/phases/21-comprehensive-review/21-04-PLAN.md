---
phase: 21-comprehensive-review
plan: 04
type: execute
wave: 2
depends_on: [21-01, 21-02, 21-03]
files_modified:
  - .planning/phases/21-comprehensive-review/findings/new-asset-guide.md
  - .planning/phases/21-comprehensive-review/deliverables/gap-analysis.md
autonomous: true

must_haves:
  truths:
    - "Step-by-step guide exists for adding a new asset to the pipeline"
    - "Guide covers tables to update, scripts to run, verification steps"
    - "Gap analysis cataloged with severity tiers (CRITICAL/HIGH/MEDIUM/LOW)"
    - "Each gap has impact, evidence, and phase assignment"
    - "Gaps are actionable for Phase 22-24 execution"
  artifacts:
    - path: ".planning/phases/21-comprehensive-review/findings/new-asset-guide.md"
      provides: "Answer to RVWQ-04: How do I add a new asset?"
      contains: "step"
    - path: ".planning/phases/21-comprehensive-review/deliverables/gap-analysis.md"
      provides: "RVWD-04: Severity-tiered gap analysis"
      contains: "CRITICAL"
  key_links:
    - from: "new-asset-guide.md"
      to: "script-inventory.md"
      via: "script references"
      pattern: "refresh_cmc"
    - from: "gap-analysis.md"
      to: "Phase 22|Phase 23|Phase 24"
      via: "phase assignments"
      pattern: "Phase 2[234]"
---

<objective>
Answer RVWQ-04 (How do I add a new asset?) and create Gap Analysis (RVWD-04)

Purpose: Create actionable new asset onboarding guide and prioritized gap analysis for Phase 22-24
Output: new-asset-guide.md and gap-analysis.md
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 20 outputs (gaps identified)
@.planning/phases/20-historical-context/20-CURRENT-STATE.md
@.planning/phases/20-historical-context/20-HISTORICAL-REVIEW.md

# Phase 21 context
@.planning/phases/21-comprehensive-review/21-CONTEXT.md
@.planning/phases/21-comprehensive-review/21-RESEARCH.md

# Prior plan outputs (SUMMARY references)
@.planning/phases/21-comprehensive-review/21-01-SUMMARY.md
@.planning/phases/21-comprehensive-review/21-02-SUMMARY.md
@.planning/phases/21-comprehensive-review/21-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Answer RVWQ-04 - How do I add a new asset?</name>
  <files>.planning/phases/21-comprehensive-review/findings/new-asset-guide.md</files>
  <action>
Create step-by-step guide for adding a new asset (e.g., LTC) to the pipeline.

**Prerequisites:**
Document what must exist before adding a new asset:
- price_histories7 must have data for the asset
- Asset must have an ID in the system

**Step-by-Step Process:**

### Step 1: Verify Source Data
```sql
-- Check if asset exists in price_histories7
SELECT COUNT(*), MIN(ts), MAX(ts)
FROM price_histories7
WHERE id = [NEW_ASSET_ID];
```
Expected: Non-zero count, reasonable date range

### Step 2: Initialize Bar State Tables
For each bar builder, either:
- State auto-initializes on first run (document which scripts do this)
- Or manual state insertion needed (document schema and example INSERT)

### Step 3: Run Bar Builders
List exact commands in order:
```bash
# 1D bars first (foundational)
python refresh_cmc_price_bars_1d.py --ids [NEW_ASSET_ID] --snapshot

# Multi-TF bars (depends on 1D or price_histories7)
python refresh_cmc_price_bars_multi_tf.py --ids [NEW_ASSET_ID] --snapshot

# Calendar variants
python refresh_cmc_price_bars_multi_tf_cal_us.py --ids [NEW_ASSET_ID] --snapshot
python refresh_cmc_price_bars_multi_tf_cal_iso.py --ids [NEW_ASSET_ID] --snapshot
python refresh_cmc_price_bars_multi_tf_cal_anchor_us.py --ids [NEW_ASSET_ID] --snapshot
python refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py --ids [NEW_ASSET_ID] --snapshot
```

### Step 4: Verify Bar Creation
```sql
-- Check bar counts
SELECT COUNT(*), MIN(bar_date), MAX(bar_date)
FROM cmc_price_bars_1d
WHERE id = [NEW_ASSET_ID];

-- Check for quality flags
SELECT is_partial_start, is_partial_end, is_missing_days, COUNT(*)
FROM cmc_price_bars_1d
WHERE id = [NEW_ASSET_ID]
GROUP BY 1, 2, 3;
```

### Step 5: Initialize EMA State
Document EMAStateManager auto-initialization or manual steps.

### Step 6: Run EMA Refreshers
```bash
# v1 EMAs
python refresh_cmc_ema_multi_tf_from_bars.py --ids [NEW_ASSET_ID] --start [DATE]

# v2 EMAs
python refresh_cmc_ema_multi_tf_v2.py --ids [NEW_ASSET_ID] --start [DATE]

# Calendar EMAs
python refresh_cmc_ema_multi_tf_cal_from_bars.py --ids [NEW_ASSET_ID] --scheme us --start [DATE]
python refresh_cmc_ema_multi_tf_cal_from_bars.py --ids [NEW_ASSET_ID] --scheme iso --start [DATE]

# Anchor EMAs
python refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py --ids [NEW_ASSET_ID] --scheme us --start [DATE]
python refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py --ids [NEW_ASSET_ID] --scheme iso --start [DATE]
```

### Step 7: Verify EMA Creation
```sql
-- Check EMA counts by variant
SELECT alignment_source, COUNT(*), MIN(ts), MAX(ts)
FROM cmc_ema_multi_tf_u
WHERE id = [NEW_ASSET_ID]
GROUP BY alignment_source;
```

### Step 8: Validate Data Quality
- Run audit scripts if they exist
- Check for NULL EMAs
- Verify rowcounts match expectations (from dim_timeframe)

**Troubleshooting:**
- If bar builder fails: Check state table, try --snapshot to force rebuild
- If EMA shows NULL: Check bars exist for that period
- If rowcount too low: Check for gaps in source data

**Output Format:**
```markdown
# New Asset Onboarding Guide

## Overview
[Summary of the process: bars first, then EMAs, verify at each step]

## Prerequisites
- Asset exists in price_histories7 with historical data
- Asset ID is known
- Database connection configured

## Step 1: Verify Source Data
[SQL query + expected output]

## Step 2: Initialize Bar State
[Auto-init vs manual, with examples]

## Step 3: Run Bar Builders
[Commands in order with explanations]

## Step 4: Verify Bars
[Verification queries]

## Step 5: Initialize EMA State
[Auto-init vs manual]

## Step 6: Run EMA Refreshers
[Commands in order]

## Step 7: Verify EMAs
[Verification queries]

## Step 8: Data Quality Validation
[Audit script commands or manual checks]

## Troubleshooting
[Common issues and solutions]

## Quick Reference: All Commands
[Single copy-paste block for experienced users]
```
  </action>
  <verify>
- File exists at .planning/phases/21-comprehensive-review/findings/new-asset-guide.md
- Contains numbered steps from source data verification to final validation
- Includes exact commands for all bar builders and EMA refreshers
- Includes verification SQL queries
- Contains troubleshooting section
  </verify>
  <done>
RVWQ-04 answered: Step-by-step new asset guide with exact commands, verification queries, and troubleshooting for complete pipeline onboarding
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Gap Analysis (RVWD-04)</name>
  <files>.planning/phases/21-comprehensive-review/deliverables/gap-analysis.md</files>
  <action>
Synthesize findings from Plans 01-03 into severity-tiered gap analysis.

**Severity Criteria (from 21-CONTEXT.md):**
- **CRITICAL:** Data quality risk OR system reliability threats
  - Could lead to incorrect calculations, silent errors, bad trading signals
  - Could cause crashes, data loss, or inability to run daily refresh
- **HIGH:** Architectural inconsistency, manual workarounds required
  - Violates established patterns
  - Requires manual intervention
  - Blocks scalability
- **MEDIUM:** Code duplication, missing documentation
  - Maintainability issues
  - System functions correctly
- **LOW:** Cosmetic, nice-to-have improvements
  - Doesn't affect correctness or maintainability
  - Quality-of-life improvements

**Gap Sources:**
1. Phase 20 findings (20-CURRENT-STATE.md, 20-HISTORICAL-REVIEW.md)
2. Plan 01 findings (script inventory - inconsistencies found)
3. Plan 02 findings (variant comparison - questions flagged)
4. Plan 03 findings (validation coverage gaps, incremental refresh issues)

**For each gap, document:**
- Title (brief description)
- Severity (CRITICAL/HIGH/MEDIUM/LOW with justification)
- Impact (what could go wrong)
- Evidence (file paths, line numbers, or findings from prior plans)
- Recommendation (what to fix)
- Phase Assignment (22, 23, or 24 based on roadmap)

**Phase Assignment Logic:**
- Phase 22 (Critical Data Quality Fixes): Data source issues, validation gaps, database constraints
- Phase 23 (Reliable Incremental Refresh): State management, orchestration, visibility
- Phase 24 (Pattern Consistency): Code duplication, standardization, cosmetic

**Output Format:**
```markdown
# Gap Analysis: Bars and EMAs

## Executive Summary
- Total gaps identified: N
- CRITICAL: X (address in Phase 22)
- HIGH: Y (address in Phase 22-23)
- MEDIUM: Z (address in Phase 23-24)
- LOW: W (address in Phase 24 or backlog)

## Severity Criteria
[Reproduce criteria from 21-CONTEXT.md]

## CRITICAL Gaps

### GAP-C01: [Title]
**Severity:** CRITICAL
**Justification:** [Why this is CRITICAL - data quality risk or system reliability]
**Impact:** [What could go wrong]
**Evidence:** [From prior plans or source analysis]
**Recommendation:** [What to do]
**Phase:** 22

### GAP-C02: [Title]
...

## HIGH Gaps

### GAP-H01: [Title]
...

## MEDIUM Gaps

### GAP-M01: [Title]
...

## LOW Gaps

### GAP-L01: [Title]
...

## Phase Assignment Summary

### Phase 22: Critical Data Quality Fixes
| Gap ID | Title | Severity |
|--------|-------|----------|
| GAP-C01 | ... | CRITICAL |
| GAP-C02 | ... | CRITICAL |
| GAP-H01 | ... | HIGH |

### Phase 23: Reliable Incremental Refresh
| Gap ID | Title | Severity |
|--------|-------|----------|
| GAP-H02 | ... | HIGH |
| GAP-M01 | ... | MEDIUM |

### Phase 24: Pattern Consistency
| Gap ID | Title | Severity |
|--------|-------|----------|
| GAP-M02 | ... | MEDIUM |
| GAP-L01 | ... | LOW |

## Cross-Reference: Prior Plan Findings
[Reference specific findings from 21-01, 21-02, 21-03 SUMMARYs]
```

**Key gaps to include (from Phase 20):**
1. Bar tables missing NOT NULL constraints (if still true after verification)
2. Bar tables missing OHLC invariant check constraints (if still true)
3. Quality flag semantics undocumented
4. State table schemas vary (document, assess if gap or intentional)
5. No BaseBarBuilder template class
6. Incremental refresh observability low

**Additional gaps from Plan analysis:**
- Look for inconsistencies in script-inventory.md
- Look for validation coverage gaps in validation-points.md
- Look for questions flagged in variant-comparison.md
  </action>
  <verify>
- File exists at .planning/phases/21-comprehensive-review/deliverables/gap-analysis.md
- Contains gaps organized by severity tier (CRITICAL/HIGH/MEDIUM/LOW)
- Each gap has: severity justification, impact, evidence, recommendation, phase assignment
- Phase assignment summary shows which gaps go to Phase 22/23/24
- Cross-references findings from Plans 01-03
  </verify>
  <done>
RVWD-04 complete: Gap analysis with severity tiers, all gaps documented with impact, evidence, recommendations, and phase assignments enabling Phase 22-24 execution
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. new-asset-guide.md provides complete step-by-step onboarding process
2. gap-analysis.md catalogs all gaps with severity tiers and phase assignments
3. Gap analysis is actionable (Phase 22-24 can execute based on it)
4. Cross-references prior plan findings appropriately
</verification>

<success_criteria>
- RVWQ-04 answered: New asset guide with tables, scripts, verification
- RVWD-04 complete: Severity-tiered gap analysis with phase assignments
- Gaps are actionable: Each has clear recommendation and phase assignment
- Phase 22-24 can proceed: Gap analysis provides their requirements
</success_criteria>

<output>
After completion, create `.planning/phases/21-comprehensive-review/21-04-SUMMARY.md`
</output>
