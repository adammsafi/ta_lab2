---
phase: 21-comprehensive-review
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/21-comprehensive-review/findings/ema-variants.md
  - .planning/phases/21-comprehensive-review/deliverables/variant-comparison.md
autonomous: true

must_haves:
  truths:
    - "Each of 6 EMA variants documented with purpose, use cases, and WHY it exists"
    - "Side-by-side comparison covers all dimensions (data source, TF handling, calendar, state)"
    - "Differences between variants are explained, not just listed"
    - "Similar variants flagged as questions, not consolidation recommendations"
  artifacts:
    - path: ".planning/phases/21-comprehensive-review/findings/ema-variants.md"
      provides: "Answer to RVWQ-01: What does each EMA variant do?"
      contains: "v1"
    - path: ".planning/phases/21-comprehensive-review/deliverables/variant-comparison.md"
      provides: "RVWD-03: Side-by-side variant comparison matrix"
      contains: "comparison"
  key_links:
    - from: "ema-variants.md"
      to: "source files"
      via: "line number citations"
      pattern: "lines?\\s+\\d+"
    - from: "variant-comparison.md"
      to: "ema-variants.md"
      via: "variant references"
      pattern: "v1|v2|cal_us|cal_iso|cal_anchor"
---

<objective>
Answer RVWQ-01 (What does each EMA variant do?) and create Variant Comparison Matrix (RVWD-03)

Purpose: Deep-dive into 6 EMA variants documenting WHAT and WHY, then create side-by-side comparison
Output: ema-variants.md (detailed analysis) and variant-comparison.md (comparison matrix)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 20 outputs (already identified variants use bar tables)
@.planning/phases/20-historical-context/20-CURRENT-STATE.md

# Phase 21 context
@.planning/phases/21-comprehensive-review/21-CONTEXT.md
@.planning/phases/21-comprehensive-review/21-RESEARCH.md

# EMA feature modules
@src/ta_lab2/features/m_tf/ema_multi_timeframe.py
@src/ta_lab2/features/m_tf/ema_multi_tf_v2.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor.py
@src/ta_lab2/features/ema.py

# EMA refresh scripts
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_from_bars.py
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_v2.py
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_from_bars.py
@src/ta_lab2/scripts/emas/refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py

# Supporting modules
@src/ta_lab2/scripts/emas/base_ema_refresher.py
@src/ta_lab2/scripts/emas/ema_state_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Answer RVWQ-01 - What does each EMA variant do?</name>
  <files>.planning/phases/21-comprehensive-review/findings/ema-variants.md</files>
  <action>
Deep analysis of each EMA variant to answer: "What does it do? Why does it exist?"

**For each of 6 variants:**

### v1 (ema_multi_timeframe / refresh_cmc_ema_multi_tf_from_bars.py)
1. Read feature module (ema_multi_timeframe.py) completely
2. Read refresh script (refresh_cmc_ema_multi_tf_from_bars.py) completely
3. Document:
   - **Purpose:** What this variant computes (line N: "[quote from docstring]")
   - **Data Source:** Which bars table it reads from (line N)
   - **Timeframe Source:** How it gets TFs - dim_timeframe vs implicit (line N)
   - **Output Table:** Where it writes (line N)
   - **Use Cases:** When would you use this variant?
   - **WHY it exists:** What problem does it solve that others don't?

### v2 (ema_multi_tf_v2 / refresh_cmc_ema_multi_tf_v2.py)
Same analysis. Key question: How does v2 differ from v1? Why both?

### cal_us (ema_multi_tf_cal / refresh_cmc_ema_multi_tf_cal_from_bars.py with scheme=us)
Same analysis. Key question: What is "US calendar alignment"? Why is this needed?

### cal_iso (ema_multi_tf_cal / refresh_cmc_ema_multi_tf_cal_from_bars.py with scheme=iso)
Same analysis. Key question: How does ISO differ from US? When would you choose ISO?

### cal_anchor_us (ema_multi_tf_cal_anchor / refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py with scheme=us)
Same analysis. Key question: What is "anchoring"? Why add anchoring to calendar alignment?

### cal_anchor_iso (ema_multi_tf_cal_anchor / refresh_cmc_ema_multi_tf_cal_anchor_from_bars.py with scheme=iso)
Same analysis. Combine ISO + anchor explanations.

**Document shared infrastructure:**
- BaseEMARefresher: What it provides (state management, CLI, DB connection)
- EMAStateManager: State schema, load/save operations
- compute_ema: Core EMA calculation (shared across all variants)

**Output Format:**
```markdown
# EMA Variants: What Each Does and Why

## Executive Summary
[1-2 paragraph overview of 6 variants and their relationships]

## Variant 1: ema_multi_timeframe (v1)
### Purpose
[What it computes, from docstring line N]

### Data Source
- Bars table: cmc_price_bars_multi_tf (line N: `self.bars_table = ...`)
- Special case: 1D uses cmc_price_bars_1d (line N)

### Timeframe Handling
- Queries dim_timeframe for tf_day family (line N)
- Filters: canonical only, day-label format

### Output
- Writes to: cmc_ema_multi_tf_u with alignment_source='multi_tf' (line N)

### Use Cases
- When you want EMAs computed on pre-persisted multi-TF bars
- When you have a multi-TF bar table already maintained

### WHY It Exists
[Explain the problem it solves, why not just use v2]

[Repeat structure for all 6 variants]

## Shared Infrastructure
### BaseEMARefresher
[Template pattern, what methods it provides]

### EMAStateManager
[State schema, operations]

### compute_ema
[Core calculation, parameters]

## Open Questions
[Flag any similarities that seem redundant, but DO NOT recommend consolidation]
```

**Evidence Standard:** Every claim must cite file path and line number(s).
  </action>
  <verify>
- File exists at .planning/phases/21-comprehensive-review/findings/ema-variants.md
- Contains detailed analysis for all 6 variants (v1, v2, cal_us, cal_iso, cal_anchor_us, cal_anchor_iso)
- Each variant has: Purpose, Data Source, Timeframe Handling, Output, Use Cases, WHY It Exists
- Line number citations throughout
- Shared infrastructure documented
  </verify>
  <done>
RVWQ-01 answered: All 6 EMA variants documented with purpose, data sources, timeframe handling, output, use cases, and WHY each exists, with line number evidence
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Variant Comparison Matrix (RVWD-03)</name>
  <files>.planning/phases/21-comprehensive-review/deliverables/variant-comparison.md</files>
  <action>
Create side-by-side comparison matrix covering all dimensions from 21-CONTEXT.md:
- Data sources
- Calendar/timeframe handling
- Refresh logic
- Code structure patterns

**Comparison Dimensions:**

| Dimension | v1 | v2 | cal_us | cal_iso | cal_anchor_us | cal_anchor_iso |
|-----------|----|----|--------|---------|---------------|----------------|
| **Data Source** | | | | | | |
| Bars table | cmc_price_bars_multi_tf | cmc_price_bars_1d | cmc_price_bars_multi_tf_cal_us | ... | ... | ... |
| 1D handling | cmc_price_bars_1d | cmc_price_bars_1d | N/A | ... | ... | ... |
| **Timeframe Handling** | | | | | | |
| TF source | dim_timeframe query | dim_timeframe query | Implicit from bars | ... | ... | ... |
| TF family | tf_day | tf_day | calendar TFs | ... | ... | ... |
| **Calendar Alignment** | | | | | | |
| Week start | N/A (canonical) | N/A (canonical) | Sunday (US) | Monday (ISO) | Sunday (US) | Monday (ISO) |
| Year anchoring | No | No | No | No | Yes | Yes |
| **Refresh Logic** | | | | | | |
| State manager | EMAStateManager | EMAStateManager | EMAStateManager | ... | ... | ... |
| Incremental | Yes | Yes | Yes | ... | ... | ... |
| Multiprocessing | Yes | Yes | Yes | ... | ... | ... |
| **Output** | | | | | | |
| Target table | cmc_ema_multi_tf_u | cmc_ema_multi_tf_u | cmc_ema_multi_tf_u | ... | ... | ... |
| alignment_source | 'multi_tf' | 'multi_tf_v2' | 'cal_us' | 'cal_iso' | 'cal_anchor_us' | 'cal_anchor_iso' |

**Add narrative for each dimension:**
Explain WHY variants differ on each dimension, not just WHAT differs.

**Key Insights Section:**
- What's shared across all variants (80%+ common: compute_ema, state management, base class)
- What's legitimately different (data source, calendar alignment)
- Questions about similarities (flag but don't recommend merging)

**Output Format:**
```markdown
# EMA Variant Comparison Matrix

## Quick Reference Matrix
[Big comparison table with all dimensions]

## Dimension-by-Dimension Analysis

### Data Sources
[Table + narrative explaining WHY sources differ]
- v1 uses persisted multi-TF bars (reason: ...)
- v2 computes multi-TF synthetically from daily (reason: ...)
- Calendar variants use calendar-aligned bars (reason: ...)

### Timeframe Handling
[Table + narrative]

### Calendar Alignment
[Table + narrative explaining US vs ISO weeks, anchoring]

### Refresh Logic
[Table + narrative - mostly identical, call out any differences]

### Output
[Table + narrative explaining alignment_source discriminator]

## Key Insights

### What's Shared (80%+ common)
- compute_ema: All use same EMA calculation
- EMAStateManager: All use same state tracking
- BaseEMARefresher: All inherit same template

### What's Legitimately Different
- Data source selection
- Calendar alignment semantics
- Timeframe source (dim_timeframe vs implicit)

### Open Questions
[Flag similarities without recommending consolidation]
- "v1 and v2 both use tf_day TFs - is synthetic vs persisted the only difference?"
- "cal_us and cal_iso differ only by week start day - is this justified?"
```

Reference ema-variants.md for detailed evidence.
  </action>
  <verify>
- File exists at .planning/phases/21-comprehensive-review/deliverables/variant-comparison.md
- Contains comparison matrix with all 6 variants
- Covers all dimensions (data source, TF handling, calendar, refresh, output)
- Contains narrative explaining WHY variants differ
- Key insights section identifies shared vs different aspects
- Questions flagged but no consolidation recommendations
  </verify>
  <done>
RVWD-03 complete: Variant comparison matrix with all 6 variants across all dimensions, narrative explaining differences, key insights on shared vs different, questions flagged appropriately
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. ema-variants.md answers RVWQ-01 with detailed analysis of all 6 variants
2. variant-comparison.md provides side-by-side matrix with narrative
3. Both documents cite line numbers as evidence
4. WHY each variant exists is documented (not just WHAT it does)
5. Questions are flagged, but no consolidation recommendations made
</verification>

<success_criteria>
- RVWQ-01 answered: All 6 EMA variants documented with purpose and WHY
- RVWD-03 complete: Side-by-side comparison matrix with all dimensions
- Evidence standard met: Line numbers cited throughout
- Equal weight on WHAT and WHY per 21-CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/21-comprehensive-review/21-02-SUMMARY.md`
</output>
