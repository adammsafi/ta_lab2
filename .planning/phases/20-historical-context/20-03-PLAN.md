---
phase: 20-historical-context
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/20-historical-context/20-CURRENT-STATE.md
autonomous: true

must_haves:
  truths:
    - "Each bar/EMA feature assessed as Works/Unclear/Broken"
    - "Three-tier health criteria applied: Functional + Maintainable + Scalable"
    - "Feature-level granularity (not just script-level)"
    - "Assessment based on code review, not assumptions"
  artifacts:
    - path: ".planning/phases/20-historical-context/20-CURRENT-STATE.md"
      provides: "Feature-level health assessment matrix"
      contains: "## Current State Assessment"
  key_links:
    - from: "src/ta_lab2/scripts/bars/"
      to: "20-CURRENT-STATE.md"
      via: "Code analysis and feature testing"
      pattern: "Status.*Functional.*Maintainable.*Scalable"
---

<objective>
Create current state assessment documenting what works, what's unclear, and what's broken in bar/EMA infrastructure

Purpose: Understand the actual health of each feature component before v0.6.0 changes. This surfaces hidden issues and ensures fixes address real problems, not assumed ones.

Output: .planning/phases/20-historical-context/20-CURRENT-STATE.md with feature-level health matrix and detailed findings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-historical-context/20-CONTEXT.md
@.planning/phases/20-historical-context/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze bar builder scripts and features</name>
  <files>Analysis of src/ta_lab2/scripts/bars/*.py</files>
  <action>
**Analyze bar builder scripts for health assessment:**

**Scripts to analyze:**
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_1d.py
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
- src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py

**For each script, assess these feature components:**

1. **OHLC Calculation**
   - Functional: Does it compute OHLC correctly from price_histories7?
   - Maintainable: Is the logic clear and documented?
   - Scalable: Will it work for 50+ assets?

2. **Gap Detection**
   - Functional: Does it identify missing data/sessions?
   - Maintainable: Is gap logic consistent across scripts?
   - Scalable: Does it handle all edge cases (DST, holidays)?

3. **Quality Flags**
   - Functional: Are quality flags set correctly?
   - Maintainable: Is flag semantics documented?
   - Scalable: Are flags consistent across bar types?

4. **Incremental Refresh**
   - Functional: Does it only process new data?
   - Maintainable: Is state management clear?
   - Scalable: Does it avoid full table scans?

5. **Data Validation**
   - Functional: Are OHLC invariants checked (high >= low)?
   - Maintainable: Is validation logic centralized?
   - Scalable: Does it handle bad data gracefully?

**Health criteria from CONTEXT.md:**
- **Works** = All three: Functional + Maintainable + Scalable
- **Unclear** = Functional but maintenance/scale uncertain (inconsistent, undocumented, untested)
- **Broken** = Functional failure (crashes, wrong results, doesn't run)

**Check code for:**
- Data source (price_histories7 vs bar tables)
- State management pattern (watermarks, last_processed)
- Error handling (what happens on failure?)
- Logging/visibility (can you tell what it did?)
  </action>
  <verify>
- All 6 bar builder scripts analyzed
- Each script has 5 feature components assessed
- Health status (Works/Unclear/Broken) assigned per component
- Evidence noted for each assessment (code line, behavior)
  </verify>
  <done>
Bar builder scripts analyzed with feature-level health assessment including evidence
  </done>
</task>

<task type="auto">
  <name>Task 2: Analyze EMA calculation scripts and features</name>
  <files>Analysis of src/ta_lab2/features/m_tf/*.py and src/ta_lab2/scripts/emas/*.py</files>
  <action>
**Analyze EMA calculators and refresh scripts:**

**Feature modules to analyze:**
- src/ta_lab2/features/m_tf/ema_multi_timeframe.py (v1)
- src/ta_lab2/features/m_tf/ema_multi_tf_v2.py (v2)
- src/ta_lab2/features/m_tf/ema_multi_tf_cal.py (calendar US/ISO)
- src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor.py (anchor US/ISO)
- src/ta_lab2/features/m_tf/base_ema_feature.py (shared base)
- src/ta_lab2/features/m_tf/ema_operations.py (operations)

**Refresh scripts to check:**
- src/ta_lab2/scripts/emas/refresh_cmc_emas.py (main orchestrator)
- Any individual refresh scripts in scripts/emas/

**For each EMA variant, assess these feature components:**

1. **EMA Calculation**
   - Functional: Is EMA math correct?
   - Maintainable: Is formula documented?
   - Scalable: Does it handle all timeframes?

2. **Data Loading**
   - Functional: Does it load correct source data?
   - Maintainable: Is source configurable?
   - Scalable: Does it use bar tables (validated) or price_histories7 (raw)?
   - **CRITICAL**: Check if EMAs use price_histories7 directly (this is the v0.6.0 issue)

3. **Multi-TF Handling**
   - Functional: Does it handle all timeframes correctly?
   - Maintainable: Is TF logic from dim_timeframe?
   - Scalable: Does it avoid hardcoded TF lists?

4. **State Management**
   - Functional: Does incremental refresh work?
   - Maintainable: Is state pattern consistent?
   - Scalable: Does it track per-asset state?

5. **Calendar/Anchor Logic** (for cal variants)
   - Functional: Does ISO/US calendar alignment work?
   - Maintainable: Is calendar logic documented?
   - Scalable: Does anchoring handle year boundaries?

**Check specifically:**
- Data source queries (look for "price_histories" vs "price_bars")
- 6 EMA variants: v1, v2, cal_us, cal_iso, cal_anchor_us, cal_anchor_iso
- State management: Are patterns consistent across variants?
  </action>
  <verify>
- All 6 EMA variants analyzed (v1, v2, cal_us, cal_iso, cal_anchor_us, cal_anchor_iso)
- Data source identified for each variant (price_histories7 or bar tables)
- State management pattern documented per variant
- Health status assigned per component
  </verify>
  <done>
EMA calculation scripts analyzed with feature-level health assessment, data sources identified, state patterns documented
  </done>
</task>

<task type="auto">
  <name>Task 3: Create 20-CURRENT-STATE.md with health matrix and findings</name>
  <files>.planning/phases/20-historical-context/20-CURRENT-STATE.md</files>
  <action>
Create 20-CURRENT-STATE.md with comprehensive health assessment:

```markdown
# Current State Assessment: Bars & EMAs

## Executive Summary
[2-3 paragraphs: overall health status, critical issues, v0.6.0 priorities]

## Health Criteria

**Three-Tier Assessment:**
- **Functional**: Scripts run, data updates, calculations accurate
- **Maintainable**: Code clear, consistent, documented, safe to modify
- **Scalable**: Ready for 50+ assets without major changes

**Status Definitions:**
- **WORKS**: All three criteria met (low risk to modify)
- **UNCLEAR**: Functional but maintenance/scale uncertain (medium risk)
- **BROKEN**: Functional failure (high risk, requires fixing)

## Bar Builders Health Matrix

| Script | OHLC Calc | Gap Detection | Quality Flags | Incr Refresh | Validation | Overall |
|--------|-----------|---------------|---------------|--------------|------------|---------|
| refresh_cmc_price_bars_1d.py | WORKS | UNCLEAR | UNCLEAR | WORKS | WORKS | UNCLEAR |
| refresh_cmc_price_bars_multi_tf.py | ... | ... | ... | ... | ... | ... |
| ... | ... | ... | ... | ... | ... | ... |

### Bar Builder Detailed Findings

<details>
<summary>refresh_cmc_price_bars_1d.py</summary>

**OHLC Calculation: WORKS**
- Evidence: [code line/test reference]
- Notes: [any concerns]

**Gap Detection: UNCLEAR**
- Evidence: [what makes it unclear]
- Notes: [inconsistency description]

[Repeat for each component]

</details>

[Repeat for each script]

## EMA Calculators Health Matrix

| Variant | EMA Calc | Data Loading | Multi-TF | State Mgmt | Cal/Anchor | Overall |
|---------|----------|--------------|----------|------------|------------|---------|
| ema_multi_timeframe (v1) | WORKS | BROKEN* | WORKS | UNCLEAR | N/A | BROKEN |
| ema_multi_tf_v2 | WORKS | BROKEN* | WORKS | UNCLEAR | N/A | BROKEN |
| ema_multi_tf_cal (US) | ... | ... | ... | ... | ... | ... |
| ema_multi_tf_cal (ISO) | ... | ... | ... | ... | ... | ... |
| ema_multi_tf_cal_anchor (US) | ... | ... | ... | ... | ... | ... |
| ema_multi_tf_cal_anchor (ISO) | ... | ... | ... | ... | ... | ... |

*BROKEN: Uses price_histories7 instead of validated bar tables

### EMA Detailed Findings

<details>
<summary>ema_multi_timeframe (v1)</summary>

**EMA Calculation: WORKS**
- Evidence: [formula verification]
- Notes: [math is correct]

**Data Loading: BROKEN**
- Evidence: [line showing price_histories7 usage]
- Notes: Uses raw price_histories7 instead of validated bar tables
- v0.6.0 Fix: Migrate to cmc_price_bars_1d

[Repeat for each component]

</details>

[Repeat for each variant]

## Data Source Analysis

**Critical Finding: EMA Data Sources**

| EMA Variant | Current Source | Should Be | Status |
|-------------|---------------|-----------|--------|
| v1 | price_histories7 | cmc_price_bars_1d | BROKEN |
| v2 | price_histories7 | cmc_price_bars_1d | BROKEN |
| cal_us | price_histories7 | cmc_price_bars_multi_tf_cal_us | BROKEN |
| cal_iso | price_histories7 | cmc_price_bars_multi_tf_cal_iso | BROKEN |
| cal_anchor_us | price_histories7 | cmc_price_bars_multi_tf_cal_anchor_us | BROKEN |
| cal_anchor_iso | price_histories7 | cmc_price_bars_multi_tf_cal_anchor_iso | BROKEN |

## State Management Analysis

**Pattern Consistency:**

| Script/Module | State Pattern | Watermark | Per-Asset | Consistent? |
|---------------|---------------|-----------|-----------|-------------|
| Bar builders | [pattern] | [Y/N] | [Y/N] | [Y/N] |
| EMA v1 | [pattern] | [Y/N] | [Y/N] | [Y/N] |
| EMA v2 | [pattern] | [Y/N] | [Y/N] | [Y/N] |
| ... | ... | ... | ... | ... |

## Critical Issues for v0.6.0

**Priority 1 (BROKEN - must fix):**
1. All 6 EMA variants use price_histories7 instead of validated bar tables
2. [Any other BROKEN items]

**Priority 2 (UNCLEAR - should fix):**
1. Gap detection logic inconsistent across bar builders
2. Quality flag semantics undocumented
3. State management patterns vary across scripts

**Priority 3 (Enhancement):**
1. [Lower priority items]

## Recommendations

1. **Immediate**: Migrate all EMA data loading to bar tables
2. **Phase 22**: [specific v0.6.0 work]
3. **Phase 23**: [orchestration/state work]
4. **Phase 24**: [pattern standardization]
```

**Writing guidelines:**
- Be specific with evidence (code lines, test results)
- Use WORKS/UNCLEAR/BROKEN consistently
- Highlight the critical data source issue prominently
- Connect findings to v0.6.0 phases
  </action>
  <verify>
- File exists: .planning/phases/20-historical-context/20-CURRENT-STATE.md
- Bar builders health matrix complete (6 scripts x 5 components)
- EMA health matrix complete (6 variants x 5 components)
- Data source analysis table shows current vs should-be
- Critical issues section prioritizes v0.6.0 work
  </verify>
  <done>
20-CURRENT-STATE.md created with feature-level health matrices, data source analysis, state management review, and prioritized v0.6.0 recommendations
  </done>
</task>

</tasks>

<verification>
Phase requirement HIST-03 verification:

1. Feature-level assessment: Each component rated Works/Unclear/Broken
2. Three-tier criteria: Functional + Maintainable + Scalable applied
3. Evidence-based: Findings cite code/tests, not assumptions
4. Actionable: Issues prioritized for v0.6.0 phases
</verification>

<success_criteria>
- [ ] 20-CURRENT-STATE.md exists and is non-empty
- [ ] Bar builders health matrix with 6 scripts assessed
- [ ] EMA health matrix with 6 variants assessed
- [ ] Data source analysis showing price_histories7 vs bar tables usage
- [ ] State management patterns documented
- [ ] Critical issues prioritized for v0.6.0
- [ ] Evidence cited for UNCLEAR/BROKEN ratings
</success_criteria>

<output>
After completion, create `.planning/phases/20-historical-context/20-03-SUMMARY.md`
</output>
