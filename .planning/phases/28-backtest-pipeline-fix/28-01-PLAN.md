---
phase: 28-backtest-pipeline-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/scripts/signals/generate_signals_ema.py
  - src/ta_lab2/scripts/signals/generate_signals_atr.py
autonomous: true

must_haves:
  truths:
    - "EMA signal generator writes feature_snapshot as JSONB without psycopg2 'can't adapt type dict' error"
    - "ATR signal generator writes feature_snapshot without pandas AttributeError on pd.io.json.dumps"
    - "Both generators produce signal records that persist to their respective database tables"
  artifacts:
    - path: "src/ta_lab2/scripts/signals/generate_signals_ema.py"
      provides: "EMA signal generator with json.dumps serialization"
      contains: "json.dumps"
    - path: "src/ta_lab2/scripts/signals/generate_signals_atr.py"
      provides: "ATR signal generator with json.dumps serialization"
      contains: "json.dumps"
  key_links:
    - from: "src/ta_lab2/scripts/signals/generate_signals_ema.py"
      to: "cmc_signals_ema_crossover table"
      via: "to_sql with JSON-serialized feature_snapshot"
      pattern: "json\\.dumps"
    - from: "src/ta_lab2/scripts/signals/generate_signals_atr.py"
      to: "cmc_signals_atr_breakout table"
      via: "to_sql with JSON-serialized feature_snapshot"
      pattern: "json\\.dumps"
---

<objective>
Fix feature_snapshot dict serialization in EMA and ATR signal generators so they write to database without errors.

Purpose: The EMA generator passes raw Python dicts to to_sql() causing psycopg2 "can't adapt type 'dict'" errors. The ATR generator calls pd.io.json.dumps() which does not exist in pandas 2.x. The RSI generator already works (has json.dumps). Without these fixes, no signals can be generated for EMA crossover or ATR breakout strategies, blocking the entire backtest pipeline.

Output: Two fixed signal generators that serialize feature_snapshot dicts to JSON strings before database insertion, matching the working RSI generator pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-backtest-pipeline-fix/28-RESEARCH.md

# Working pattern (RSI generator -- already fixed):
# File: src/ta_lab2/scripts/signals/generate_signals_rsi.py lines 487-488
# df_records["feature_snapshot"] = df_records["feature_snapshot"].apply(
#     lambda x: json.dumps(x) if isinstance(x, dict) else x
# )
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix EMA signal generator feature_snapshot serialization</name>
  <files>src/ta_lab2/scripts/signals/generate_signals_ema.py</files>
  <action>
Fix the _write_signals() method in EMASignalGenerator (currently lines 432-455).

The current code has a misleading comment saying "pandas handles this automatically for JSONB" but it does NOT -- psycopg2 cannot adapt Python dicts.

1. Add `import json` at the top of the file (currently missing).

2. In _write_signals(), add JSON serialization BEFORE the to_sql() call. Insert these lines after the docstring, before `records.to_sql(...)`:

```python
# Serialize feature_snapshot dicts to JSON strings for JSONB column
records = records.copy()
records["feature_snapshot"] = records["feature_snapshot"].apply(
    lambda x: json.dumps(x) if isinstance(x, dict) else x
)
```

The method should look like:
```python
def _write_signals(self, records: pd.DataFrame, signal_table: str) -> None:
    """..."""
    # Serialize feature_snapshot dicts to JSON strings for JSONB column
    records = records.copy()
    records["feature_snapshot"] = records["feature_snapshot"].apply(
        lambda x: json.dumps(x) if isinstance(x, dict) else x
    )

    records.to_sql(
        signal_table,
        self.engine,
        schema="public",
        if_exists="append",
        index=False,
        method="multi",
    )
```

Remove the old misleading comment "Convert feature_snapshot dict to JSON (pandas handles this automatically for JSONB)".

Do NOT change anything else in the file -- all other logic (generate_for_ids, _load_features, _generate_signals, _transform_signals_to_records) is correct.
  </action>
  <verify>
Run: `python -c "import json; from ta_lab2.scripts.signals.generate_signals_ema import EMASignalGenerator; print('EMA generator imports OK')"` -- must succeed without ImportError.

Grep the file for `json.dumps` -- must find at least one match.
Grep the file for `pd.io.json` -- must find zero matches.
  </verify>
  <done>EMA generator has json.dumps serialization for feature_snapshot matching the RSI generator pattern. Import statement present. No pd.io.json references.</done>
</task>

<task type="auto">
  <name>Task 2: Fix ATR signal generator feature_snapshot serialization</name>
  <files>src/ta_lab2/scripts/signals/generate_signals_atr.py</files>
  <action>
Fix the _write_signals() method in ATRSignalGenerator (currently lines 497-524).

The current code at line 511-512 uses `pd.io.json.dumps(x)` which does NOT exist in pandas 2.x (raises AttributeError).

1. Add `import json` at the top of the file (currently missing -- the file imports pandas but not json).

2. In _write_signals(), replace the broken pd.io.json.dumps call on line 511-512:

CHANGE FROM:
```python
records["feature_snapshot"] = records["feature_snapshot"].apply(
    lambda x: pd.io.json.dumps(x) if x is not None else None
)
```

CHANGE TO:
```python
records["feature_snapshot"] = records["feature_snapshot"].apply(
    lambda x: json.dumps(x) if isinstance(x, dict) else x
)
```

Using `isinstance(x, dict)` instead of `x is not None` is more defensive (matches the RSI pattern) and handles edge cases where feature_snapshot might already be a string.

Do NOT change anything else in the file -- all other logic is correct.
  </action>
  <verify>
Run: `python -c "import json; from ta_lab2.scripts.signals.generate_signals_atr import ATRSignalGenerator; print('ATR generator imports OK')"` -- must succeed without ImportError.

Grep the file for `json.dumps` -- must find at least one match.
Grep the file for `pd.io.json` -- must find zero matches.
  </verify>
  <done>ATR generator uses json.dumps (stdlib) instead of non-existent pd.io.json.dumps. Import statement present. Serialization pattern matches RSI generator.</done>
</task>

</tasks>

<verification>
After both tasks:
1. All 3 signal generators (RSI, EMA, ATR) use the same `json.dumps` pattern for feature_snapshot serialization
2. `python -c "from ta_lab2.scripts.signals.generate_signals_ema import EMASignalGenerator; from ta_lab2.scripts.signals.generate_signals_atr import ATRSignalGenerator; print('All generators import OK')"` succeeds
3. No references to `pd.io.json` remain in any signal generator file
</verification>

<success_criteria>
- EMA generator _write_signals() serializes feature_snapshot via json.dumps before to_sql()
- ATR generator _write_signals() uses json.dumps instead of pd.io.json.dumps
- Both files have `import json` at the top
- Both files import cleanly without errors
- Pattern is consistent across all 3 generators (RSI already correct)
</success_criteria>

<output>
After completion, create `.planning/phases/28-backtest-pipeline-fix/28-01-SUMMARY.md`
</output>
