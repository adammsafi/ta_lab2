---
phase: 28-backtest-pipeline-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/scripts/backtests/backtest_from_signals.py
autonomous: true

must_haves:
  truths:
    - "Backtest runner extracts trades from vectorbt without TypeError on tz-aware timestamps"
    - "Trade direction column contains 'long'/'short' strings (not NaN from integer mapping)"
    - "Fees are correctly extracted from 'Entry Fees' + 'Exit Fees' columns (not missing 'Fees' column)"
    - "save_backtest_results writes cost_model dict to JSONB without adaptation errors"
  artifacts:
    - path: "src/ta_lab2/scripts/backtests/backtest_from_signals.py"
      provides: "Fixed backtest runner with vectorbt 0.28.1 compatibility"
      contains: "json.dumps"
  key_links:
    - from: "src/ta_lab2/scripts/backtests/backtest_from_signals.py"
      to: "vectorbt Portfolio.trades.records_readable"
      via: "_extract_trades with correct column mapping"
      pattern: "Entry Fees|Exit Fees"
    - from: "src/ta_lab2/scripts/backtests/backtest_from_signals.py"
      to: "cmc_backtest_runs table"
      via: "save_backtest_results with JSON-serialized cost_model"
      pattern: "json\\.dumps.*cost_model"
---

<objective>
Fix 4 vectorbt compatibility bugs in backtest_from_signals.py so the backtest runner works end-to-end with vectorbt 0.28.1.

Purpose: The backtest runner has 4 bugs that prevent it from producing correct results: (1) tz_localize on already-tz-aware timestamps raises TypeError, (2) Direction integer mapping produces NaN because vbt 0.28.1 returns strings, (3) 'Fees' column doesn't exist (correct columns are 'Entry Fees' + 'Exit Fees'), (4) cost_model dict may fail JSONB adaptation in save_backtest_results. Without these fixes, no backtests can run.

Output: A working backtest_from_signals.py that correctly extracts trades from vectorbt and saves results to database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-backtest-pipeline-fix/28-RESEARCH.md

# Source file:
@src/ta_lab2/scripts/backtests/backtest_from_signals.py
@src/ta_lab2/backtests/vbt_runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix _extract_trades vectorbt 0.28.1 compatibility</name>
  <files>src/ta_lab2/scripts/backtests/backtest_from_signals.py</files>
  <action>
Fix 3 bugs in the _extract_trades() method (currently lines 389-443), 1 bug in save_backtest_results(), and add tz-strip for vectorbt compatibility in run_backtest().

**CRITICAL: `import json` is NOT present in this file. Add `import json` after `import logging` at the top of the file (around line 18).** The file currently imports: `from __future__ import annotations`, `dataclass`, `typing`, `uuid`, `logging`, `pandas`, `numpy`, `sqlalchemy`, and some project modules -- but NOT json. Without this addition, `json.dumps(result.cost_model)` will raise NameError at runtime.

**Bug 4 fix -- tz_localize on already-tz-aware timestamps (lines 423-428):**

The current code does:
```python
"entry_ts": pd.to_datetime(trades["Entry Timestamp"]).dt.tz_localize("UTC"),
"exit_ts": pd.to_datetime(trades["Exit Timestamp"]).dt.tz_localize("UTC"),
```

This raises TypeError when timestamps are already tz-aware. Replace with a helper that checks first:

Add a module-level helper function (place it before the SignalBacktester class):
```python
def _ensure_utc(ts_series: pd.Series) -> pd.Series:
    """Ensure timestamp series is UTC-aware, handling both naive and aware inputs."""
    ts = pd.to_datetime(ts_series)
    if ts.dt.tz is None:
        return ts.dt.tz_localize("UTC")
    else:
        return ts.dt.tz_convert("UTC")
```

Then in _extract_trades, change:
```python
"entry_ts": _ensure_utc(trades["Entry Timestamp"]),
"exit_ts": _ensure_utc(trades["Exit Timestamp"]),
```

**Bug 5 fix -- Direction mapping (line 431):**

The current code maps integers: `trades["Direction"].map({0: "long", 1: "short"})`

But vbt 0.28.1 returns string values like 'Long', 'Short' in the Direction column, so the map produces all NaN.

Replace with:
```python
"direction": trades["Direction"].astype(str).str.lower(),
```

This handles both cases: if vbt returns integers, astype(str) converts to '0'/'1' which str.lower() preserves (acceptable fallback), and if vbt returns 'Long'/'Short' strings, str.lower() correctly produces 'long'/'short'.

**Bug 6 fix -- Fees column (lines 436-438):**

The current code tries to access a 'Fees' column that doesn't exist in vbt 0.28.1. The correct columns are 'Entry Fees' and 'Exit Fees'.

Replace:
```python
"fees_paid": trades.get("Fees", 0.0).astype(float)
if "Fees" in trades
else 0.0,
```

With:
```python
"fees_paid": (
    trades["Entry Fees"].astype(float) + trades["Exit Fees"].astype(float)
    if "Entry Fees" in trades.columns and "Exit Fees" in trades.columns
    else trades["Fees"].astype(float) if "Fees" in trades.columns
    else 0.0
),
```

This tries 'Entry Fees' + 'Exit Fees' first (vbt 0.28.1), falls back to 'Fees' (older vbt), falls back to 0.0.

**Bug 7 fix -- cost_model dict in save_backtest_results (line 640):**

In save_backtest_results(), the cost_model dict is passed as a bind parameter to conn.execute(). SQLAlchemy with psycopg2 may fail to adapt a raw dict to JSONB via parameterized queries. Serialize it explicitly:

At line 640 (inside the conn.execute params dict), change:
```python
"cost_model": result.cost_model,  # Dict auto-converted to JSONB
```
To:
```python
"cost_model": json.dumps(result.cost_model),
```

**Tz-strip fix -- strip timezone from prices BEFORE passing to vectorbt:**

In the `run_backtest()` method (around line 279, after `prices = self.load_prices(...)` and the empty check), add tz-strip logic that strips timezone from the price index and signal indices BEFORE they are passed to `run_vbt_on_split()`. This is critical because `run_vbt_on_split` in `vbt_runner.py` passes the price index directly to `vbt.Portfolio.from_signals`, and tz-aware indices can cause vectorbt internal failures.

Add after line 282 (after `if prices.empty: raise ...`):
```python
# Strip timezone for vectorbt compatibility
# (timestamps re-localized in _extract_trades via _ensure_utc)
if prices.index.tz is not None:
    prices = prices.copy()
    prices.index = prices.index.tz_localize(None)
if entries.index.tz is not None:
    entries = entries.copy()
    entries.index = entries.index.tz_localize(None)
if exits.index.tz is not None:
    exits = exits.copy()
    exits.index = exits.index.tz_localize(None)
```

This tz-strip happens early in run_backtest(), BEFORE both `run_vbt_on_split()` (line 292) and `_build_portfolio()` (line 313). Since both functions receive the same `prices`, `entries`, `exits` variables, stripping once here fixes both call paths. The `_build_portfolio` method therefore does NOT need its own tz-strip logic.
  </action>
  <verify>
Run: `python -c "import json; from ta_lab2.scripts.backtests.backtest_from_signals import SignalBacktester, _ensure_utc; print('Backtest module imports OK')"` -- must succeed.

Grep the file for `^import json` -- must find exactly one match (confirms import was added, not just referenced in a string).
Grep the file for `pd.io.json` -- must find zero matches.
Grep the file for `_ensure_utc` -- must find the helper definition and its usage.
Grep the file for `Entry Fees` -- must find the fee extraction logic.
Grep the file for `str.lower` -- must find the direction mapping.
Grep the file for `json.dumps` -- must find the cost_model serialization.
Grep the file for `tz_localize(None)` -- must find the tz-strip logic in run_backtest().
  </verify>
  <done>
All 4 vectorbt compatibility bugs fixed plus tz-strip:
1. _ensure_utc helper handles both naive and aware timestamps without TypeError
2. Direction mapping uses str.lower() to handle vbt 0.28.1 string values
3. Fees extracted from 'Entry Fees' + 'Exit Fees' with backward compatibility
4. cost_model serialized via json.dumps before parameterized INSERT (import json added at top of file)
5. Tz-strip applied to prices/entries/exits in run_backtest() before both run_vbt_on_split and _build_portfolio
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `python -c "from ta_lab2.scripts.backtests import SignalBacktester; print('OK')"` succeeds
2. No references to `{0: 'long', 1: 'short'}` remain
3. _ensure_utc helper exists and is used for both entry_ts and exit_ts
4. cost_model uses json.dumps for serialization
5. `import json` is present at the top-level imports (not buried in a conditional or function)
6. Tz-strip in run_backtest() protects both run_vbt_on_split and _build_portfolio call paths
</verification>

<success_criteria>
- `import json` present at top of file (after `import logging`)
- _extract_trades handles both tz-naive and tz-aware timestamps from vectorbt
- Direction column correctly maps vbt 0.28.1 string values ('Long'/'Short') to lowercase
- Fees extracted from correct vbt 0.28.1 columns with backward compatibility fallback
- save_backtest_results serializes cost_model dict via json.dumps
- Tz-strip applied in run_backtest() before prices/entries/exits reach vectorbt
- File imports cleanly without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-backtest-pipeline-fix/28-02-SUMMARY.md`
</output>
