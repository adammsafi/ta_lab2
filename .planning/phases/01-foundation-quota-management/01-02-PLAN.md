---
phase: 01-foundation-quota-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/tools/ai_orchestrator/quota.py
  - src/ta_lab2/tools/ai_orchestrator/persistence.py
  - tests/orchestrator/test_quota.py
autonomous: true

must_haves:
  truths:
    - "Quota usage persists across orchestrator restarts"
    - "System alerts at 50%, 80%, 90% quota thresholds"
    - "Daily summary reports total usage and remaining quota"
    - "Quota resets correctly at UTC midnight"
    - "Quota can be reserved before task execution to prevent over-allocation"
  artifacts:
    - path: "src/ta_lab2/tools/ai_orchestrator/quota.py"
      provides: "Enhanced quota tracking with alerts, persistence, reservation"
      exports: ["QuotaTracker", "QuotaLimit", "QuotaAlert"]
      min_lines: 150
    - path: "src/ta_lab2/tools/ai_orchestrator/persistence.py"
      provides: "JSON file persistence for quota state"
      exports: ["QuotaPersistence", "load_quota_state", "save_quota_state"]
    - path: "tests/orchestrator/test_quota.py"
      provides: "Comprehensive quota tests including UTC reset, alerts, reservation"
      min_lines: 100
  key_links:
    - from: "src/ta_lab2/tools/ai_orchestrator/quota.py"
      to: "src/ta_lab2/tools/ai_orchestrator/persistence.py"
      via: "save/load on usage changes"
      pattern: "save_quota_state|load_quota_state"
    - from: "src/ta_lab2/tools/ai_orchestrator/quota.py"
      to: "console/logging"
      via: "threshold alert callbacks"
      pattern: "on_threshold_alert|callback"
---

<objective>
Enhance the existing quota tracking system with persistence, threshold alerts, daily summaries, and reservation capability.

Purpose: ORCH-05 requires robust quota management for Gemini's 1500/day limit. The existing quota.py has basic tracking but lacks persistence (resets on restart), alerts, and reservation (for parallel execution).

Output:
- Enhanced quota.py with full ORCH-05 requirements
- New persistence.py for state storage
- Comprehensive test suite proving all quota behaviors
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-quota-management/01-CONTEXT.md
@src/ta_lab2/tools/ai_orchestrator/quota.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quota persistence module</name>
  <files>src/ta_lab2/tools/ai_orchestrator/persistence.py</files>
  <action>
Create persistence.py that handles quota state storage:

1. Define QuotaState dataclass:
   - limits: dict[str, dict] (serialized QuotaLimit data)
   - last_updated: datetime
   - version: str = "1.0"

2. Implement QuotaPersistence class:
   - __init__(self, storage_path: str = "./.memory/quota_state.json")
   - load() -> Optional[QuotaState]: Load from JSON file, return None if not exists
   - save(state: QuotaState): Write to JSON file atomically (write to .tmp then rename)
   - clear(): Delete state file (for testing)

3. Implement module functions:
   - load_quota_state(path: str = None) -> Optional[QuotaState]
   - save_quota_state(state: QuotaState, path: str = None)

Handle edge cases:
- File doesn't exist (return None, don't error)
- Corrupted JSON (log warning, return None)
- Permission errors (raise with clear message)
- Atomic writes (prevent corruption on crash)

Storage path should use .memory/ directory (already exists in project).
  </action>
  <verify>
Run: `python -c "from ta_lab2.tools.ai_orchestrator.persistence import QuotaPersistence; p = QuotaPersistence(); print('Persistence OK')"`
  </verify>
  <done>Quota state persists to JSON file and loads on restart</done>
</task>

<task type="auto">
  <name>Task 2: Enhance QuotaTracker with alerts, persistence, reservation</name>
  <files>src/ta_lab2/tools/ai_orchestrator/quota.py</files>
  <action>
Enhance the existing quota.py with these additions (preserve existing API):

1. Add QuotaAlert dataclass:
   - platform: str
   - threshold: int (50, 80, 90)
   - current_usage: int
   - limit: int
   - message: str
   - timestamp: datetime

2. Enhance QuotaTracker.__init__():
   - Add alert_thresholds: list[int] = [50, 80, 90] parameter
   - Add on_alert: Optional[Callable[[QuotaAlert], None]] = None callback
   - Add persistence_path: Optional[str] = "./.memory/quota_state.json"
   - Load existing state from persistence on init

3. Add reservation system:
   - reserve(platform: str, amount: int = 1) -> bool: Lock quota before use
   - release(platform: str, amount: int = 1): Release unused reservation
   - reserved: dict[str, int] tracking reserved but not yet used

4. Enhance record_usage():
   - Persist state after each update
   - Check thresholds and call on_alert if crossed
   - Release any matching reservation

5. Add get_daily_summary() -> dict:
   - Returns {platform: {used, limit, remaining, percent_used, alerts_triggered}}
   - Formatted for CLI display

6. Add display_status() -> str:
   - Returns formatted multi-line string for CLI output
   - Shows all platforms, usage bars, reset time

7. Ensure UTC midnight reset works correctly:
   - Check resets_at on every can_use() and record_usage() call
   - Reset used counter and persist when date changes

IMPORTANT: Preserve backward compatibility with existing QuotaTracker API.
  </action>
  <verify>
Run existing imports still work: `python -c "from ta_lab2.tools.ai_orchestrator import QuotaTracker; q = QuotaTracker(); print(q.get_status())"`
  </verify>
  <done>QuotaTracker has persistence, alerts at 50/80/90%, reservation system, and daily summary</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive quota tests</name>
  <files>tests/orchestrator/test_quota.py</files>
  <action>
Create test_quota.py with comprehensive tests:

1. Test fixtures:
   - temp_storage_path: pytest fixture for isolated test storage
   - clean_quota: fixture that returns fresh QuotaTracker with temp storage

2. Test UTC midnight reset:
   - test_quota_resets_at_utc_midnight(): Mock datetime to verify reset
   - test_quota_does_not_reset_before_midnight(): Verify no premature reset
   - test_quota_persists_after_reset(): Verify new day starts fresh

3. Test threshold alerts:
   - test_alert_at_50_percent(): Verify callback fires at 750/1500
   - test_alert_at_80_percent(): Verify callback fires at 1200/1500
   - test_alert_at_90_percent(): Verify callback fires at 1350/1500
   - test_no_duplicate_alerts(): Same threshold doesn't alert twice

4. Test persistence:
   - test_quota_persists_across_restart(): Save, recreate, verify state
   - test_corrupted_file_handled(): Bad JSON doesn't crash
   - test_missing_file_handled(): No file = fresh state

5. Test reservation:
   - test_reserve_blocks_quota(): Reserved quota not available
   - test_release_frees_quota(): Released quota becomes available
   - test_record_usage_releases_reservation(): Using reserved quota works
   - test_cannot_reserve_beyond_limit(): Reservation respects limits

6. Test daily summary:
   - test_daily_summary_format(): Verify structure
   - test_daily_summary_after_usage(): Accurate counts

Create tests/orchestrator/__init__.py if directory doesn't exist.
  </action>
  <verify>
Run: `pytest tests/orchestrator/test_quota.py -v` - all tests pass
  </verify>
  <done>All quota behaviors (reset, alerts, persistence, reservation) have passing tests</done>
</task>

</tasks>

<verification>
1. `python -c "from ta_lab2.tools.ai_orchestrator import QuotaTracker"` still works (backward compatible)
2. `pytest tests/orchestrator/test_quota.py -v` passes all tests
3. Quota state file appears in .memory/ after recording usage
4. Alert callback fires when crossing 50%, 80%, 90% thresholds
5. Quota resets at UTC midnight (verify with mocked datetime test)
</verification>

<success_criteria>
- ORCH-05 fully implemented: 1500/day Gemini quota with UTC midnight reset
- Quota persists across orchestrator restarts
- Threshold alerts work at 50%, 80%, 90%
- Reservation system prevents over-allocation in parallel execution
- Daily summary available for monitoring
- All existing QuotaTracker API preserved
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-quota-management/01-02-SUMMARY.md`
</output>
