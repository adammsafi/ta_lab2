---
phase: 15-economic-data-strategy
plan: 05
type: execute
wave: 3
depends_on: ["15-03", "15-04"]
files_modified:
  - pyproject.toml
  - economic_data.env.example
  - docs/migration/ECONOMIC_DATA.md
  - src/ta_lab2/integrations/economic/migration_tool.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "pyproject.toml has [fred], [fed], [economic] optional dependency extras"
    - "economic_data.env.example documents required API keys"
    - "Migration README guides users from old packages to new integrations"
    - "Migration tool scans code for old package imports"
  artifacts:
    - path: "pyproject.toml"
      provides: "Updated with economic optional dependencies"
      contains: "[fred]"
    - path: "economic_data.env.example"
      provides: "Template for API key configuration"
      contains: "FRED_API_KEY"
    - path: "docs/migration/ECONOMIC_DATA.md"
      provides: "Migration guide from old packages"
    - path: "src/ta_lab2/integrations/economic/migration_tool.py"
      provides: "Tool to scan code and suggest replacements"
      contains: "def scan_for_old_imports"
  key_links:
    - from: "pyproject.toml"
      to: "fredapi"
      via: "optional dependency"
      pattern: 'fred = \\["fredapi'
---

<objective>
Update pyproject.toml with optional dependencies, create config files, and migration support

Purpose: Complete the integration skeleton with proper packaging ([fred], [fed], [economic] extras), configuration templates (economic_data.env.example following db_config.env pattern), and comprehensive migration support (README guide, deprecation warnings concept, interactive migration tool that scans for old imports).

Output: Updated pyproject.toml, config template, migration documentation, and working migration tool.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-economic-data-strategy/15-CONTEXT.md

# Existing pyproject.toml pattern
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pyproject.toml with economic optional dependencies</name>
  <files>pyproject.toml</files>
  <action>
Update pyproject.toml to add [fred], [fed], [economic] optional dependency extras.

Add these entries to the [project.optional-dependencies] section:

```toml
# Economic data integration (FRED)
fred = [
  "fredapi>=0.5.2",
]

# Economic data integration (Fed - future)
# Currently empty, placeholder for fedfred or other Fed-specific packages
fed = [
  # "fedfred>=1.0",  # Uncomment when Fed provider implemented
]

# All economic data providers combined
economic = [
  "fredapi>=0.5.2",
  # "fedfred>=1.0",  # Uncomment when Fed provider implemented
]
```

Also update the [all] group to include fredapi:

```toml
all = [
  # ... existing dependencies ...
  "fredapi>=0.5.2",
]
```

Preserve all existing dependencies and formatting. Place economic dependencies after the existing groups (docs) but before [all].

The resulting structure should be:
1. dev
2. viz
3. astro
4. orchestrator
5. docs
6. fred (new)
7. fed (new)
8. economic (new)
9. all (updated)
  </action>
  <verify>
Run: `python -c "import tomllib; t=tomllib.load(open('pyproject.toml','rb')); print('fred' in t['project']['optional-dependencies']); print('economic' in t['project']['optional-dependencies'])"` shows True, True
  </verify>
  <done>pyproject.toml updated with [fred], [fed], [economic] optional dependency extras</done>
</task>

<task type="auto">
  <name>Task 2: Create economic_data.env.example configuration template</name>
  <files>economic_data.env.example</files>
  <action>
Create economic_data.env.example following the db_config.env pattern:

```env
# Economic Data API Configuration
# Copy this file to economic_data.env and fill in your API keys
#
# This file is used by ta_lab2.integrations.economic providers
# See: src/ta_lab2/integrations/economic/README.md

# ============================================
# FRED API (Federal Reserve Economic Data)
# ============================================
# Get your free API key at: https://fred.stlouisfed.org/docs/api/api_key.html
# Required for: FredProvider, get_series, search, etc.
FRED_API_KEY=your_fred_api_key_here

# ============================================
# Fed API (Future - not yet implemented)
# ============================================
# Placeholder for future Fed data provider
# FED_API_KEY=your_fed_api_key_here

# ============================================
# Cache Configuration (Optional)
# ============================================
# TTL in seconds for cached API responses (default: 3600 = 1 hour)
ECONOMIC_CACHE_TTL=3600

# Maximum cache entries (default: 1000)
ECONOMIC_CACHE_MAX_SIZE=1000

# ============================================
# Rate Limiting (Optional)
# ============================================
# Maximum requests per minute (default: 120 for FRED)
FRED_RATE_LIMIT=120

# ============================================
# Circuit Breaker (Optional)
# ============================================
# Failures before circuit opens (default: 5)
ECONOMIC_CIRCUIT_FAILURE_THRESHOLD=5

# Seconds before attempting recovery (default: 60)
ECONOMIC_CIRCUIT_RECOVERY_TIMEOUT=60

# ============================================
# Data Quality (Optional)
# ============================================
# Maximum null percentage before warning (default: 0.05 = 5%)
ECONOMIC_QUALITY_NULL_THRESHOLD=0.05

# IQR multiplier for outlier detection (default: 3.0)
ECONOMIC_QUALITY_OUTLIER_IQR=3.0

# ============================================
# Usage
# ============================================
# Option 1: Load via python-dotenv
#   from dotenv import load_dotenv
#   load_dotenv("economic_data.env")
#
# Option 2: Set environment variables directly
#   export FRED_API_KEY=your_key
#
# Option 3: Pass directly to provider
#   provider = FredProvider(api_key="your_key")
```
  </action>
  <verify>
Run: `Test-Path economic_data.env.example` returns True
Run: `Select-String -Path "economic_data.env.example" -Pattern "FRED_API_KEY" | Measure-Object | Select-Object -ExpandProperty Count` shows >= 1
  </verify>
  <done>economic_data.env.example created with comprehensive configuration template</done>
</task>

<task type="auto">
  <name>Task 3: Create migration documentation and tool</name>
  <files>
docs/migration/ECONOMIC_DATA.md
src/ta_lab2/integrations/economic/migration_tool.py
  </files>
  <action>
Create docs/migration/ directory and ECONOMIC_DATA.md migration guide:

```markdown
# Economic Data Migration Guide

This guide helps migrate from archived `fredtools2`/`fedtools2` packages to the new `ta_lab2.integrations.economic` module.

## Quick Migration

### Before (fredtools2)
```python
from fredtools2.config import fred_api_key
from fredtools2 import fred_api as client

api = fred_api_key()
obs = client.get_series_observations(api, "FEDFUNDS")
```

### After (ta_lab2.integrations.economic)
```python
from ta_lab2.integrations.economic import FredProvider

provider = FredProvider()  # Uses FRED_API_KEY env var
result = provider.get_series("FEDFUNDS")
if result.success:
    data = result.series.data  # pandas Series
```

## Installation

```bash
# Install FRED integration
pip install ta_lab2[fred]

# Or install all economic integrations
pip install ta_lab2[economic]
```

## Configuration

1. Get a FRED API key: https://fred.stlouisfed.org/docs/api/api_key.html
2. Copy `economic_data.env.example` to `economic_data.env`
3. Add your API key

```bash
cp economic_data.env.example economic_data.env
# Edit economic_data.env and set FRED_API_KEY
```

## Migration Mapping

| Old Import | New Import |
|------------|------------|
| `from fredtools2.config import fred_api_key` | `os.getenv("FRED_API_KEY")` |
| `from fredtools2 import fred_api` | `from ta_lab2.integrations.economic import FredProvider` |
| `from fedtools2.etl import build_dataset` | `from ta_lab2.utils.economic import combine_timeframes` |
| `from fedtools2.utils.consolidation import combine_timeframes` | `from ta_lab2.utils.economic import combine_timeframes` |

## Feature Comparison

| Feature | fredtools2 | ta_lab2.integrations.economic |
|---------|------------|-------------------------------|
| Series fetch | Yes | Yes |
| Search | No | Yes |
| Metadata | Limited | Full |
| Caching | No | Yes (TTL) |
| Rate limiting | No | Yes (120/min) |
| Circuit breaker | No | Yes |
| Data quality | No | Yes |
| Type hints | Partial | Full |
| Documentation | Minimal | Comprehensive |

## Detailed Examples

### Fetching a Single Series

```python
from ta_lab2.integrations.economic import FredProvider

provider = FredProvider()

# Basic fetch
result = provider.get_series("UNRATE")
if result.success:
    series = result.series
    print(f"Unemployment Rate: {series.data.iloc[-1]:.1f}%")
    print(f"Last updated: {series.last_updated}")
```

### Fetching Multiple Series

```python
# Fetch multiple series
series_ids = ["FEDFUNDS", "DGS10", "DGS2", "UNRATE"]
results = provider.get_multiple_series(series_ids)

for result in results:
    if result.success:
        print(f"{result.series.series_id}: {result.series.data.iloc[-1]:.2f}")
```

### Using Extracted Utilities

```python
from ta_lab2.utils.economic import combine_timeframes, missing_ranges
import pandas as pd

# Combine multiple time series
df1 = pd.DataFrame({"date": ["2024-01-01"], "value": [100]})
df2 = pd.DataFrame({"date": ["2024-01-01", "2024-01-02"], "value": [200, 201]})

merged = combine_timeframes([df1, df2], ["series1", "series2"])
print(merged.columns)  # ['series1_value', 'has_series1', 'series2_value', 'has_series2']

# Detect gaps
gaps = missing_ranges(merged["has_series1"] == False)
for start, end in gaps:
    print(f"Gap: {start} to {end}")
```

## Migration Tool

Use the migration tool to scan your code for old imports:

```bash
python -m ta_lab2.integrations.economic.migration_tool /path/to/your/code
```

This will identify files using old `fredtools2`/`fedtools2` imports and suggest replacements.

## Archived Packages

The original packages are preserved in `.archive/external-packages/2026-02-03/`:
- `fredtools2/` - Original FRED API wrapper
- `fedtools2/` - Original Fed data ETL
- `ALTERNATIVES.md` - Ecosystem comparison
- `manifest.json` - File inventory with checksums

See `ALTERNATIVES.md` for detailed comparison with ecosystem alternatives (fredapi, fedfred).

## Support

- Issues: Open a GitHub issue
- Questions: Check the codebase or contact the maintainer
```

Create migration_tool.py:

```python
"""Migration tool for detecting old economic package imports.

Scans Python files for imports from archived fredtools2/fedtools2 packages
and suggests replacements with ta_lab2.integrations.economic.

Usage:
    python -m ta_lab2.integrations.economic.migration_tool /path/to/code
    python -m ta_lab2.integrations.economic.migration_tool .  # Current directory
"""
import argparse
import ast
import sys
from dataclasses import dataclass
from pathlib import Path
from typing import List, Optional, Set


@dataclass
class ImportIssue:
    """An import that needs migration."""
    file_path: Path
    line_number: int
    import_text: str
    old_module: str
    suggested_replacement: str


# Mapping of old imports to new imports
MIGRATION_MAP = {
    # fredtools2 imports
    "fredtools2": "ta_lab2.integrations.economic",
    "fredtools2.config": "os (use os.getenv('FRED_API_KEY'))",
    "fredtools2.fred_api": "ta_lab2.integrations.economic.FredProvider",
    "fredtools2.db": "sqlalchemy or pandas.to_sql",
    "fredtools2.jobs.releases": "ta_lab2.integrations.economic.FredProvider.get_releases",
    "fredtools2.jobs.series": "ta_lab2.integrations.economic.FredProvider.get_series",

    # fedtools2 imports
    "fedtools2": "ta_lab2.utils.economic",
    "fedtools2.etl": "ta_lab2.utils.economic (extract TARGET_MID logic manually)",
    "fedtools2.utils.consolidation": "ta_lab2.utils.economic.combine_timeframes",
    "fedtools2.utils.io": "ta_lab2.utils.economic.read_csv, ensure_dir",
    "fedtools2.sql_sink_example": "pandas.to_sql or sqlalchemy",
}


def scan_file_for_imports(file_path: Path) -> List[ImportIssue]:
    """Scan a Python file for old package imports.

    Args:
        file_path: Path to Python file

    Returns:
        List of ImportIssue objects for problematic imports
    """
    issues = []

    try:
        content = file_path.read_text(encoding="utf-8")
        tree = ast.parse(content)
    except (SyntaxError, UnicodeDecodeError) as e:
        # Skip files that can't be parsed
        return issues

    for node in ast.walk(tree):
        # Check import statements: import fredtools2
        if isinstance(node, ast.Import):
            for alias in node.names:
                module_name = alias.name
                if module_name.startswith(("fredtools2", "fedtools2")):
                    replacement = _get_replacement(module_name)
                    issues.append(ImportIssue(
                        file_path=file_path,
                        line_number=node.lineno,
                        import_text=f"import {module_name}",
                        old_module=module_name,
                        suggested_replacement=replacement,
                    ))

        # Check from imports: from fredtools2 import ...
        elif isinstance(node, ast.ImportFrom):
            if node.module and node.module.startswith(("fredtools2", "fedtools2")):
                module_name = node.module
                replacement = _get_replacement(module_name)
                names = ", ".join(alias.name for alias in node.names)
                issues.append(ImportIssue(
                    file_path=file_path,
                    line_number=node.lineno,
                    import_text=f"from {module_name} import {names}",
                    old_module=module_name,
                    suggested_replacement=replacement,
                ))

    return issues


def _get_replacement(module_name: str) -> str:
    """Get suggested replacement for an old module."""
    # Check exact match first
    if module_name in MIGRATION_MAP:
        return MIGRATION_MAP[module_name]

    # Check prefix matches
    for old, new in MIGRATION_MAP.items():
        if module_name.startswith(old):
            return new

    return "ta_lab2.integrations.economic (check ALTERNATIVES.md)"


def scan_directory(
    directory: Path,
    recursive: bool = True,
    exclude_patterns: Optional[Set[str]] = None
) -> List[ImportIssue]:
    """Scan a directory for Python files with old imports.

    Args:
        directory: Directory to scan
        recursive: Whether to scan subdirectories
        exclude_patterns: Directory names to skip (e.g., {"__pycache__", ".venv"})

    Returns:
        List of all ImportIssue objects found
    """
    if exclude_patterns is None:
        exclude_patterns = {"__pycache__", ".venv", ".git", "node_modules", ".archive"}

    all_issues = []
    pattern = "**/*.py" if recursive else "*.py"

    for py_file in directory.glob(pattern):
        # Skip excluded directories
        if any(excluded in py_file.parts for excluded in exclude_patterns):
            continue

        issues = scan_file_for_imports(py_file)
        all_issues.extend(issues)

    return all_issues


def format_report(issues: List[ImportIssue], verbose: bool = False) -> str:
    """Format issues as a readable report.

    Args:
        issues: List of ImportIssue objects
        verbose: Include detailed replacement suggestions

    Returns:
        Formatted report string
    """
    if not issues:
        return "No deprecated imports found. Your code is ready!"

    lines = [
        "=" * 60,
        "ECONOMIC DATA MIGRATION REPORT",
        "=" * 60,
        f"\nFound {len(issues)} deprecated import(s):\n",
    ]

    # Group by file
    by_file = {}
    for issue in issues:
        file_key = str(issue.file_path)
        if file_key not in by_file:
            by_file[file_key] = []
        by_file[file_key].append(issue)

    for file_path, file_issues in sorted(by_file.items()):
        lines.append(f"\n{file_path}")
        lines.append("-" * len(file_path))

        for issue in file_issues:
            lines.append(f"  Line {issue.line_number}: {issue.import_text}")
            if verbose:
                lines.append(f"    -> Replace with: {issue.suggested_replacement}")

    lines.extend([
        "\n" + "=" * 60,
        "MIGRATION STEPS:",
        "=" * 60,
        "1. Install new dependencies: pip install ta_lab2[fred]",
        "2. Update imports as suggested above",
        "3. Set FRED_API_KEY environment variable",
        "4. See docs/migration/ECONOMIC_DATA.md for detailed guide",
        "",
    ])

    return "\n".join(lines)


def main(argv: Optional[List[str]] = None) -> int:
    """CLI entry point for migration tool.

    Args:
        argv: Command line arguments (defaults to sys.argv[1:])

    Returns:
        Exit code (0 = no issues or informational, 1 = issues found)
    """
    parser = argparse.ArgumentParser(
        description="Scan code for deprecated fredtools2/fedtools2 imports"
    )
    parser.add_argument(
        "path",
        type=Path,
        help="File or directory to scan"
    )
    parser.add_argument(
        "-r", "--recursive",
        action="store_true",
        default=True,
        help="Scan directories recursively (default: True)"
    )
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="Show detailed replacement suggestions"
    )
    parser.add_argument(
        "--no-recursive",
        action="store_true",
        help="Don't scan subdirectories"
    )

    args = parser.parse_args(argv)

    path = args.path.resolve()
    recursive = args.recursive and not args.no_recursive

    if path.is_file():
        issues = scan_file_for_imports(path)
    elif path.is_dir():
        issues = scan_directory(path, recursive=recursive)
    else:
        print(f"Error: {path} does not exist", file=sys.stderr)
        return 1

    report = format_report(issues, verbose=args.verbose)
    print(report)

    return 1 if issues else 0


if __name__ == "__main__":
    sys.exit(main())
```

Create the docs/migration/ directory if it doesn't exist.
  </action>
  <verify>
Run: `python -c "from ta_lab2.integrations.economic.migration_tool import scan_file_for_imports, MIGRATION_MAP; print(f'Migration tool OK, {len(MIGRATION_MAP)} mappings')"` succeeds
Run: `Test-Path docs/migration/ECONOMIC_DATA.md` returns True
  </verify>
  <done>Migration documentation and tool created with comprehensive guidance and working scanner</done>
</task>

</tasks>

<verification>
1. pyproject.toml has [fred], [fed], [economic] in optional-dependencies
2. pyproject.toml [all] group includes fredapi
3. economic_data.env.example exists with FRED_API_KEY and configuration options
4. docs/migration/ECONOMIC_DATA.md provides clear migration guide
5. migration_tool.py can scan for old imports: `python -m ta_lab2.integrations.economic.migration_tool .`
6. Migration tool detects fredtools2 and fedtools2 imports
</verification>

<success_criteria>
- pyproject.toml updated with [fred], [fed], [economic] extras
- economic_data.env.example follows db_config.env pattern with all configuration options
- Migration guide covers before/after examples, installation, feature comparison
- Migration tool successfully detects old package imports in code
- All three migration support mechanisms from context implemented (README, warnings concept, tool)
</success_criteria>

<output>
After completion, create `.planning/phases/15-economic-data-strategy/15-05-SUMMARY.md`
</output>
