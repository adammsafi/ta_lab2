---
phase: 17-verification-validation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/scripts/emas/ema_runners.py
  - src/ta_lab2/tools/data_tools/database_utils/ema_runners.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ema_runners.py no longer in tools layer"
    - "import-linter tools->features contract passes"
    - "ema_runners functionality preserved in scripts layer"
  artifacts:
    - path: "src/ta_lab2/scripts/emas/ema_runners.py"
      provides: "EMA database write utilities"
      min_lines: 200
  key_links:
    - from: "src/ta_lab2/scripts/emas/ema_runners.py"
      to: "ta_lab2.features.ema"
      via: "direct import (allowed: scripts can import features)"
      pattern: "from ta_lab2\\.features\\.ema import"
---

<objective>
Fix tools -> features layer violation by moving ema_runners.py from tools to scripts

Purpose: The file `ema_runners.py` is currently in `tools/data_tools/database_utils/` but imports from `features/ema`, `features/m_tf`. This violates the layering contract where tools (foundation layer) should not depend on features. The file is actually a runner script that orchestrates EMA writes, so it belongs in `scripts/emas/`.

Output: ema_runners.py relocated to scripts layer where feature imports are permitted
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-verification-validation/17-VERIFICATION.md

# Current violation source
@src/ta_lab2/tools/data_tools/database_utils/ema_runners.py

# Target location siblings
@src/ta_lab2/scripts/emas/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move ema_runners.py to scripts/emas layer</name>
  <files>
    src/ta_lab2/scripts/emas/ema_runners.py
    src/ta_lab2/tools/data_tools/database_utils/ema_runners.py
  </files>
  <action>
    Use git mv to move the file from tools to scripts layer:

    ```bash
    git mv src/ta_lab2/tools/data_tools/database_utils/ema_runners.py src/ta_lab2/scripts/emas/ema_runners.py
    ```

    This is a pure move - no content changes. The file's imports from ta_lab2.features are now VALID because scripts layer is allowed to import from features layer per the import-linter contract.

    The CLI usage changes from:
    - OLD: `python -m ta_lab2.tools.data_tools.database_utils.ema_runners`
    - NEW: `python -m ta_lab2.scripts.emas.ema_runners`

    Update the module docstring to reflect the new location (lines 15-28 in original):
    - Change `from ta_lab2.tools.data_tools.database_utils.ema_runners import` to `from ta_lab2.scripts.emas.ema_runners import`
    - Update CLI examples to use `python -m ta_lab2.scripts.emas.ema_runners`
  </action>
  <verify>
    ```bash
    # File exists in new location
    ls src/ta_lab2/scripts/emas/ema_runners.py

    # File removed from old location
    ls src/ta_lab2/tools/data_tools/database_utils/ema_runners.py 2>&1 | grep -q "No such file"

    # Module importable from new location
    python -c "from ta_lab2.scripts.emas.ema_runners import write_daily_emas; print('OK')"
    ```
  </verify>
  <done>ema_runners.py exists only in src/ta_lab2/scripts/emas/ and is importable</done>
</task>

<task type="auto">
  <name>Task 2: Update any internal imports referencing old location</name>
  <files>
    src/ta_lab2/tools/data_tools/database_utils/__init__.py
  </files>
  <action>
    Search for any imports of ema_runners from the old location and update them:

    ```bash
    grep -r "ta_lab2.tools.data_tools.database_utils.ema_runners" src/
    grep -r "from ta_lab2.tools.data_tools.database_utils import.*ema_runners" src/
    ```

    If found in `__init__.py` files or other modules, update to new path:
    - OLD: `from ta_lab2.tools.data_tools.database_utils.ema_runners import ...`
    - NEW: `from ta_lab2.scripts.emas.ema_runners import ...`

    If `tools/data_tools/database_utils/__init__.py` re-exports ema_runners, remove that export (the module has moved).

    Check if tools/data_tools/database_utils/ directory is now empty and can be cleaned up (unlikely, but verify).
  </action>
  <verify>
    ```bash
    # No remaining references to old path
    grep -r "ta_lab2.tools.data_tools.database_utils.ema_runners" src/ | wc -l
    # Should output: 0
    ```
  </verify>
  <done>Zero references to old ema_runners location in codebase</done>
</task>

<task type="auto">
  <name>Task 3: Verify import-linter tools->features contract passes</name>
  <files></files>
  <action>
    Run import-linter to verify the tools->features violation is fixed:

    ```bash
    cd /path/to/ta_lab2
    lint-imports --contract "Tools layer doesn't import from features layer"
    ```

    Expected: The specific contract "Tools layer doesn't import from features layer" should now PASS.

    Note: The other two violations (regimes<->pipelines) may still fail - that's addressed in Plans 17-07 and 17-08.
  </action>
  <verify>
    ```bash
    # Run the specific contract check
    lint-imports 2>&1 | grep -A2 "Tools layer doesn't import from features layer"
    # Should show: PASSED or no violations for this contract
    ```
  </verify>
  <done>import-linter contract "Tools layer doesn't import from features layer" passes</done>
</task>

</tasks>

<verification>
- [ ] File moved via git mv (preserves history)
- [ ] Old location empty
- [ ] New location importable
- [ ] No dangling imports
- [ ] import-linter tools->features contract passes
</verification>

<success_criteria>
1. `src/ta_lab2/tools/data_tools/database_utils/ema_runners.py` does not exist
2. `src/ta_lab2/scripts/emas/ema_runners.py` exists and is importable
3. `lint-imports` shows 2 violations (down from 3) - the tools->features violation is gone
4. git history preserved via `git mv`
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-validation/17-06-SUMMARY.md`
</output>
