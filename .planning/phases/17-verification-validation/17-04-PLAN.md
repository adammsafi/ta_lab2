---
phase: 17-verification-validation
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - .pre-commit-config.yaml
autonomous: true

must_haves:
  truths:
    - "Pre-commit hooks install successfully"
    - "Ruff linting runs on staged Python files"
    - "No .py files in root check blocks commits (if >1 py file)"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration"
      contains: "ruff-pre-commit"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "ruff"
      via: "pre-commit hook"
      pattern: "ruff-pre-commit"
    - from: ".pre-commit-config.yaml"
      to: "pre-commit hooks"
      via: "standard hooks"
      pattern: "pre-commit-hooks"
---

<objective>
Set up pre-commit hooks with Ruff linting and organization rules

Purpose: Prevent future disorganization through automated pre-commit checks
Output: .pre-commit-config.yaml with fast hooks (<5 seconds total)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-verification-validation/17-CONTEXT.md
@.planning/phases/17-verification-validation/17-RESEARCH.md

# pyproject.toml for reference
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-commit configuration</name>
  <files>.pre-commit-config.yaml</files>
  <action>
Create .pre-commit-config.yaml with fast hooks.

Configuration priorities (per CONTEXT.md):
- Ruff only for linting (fast, <1s)
- Skip mypy (slow, >10s)
- Block on critical issues
- Warn on others

Create this file:

```yaml
# Pre-commit hooks for ta_lab2
# Target: <5 seconds total execution time
#
# Install: pre-commit install
# Run manually: pre-commit run --all-files
# Skip hooks: SKIP=ruff-check git commit -m "message"

repos:
  # Ruff: Fast linting and formatting (Rust-based, ~10-100x faster than alternatives)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.14
    hooks:
      # Run linter with auto-fix (BEFORE formatter)
      - id: ruff
        name: ruff lint
        args: [--fix, --exit-non-zero-on-fix]
        types_or: [python, pyi]

      # Run formatter
      - id: ruff-format
        name: ruff format
        types_or: [python, pyi]

  # Standard pre-commit hooks (fast checks)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        exclude: '\.md$'  # Allow trailing whitespace in markdown (intentional line breaks)
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-toml
      - id: check-added-large-files
        args: [--maxkb=500]
      - id: check-merge-conflict
      - id: mixed-line-ending
        args: [--fix=lf]
      - id: debug-statements
        name: check for debug statements

  # Custom local hooks for project organization rules
  - repo: local
    hooks:
      # Block: No .py files in project root (except config.py)
      - id: no-root-py-files
        name: No .py files in project root
        entry: bash -c 'count=$(ls -1 *.py 2>/dev/null | grep -v "^config.py$" | wc -l); if [ "$count" -gt 0 ]; then echo "Error: Python files not allowed in project root (except config.py):"; ls *.py | grep -v "^config.py$"; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true

      # Warn: Validate manifest JSON files (if modified)
      - id: validate-manifest-json
        name: Validate manifest JSON
        entry: python -m json.tool
        language: system
        files: 'manifest\.json$'
        types: [json]

# Configuration
default_language_version:
  python: python3.10

# Don't fail fast - show all issues
fail_fast: false
```

Notes:
- Uses ruff v0.1.14 (stable version from research)
- Excludes config.py from root check (it's expected)
- Mixed line endings fixed to LF (cross-platform consistency)
- Large files capped at 500KB
  </action>
  <verify>cat .pre-commit-config.yaml | grep -E "(ruff|no-root-py-files)"</verify>
  <done>.pre-commit-config.yaml exists with Ruff and org rule hooks</done>
</task>

<task type="auto">
  <name>Task 2: Install and test pre-commit hooks</name>
  <files></files>
  <action>
Install pre-commit and verify hooks work correctly.

Commands:
1. Install pre-commit if not present:
   pip install pre-commit

2. Install git hooks:
   pre-commit install

3. Run all hooks on staged files (dry run):
   pre-commit run --all-files

4. Verify timing (should be <5 seconds):
   time pre-commit run --all-files

If any hooks fail:
- For ruff failures: These are real lint issues, document for fixing
- For other failures: Investigate and fix configuration

Note: Some ruff issues may exist from prior phases - document them but don't block on fixing.
  </action>
  <verify>pre-commit run --all-files completes (may have warnings but no config errors)</verify>
  <done>Pre-commit hooks installed and functioning</done>
</task>

</tasks>

<verification>
1. .pre-commit-config.yaml exists
2. pre-commit install succeeds
3. pre-commit run --all-files completes without config errors
4. Ruff hooks run on Python files
5. No-root-py-files hook blocks if >1 .py file in root
</verification>

<success_criteria>
- Pre-commit hooks install successfully
- Ruff linting runs on staged Python files (<1s per file)
- Organization rules enforced (no .py in root except config.py)
- Total hook execution time <5 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-validation/17-04-SUMMARY.md`
</output>
