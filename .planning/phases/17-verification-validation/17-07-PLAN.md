---
phase: 17-verification-validation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/scripts/pipelines/run_btc_pipeline.py
  - src/ta_lab2/regimes/run_btc_pipeline.py
  - src/ta_lab2/scripts/pipelines/__init__.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "run_btc_pipeline.py no longer in regimes layer"
    - "import-linter regimes->pipelines contract passes"
    - "BTC pipeline runner functionality preserved in scripts layer"
  artifacts:
    - path: "src/ta_lab2/scripts/pipelines/run_btc_pipeline.py"
      provides: "BTC pipeline orchestration CLI wrapper"
      min_lines: 50
    - path: "src/ta_lab2/scripts/pipelines/__init__.py"
      provides: "Pipeline scripts package marker"
      min_lines: 1
  key_links:
    - from: "src/ta_lab2/scripts/pipelines/run_btc_pipeline.py"
      to: "ta_lab2.pipelines.btc_pipeline"
      via: "direct import (allowed: scripts can import pipelines)"
      pattern: "from ta_lab2\\.pipelines\\.btc_pipeline import"
---

<objective>
Fix regimes -> pipelines layer violation by moving run_btc_pipeline.py to scripts layer

Purpose: The file `regimes/run_btc_pipeline.py` imports from `pipelines/btc_pipeline`, which violates the layering contract (regimes and pipelines are at the same layer level). The file is actually a thin CLI wrapper/orchestrator, not core regime logic. Moving it to `scripts/pipelines/` resolves the violation because scripts layer can import from pipelines layer.

Output: run_btc_pipeline.py relocated to scripts/pipelines/ where pipeline imports are permitted
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-verification-validation/17-VERIFICATION.md

# Current violation source
@src/ta_lab2/regimes/run_btc_pipeline.py

# Canonical pipeline implementation (stays in place)
@src/ta_lab2/pipelines/btc_pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/pipelines directory and move run_btc_pipeline.py</name>
  <files>
    src/ta_lab2/scripts/pipelines/__init__.py
    src/ta_lab2/scripts/pipelines/run_btc_pipeline.py
    src/ta_lab2/regimes/run_btc_pipeline.py
  </files>
  <action>
    1. Create the target directory if it doesn't exist:
    ```bash
    mkdir -p src/ta_lab2/scripts/pipelines
    ```

    2. Create __init__.py for the new package:
    ```python
    # src/ta_lab2/scripts/pipelines/__init__.py
    """Pipeline runner scripts.

    CLI wrappers and orchestration scripts for ta_lab2 pipelines.
    These scripts import from ta_lab2.pipelines and provide CLI interfaces.
    """
    ```

    3. Use git mv to move the file:
    ```bash
    git mv src/ta_lab2/regimes/run_btc_pipeline.py src/ta_lab2/scripts/pipelines/run_btc_pipeline.py
    ```

    4. Update the module docstring in the moved file to reflect new location:
    - Line 1: Keep the comment `# src/ta_lab2/scripts/pipelines/run_btc_pipeline.py`
    - Update the comment at line 34-35: Change "This wrapper keeps the CLI and tests portable while delegating core logic to src/ta_lab2/pipelines/btc_pipeline.py" to clarify the new location

    The import `from ta_lab2.pipelines.btc_pipeline import run_btc_pipeline as _btc_core` remains VALID because scripts layer can import from pipelines layer.
  </action>
  <verify>
    ```bash
    # Directory exists
    ls -la src/ta_lab2/scripts/pipelines/

    # __init__.py exists
    cat src/ta_lab2/scripts/pipelines/__init__.py

    # File exists in new location
    ls src/ta_lab2/scripts/pipelines/run_btc_pipeline.py

    # File removed from old location
    ls src/ta_lab2/regimes/run_btc_pipeline.py 2>&1 | grep -q "No such file"
    ```
  </verify>
  <done>run_btc_pipeline.py exists in src/ta_lab2/scripts/pipelines/ with proper __init__.py</done>
</task>

<task type="auto">
  <name>Task 2: Update any imports referencing old regimes location</name>
  <files></files>
  <action>
    Search for any imports of run_btc_pipeline from the old regimes location:

    ```bash
    grep -r "ta_lab2.regimes.run_btc_pipeline" src/
    grep -r "from ta_lab2.regimes import.*run_btc_pipeline" src/
    ```

    If found, update to new path:
    - OLD: `from ta_lab2.regimes.run_btc_pipeline import run_btc_pipeline`
    - NEW: `from ta_lab2.scripts.pipelines.run_btc_pipeline import run_btc_pipeline`

    Check `regimes/__init__.py` for any re-exports and remove them.

    Note: External callers (tests, notebooks) may need updates but those are non-blocking - the module is still importable, just from a new location.
  </action>
  <verify>
    ```bash
    # No remaining references to old path in src/
    grep -r "ta_lab2.regimes.run_btc_pipeline" src/ | wc -l
    # Should output: 0
    ```
  </verify>
  <done>Zero references to old run_btc_pipeline location in src/ directory</done>
</task>

<task type="auto">
  <name>Task 3: Verify import-linter regimes->pipelines contract passes</name>
  <files></files>
  <action>
    Run import-linter to verify the regimes->pipelines violation is fixed:

    ```bash
    lint-imports --contract "No circular dependency between regimes and pipelines"
    ```

    Expected: The contract "No circular dependency between regimes and pipelines" should now PASS.

    The circular dependency is broken because:
    - regimes no longer imports from pipelines (run_btc_pipeline.py moved out)
    - pipelines can still import from regimes (comovement) - this is allowed by the layers contract
  </action>
  <verify>
    ```bash
    # Run the specific contract check
    lint-imports 2>&1 | grep -A2 "No circular dependency between regimes and pipelines"
    # Should show: PASSED or no violations for this contract
    ```
  </verify>
  <done>import-linter contract "No circular dependency between regimes and pipelines" passes</done>
</task>

</tasks>

<verification>
- [ ] scripts/pipelines/ directory created with __init__.py
- [ ] File moved via git mv (preserves history)
- [ ] Old location empty
- [ ] New location importable
- [ ] No dangling imports in src/
- [ ] import-linter regimes->pipelines contract passes
</verification>

<success_criteria>
1. `src/ta_lab2/regimes/run_btc_pipeline.py` does not exist
2. `src/ta_lab2/scripts/pipelines/run_btc_pipeline.py` exists and is importable
3. `lint-imports` shows 1 violation (down from 3) - the regimes->pipelines violation is gone
4. git history preserved via `git mv`
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-validation/17-07-SUMMARY.md`
</output>
