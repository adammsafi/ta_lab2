---
phase: 17-verification-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/test_circular_deps.py
autonomous: true

must_haves:
  truths:
    - "Zero circular dependencies in ta_lab2 package"
    - "import-linter detects cycles between sibling packages"
    - "Layer violations detected (tools shouldn't import scripts)"
  artifacts:
    - path: "pyproject.toml"
      provides: "import-linter configuration"
      contains: "[tool.importlinter]"
    - path: "tests/test_circular_deps.py"
      provides: "Pytest wrapper for import-linter"
      exports: ["test_no_circular_dependencies"]
  key_links:
    - from: "tests/test_circular_deps.py"
      to: "lint-imports"
      via: "subprocess call"
      pattern: 'subprocess\\.run.*lint-imports'
    - from: "pyproject.toml"
      to: "import-linter"
      via: "tool configuration"
      pattern: "\\[tool\\.importlinter\\]"
---

<objective>
Configure import-linter for strict circular dependency detection

Purpose: Ensure zero circular imports exist after v0.5.0 reorganization
Output: import-linter configuration in pyproject.toml + pytest test wrapper
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-verification-validation/17-CONTEXT.md
@.planning/phases/17-verification-validation/17-RESEARCH.md

# Current pyproject.toml
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure import-linter in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add import-linter configuration to pyproject.toml at the end of the file.

Add this configuration:

```toml
# ---------- Import-linter configuration ----------
[tool.importlinter]
root_package = "ta_lab2"

# Contract 1: No circular dependencies between sibling packages
[[tool.importlinter.contracts]]
name = "No circular dependencies between ta_lab2 subpackages"
type = "acyclic_siblings"
packages = [
    "ta_lab2.features",
    "ta_lab2.tools",
    "ta_lab2.scripts",
    "ta_lab2.regimes",
    "ta_lab2.signals",
    "ta_lab2.backtests",
    "ta_lab2.analysis",
    "ta_lab2.pipelines",
]

# Contract 2: Tools don't import from scripts (layering)
[[tool.importlinter.contracts]]
name = "Tools layer doesn't import from scripts layer"
type = "forbidden"
source_modules = ["ta_lab2.tools"]
forbidden_modules = ["ta_lab2.scripts"]

# Contract 3: Features don't import from scripts (layering)
[[tool.importlinter.contracts]]
name = "Features layer doesn't import from scripts layer"
type = "forbidden"
source_modules = ["ta_lab2.features"]
forbidden_modules = ["ta_lab2.scripts"]
```

Also add import-linter to dev dependencies if not present:
```toml
dev = [
  ...
  "import-linter>=2.7",
]
```
  </action>
  <verify>grep -A 20 "tool.importlinter" pyproject.toml shows configuration</verify>
  <done>pyproject.toml has import-linter contracts configured</done>
</task>

<task type="auto">
  <name>Task 2: Create pytest wrapper for import-linter</name>
  <files>tests/test_circular_deps.py</files>
  <action>
Create tests/test_circular_deps.py that runs import-linter via subprocess.

```python
"""Test for circular dependencies using import-linter.

Runs lint-imports command and fails if any circular imports detected.
Configuration is in pyproject.toml [tool.importlinter] section.
"""
import subprocess
import sys
import pytest


def test_no_circular_dependencies():
    """Run import-linter to detect circular dependencies.

    Fails if any circular imports detected. Configuration in pyproject.toml.
    Uses strict zero-cycle policy - no exceptions even for TYPE_CHECKING blocks.
    """
    # Check if import-linter is installed
    try:
        import importlinter
    except ImportError:
        pytest.skip("import-linter not installed (pip install import-linter)")

    result = subprocess.run(
        [sys.executable, "-m", "importlinter"],
        capture_output=True,
        text=True,
        cwd=".",  # Run from project root
    )

    if result.returncode != 0:
        # import-linter found violations
        pytest.fail(
            f"Circular dependencies detected:\n"
            f"STDOUT:\n{result.stdout}\n"
            f"STDERR:\n{result.stderr}"
        )
```

The test:
- Skips if import-linter not installed (graceful degradation)
- Runs lint-imports via subprocess (avoids import issues)
- Reports stdout/stderr on failure for debugging
  </action>
  <verify>pytest tests/test_circular_deps.py -v shows test collected</verify>
  <done>tests/test_circular_deps.py exists with subprocess-based lint-imports call</done>
</task>

<task type="auto">
  <name>Task 3: Run circular dependency check</name>
  <files></files>
  <action>
Run import-linter to verify no circular dependencies exist.

Commands:
1. Install import-linter: pip install import-linter

2. Run directly: python -m importlinter
   - Exit code 0 = all contracts pass
   - Exit code 1 = violations detected

3. Run via pytest: pytest tests/test_circular_deps.py -v

If violations found:
- Review the import chain reported
- Determine if it's a real cycle or import-linter misconfiguration
- Document any necessary fixes for later plans

Note: This is validation, not fixing. If cycles exist, document them - they'll be fixed in gap closure.
  </action>
  <verify>python -m importlinter exits with code 0</verify>
  <done>import-linter reports all contracts passed (or violations documented for fixing)</done>
</task>

</tasks>

<verification>
1. pyproject.toml has [tool.importlinter] section
2. Three contracts defined: acyclic_siblings, two forbidden
3. tests/test_circular_deps.py exists and runs
4. lint-imports command succeeds (or violations documented)
</verification>

<success_criteria>
- Zero circular dependencies detected between ta_lab2 sibling packages
- Layer violations (tools->scripts, features->scripts) blocked
- import-linter integrated with pytest for CI
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-validation/17-02-SUMMARY.md`
</output>
