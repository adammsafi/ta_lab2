---
phase: 17-verification-validation
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - .github/workflows/validation.yml
autonomous: true

must_haves:
  truths:
    - "CI fails on import validation failures"
    - "CI fails on circular dependency detection"
    - "CI warns on organization rule violations (non-blocking)"
  artifacts:
    - path: ".github/workflows/validation.yml"
      provides: "Enhanced CI validation workflow"
      contains: "test_imports.py"
  key_links:
    - from: ".github/workflows/validation.yml"
      to: "tests/test_imports.py"
      via: "pytest execution"
      pattern: "pytest tests/test_imports.py"
    - from: ".github/workflows/validation.yml"
      to: "tests/test_circular_deps.py"
      via: "pytest execution"
      pattern: "test_circular_deps"
---

<objective>
Enhance CI workflow to run import and circular dependency validation

Purpose: Gate CI on critical validation (imports, circular deps) while warning on org rules
Output: Updated validation.yml with import/circular dep checks
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-verification-validation/17-CONTEXT.md
@.planning/phases/17-verification-validation/17-RESEARCH.md

# Existing CI workflows
@.github/workflows/validation.yml
@.github/workflows/ci.yml

# New tests from Plans 17-01 and 17-02
@tests/test_imports.py
@tests/test_circular_deps.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive validation CI workflow</name>
  <files>.github/workflows/validation.yml</files>
  <action>
Replace the existing validation.yml with an enhanced version that includes import validation.

The new workflow should have these jobs:

1. **import-validation-core** (CRITICAL - must pass):
   - Install dev dependencies only (no orchestrator)
   - Run: pytest tests/test_imports.py -m "not orchestrator" -v --tb=short
   - Fails CI if any core imports fail

2. **circular-dependencies** (CRITICAL - must pass):
   - Install import-linter
   - Run: python -m importlinter
   - Fails CI if any cycles detected

3. **import-validation-optional** (WARNING - can fail):
   - Install all dependencies (including orchestrator)
   - Run: pytest tests/test_imports.py -m "orchestrator" -v --tb=short
   - Uses continue-on-error: true (warns but doesn't block)

4. **organization-rules** (WARNING - can fail):
   - Check no .py files in project root
   - Validate manifest JSON files
   - Uses continue-on-error: true

Keep the existing validation tests job for database-dependent tests.

Structure:
```yaml
name: Validation & Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # Critical jobs that must pass
  import-validation-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install core dependencies
        run: pip install -e ".[dev]"
      - name: Test core imports
        run: pytest tests/test_imports.py -m "not orchestrator" -v --tb=short

  circular-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install package and import-linter
        run: |
          pip install -e ".[dev]"
          pip install import-linter
      - name: Check for circular dependencies
        run: python -m importlinter

  # Warning jobs (can fail without blocking)
  import-validation-optional:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install all dependencies
        run: pip install -e ".[all]"
      - name: Test orchestrator imports
        run: pytest tests/test_imports.py -m "orchestrator" -v --tb=short
        continue-on-error: true

  organization-rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check no .py files in project root
        run: |
          count=$(ls -1 *.py 2>/dev/null | wc -l || echo "0")
          if [ "$count" -gt 1 ]; then
            echo "::warning::Multiple Python files found in project root (expected max 1: config.py)"
            ls *.py
          fi
        continue-on-error: true
      - name: Validate manifest JSON files
        run: |
          for f in $(find .archive -name "manifest.json" 2>/dev/null); do
            python -m json.tool "$f" > /dev/null || echo "::warning::Invalid JSON: $f"
          done
        continue-on-error: true

  # Existing database-dependent validation tests
  validation-tests:
    # ... keep existing job with postgres service
```
  </action>
  <verify>
Verify workflow file created with expected structure:
1. File exists: test -f .github/workflows/validation.yml
2. Has import-validation-core job: grep -q "import-validation-core:" .github/workflows/validation.yml
3. Has circular-dependencies job: grep -q "circular-dependencies:" .github/workflows/validation.yml
4. Critical jobs don't have continue-on-error: grep -A10 "import-validation-core:" .github/workflows/validation.yml | grep -v "continue-on-error"
  </verify>
  <done>validation.yml has import and circular dependency jobs with correct blocking/non-blocking configuration</done>
</task>

<task type="auto">
  <name>Task 2: Validate workflow YAML syntax and structure</name>
  <files></files>
  <action>
Validate the GitHub Actions workflow YAML syntax and structure. This is the gate that ensures the workflow is valid before declaring success.

Validation steps:

1. **YAML syntax validation** (REQUIRED - must pass):
   ```bash
   python -c "import yaml; yaml.safe_load(open('.github/workflows/validation.yml'))"
   ```
   If this fails, fix syntax errors before proceeding.

2. **Structural validation** (REQUIRED - must pass):
   ```bash
   python -c "
   import yaml
   with open('.github/workflows/validation.yml') as f:
       workflow = yaml.safe_load(f)

   # Verify required top-level keys
   assert 'name' in workflow, 'Missing workflow name'
   assert 'on' in workflow, 'Missing trigger configuration'
   assert 'jobs' in workflow, 'Missing jobs section'

   # Verify expected jobs exist
   jobs = workflow['jobs']
   required_jobs = ['import-validation-core', 'circular-dependencies']
   for job in required_jobs:
       assert job in jobs, f'Missing critical job: {job}'

   # Verify critical jobs don't have continue-on-error at job level
   for job in required_jobs:
       assert jobs[job].get('continue-on-error') != True, f'{job} should not have continue-on-error'

   print('Workflow structure valid')
   "
   ```

3. **Review workflow structure matches expected jobs:**
   - import-validation-core (critical)
   - circular-dependencies (critical)
   - import-validation-optional (warning)
   - organization-rules (warning)
   - validation-tests (existing)

If any validation fails, fix the issues before completing.
  </action>
  <verify>
python -c "import yaml; w=yaml.safe_load(open('.github/workflows/validation.yml')); assert 'import-validation-core' in w['jobs'] and 'circular-dependencies' in w['jobs']"
  </verify>
  <done>Workflow YAML is valid, parseable, and has correct job structure</done>
</task>

</tasks>

<verification>
1. validation.yml has import-validation-core job
2. validation.yml has circular-dependencies job
3. Critical jobs don't have continue-on-error
4. Warning jobs have continue-on-error: true
5. YAML syntax valid (python yaml.safe_load succeeds)
6. YAML structure valid (required jobs present with correct config)
</verification>

<success_criteria>
- CI fails on import validation failures (blocking)
- CI fails on circular dependency detection (blocking)
- CI warns on organization rule violations (non-blocking)
- Workflow YAML syntax and structure validated programmatically
</success_criteria>

<output>
After completion, create `.planning/phases/17-verification-validation/17-03-SUMMARY.md`
</output>
