---
phase: 22-critical-data-quality-fixes
plan: 05
type: execute
wave: 3
depends_on: ["22-04"]
files_modified:
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All 5 multi-TF builders support --from-1d derivation mode"
    - "Calendar builders apply correct week boundaries (US Sunday vs ISO Monday)"
    - "Anchor builders allow partial bars at boundaries"
    - "--from-1d is validated and recommended as default for new runs"
  artifacts:
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py"
      provides: "Calendar US builder with --from-1d support"
      contains: "--from-1d"
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py"
      provides: "Calendar ISO builder with --from-1d support"
      contains: "--from-1d"
  key_links:
    - from: "All calendar builders"
      to: "derive_multi_tf_from_1d"
      via: "import and use for derivation"
      pattern: "from.*derive_multi_tf_from_1d.*import"
---

<objective>
Extend derivation support to all 4 calendar variant builders (GAP-C03 Part 3: Complete refactor).

Purpose: With the foundation from 22-04 validated, this plan extends --from-1d support to all calendar variant builders. Each builder applies its specific calendar alignment (US Sunday week vs ISO Monday week, full-period vs anchor) while deriving from the same validated 1D source.

Output: All 5 multi-TF builders can derive from 1D bars with proper calendar alignment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-critical-data-quality-fixes/22-CONTEXT.md

# Key source files
@src/ta_lab2/scripts/bars/derive_multi_tf_from_1d.py (created in 22-04)
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py (--from-1d added in 22-04)
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py

# Phase 21 analysis
@.planning/phases/21-comprehensive-review/deliverables/variant-comparison.md (calendar alignment differences)

# Dependencies
@.planning/phases/22-critical-data-quality-fixes/22-04-SUMMARY.md (if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend derive_multi_tf_from_1d for calendar alignment</name>
  <files>src/ta_lab2/scripts/bars/derive_multi_tf_from_1d.py</files>
  <action>
Add calendar-specific aggregation functions to derive_multi_tf_from_1d.py:

1. Add calendar alignment functions:
```python
def get_week_start_day(alignment: str) -> int:
    """
    Get ISO weekday for week start.

    Args:
        alignment: 'calendar_us' (Sunday=0) or 'calendar_iso' (Monday=1)

    Returns:
        ISO weekday number (1=Monday through 7=Sunday)
    """
    if alignment == "calendar_us":
        return 7  # Sunday
    elif alignment == "calendar_iso":
        return 1  # Monday
    else:
        raise ValueError(f"Unknown calendar alignment: {alignment}")


def assign_calendar_periods(
    df_daily: pl.DataFrame,
    target_tf: str,
    alignment: str,
    anchor_mode: bool = False,
) -> pl.DataFrame:
    """
    Assign calendar periods to daily bars based on alignment.

    Args:
        df_daily: Daily bars with timestamp column
        target_tf: Target timeframe (1W_CAL, 2W_CAL, 1M_CAL, etc.)
        alignment: 'calendar_us' or 'calendar_iso'
        anchor_mode: If True, include partial periods at boundaries

    Returns:
        DataFrame with added 'period_start' column for grouping

    Calendar rules:
    - Weeks: Start on week_start_day, fixed 7-day periods
    - Months: Start on 1st, variable days
    - Quarters: Start on Jan/Apr/Jul/Oct 1st
    - Years: Start on Jan 1st

    Anchor mode:
    - If anchor_mode=True, first/last periods may be partial
    - is_partial_start/is_partial_end flags set accordingly
    """
    pass


def aggregate_by_calendar_period(
    df_daily: pl.DataFrame,
    period_col: str = "period_start",
) -> pl.DataFrame:
    """
    Aggregate daily bars by calendar period.

    Same OHLCV aggregation as tf_day mode, but grouped by period_col
    instead of fixed day counts.
    """
    pass
```

2. Update aggregate_daily_to_timeframe to support all alignment modes:
```python
def aggregate_daily_to_timeframe(
    df_daily: pl.DataFrame,
    target_tf: str,
    alignment: Literal["tf_day", "calendar_us", "calendar_iso"] = "tf_day",
    anchor_mode: bool = False,
) -> pl.DataFrame:
    """
    Aggregate daily bars into target timeframe with specified alignment.

    alignment modes:
    - tf_day: Fixed day-count windows (1D, 2D, 3D, 5D, 1W=7D, etc.)
    - calendar_us: Calendar-aligned with Sunday week start
    - calendar_iso: Calendar-aligned with Monday week start

    anchor_mode (only for calendar alignments):
    - False: Require complete periods (filter incomplete)
    - True: Allow partial periods at boundaries (with flags)
    """
    if alignment == "tf_day":
        return _aggregate_tf_day(df_daily, target_tf)
    else:
        df_with_periods = assign_calendar_periods(df_daily, target_tf, alignment, anchor_mode)
        return aggregate_by_calendar_period(df_with_periods)
```

3. Add utility to map builder type to alignment:
```python
BUILDER_ALIGNMENT_MAP = {
    "multi_tf": ("tf_day", False),
    "cal_us": ("calendar_us", False),
    "cal_iso": ("calendar_iso", False),
    "cal_anchor_us": ("calendar_us", True),
    "cal_anchor_iso": ("calendar_iso", True),
}
```
  </action>
  <verify>
```bash
python -c "
from ta_lab2.scripts.bars.derive_multi_tf_from_1d import (
    get_week_start_day,
    assign_calendar_periods,
    aggregate_by_calendar_period,
    BUILDER_ALIGNMENT_MAP,
)
print('Calendar functions importable')
print(f'Week start: US={get_week_start_day(\"calendar_us\")}, ISO={get_week_start_day(\"calendar_iso\")}')
"
```
  </verify>
  <done>
- get_week_start_day returns correct day for US (Sunday=7) and ISO (Monday=1)
- assign_calendar_periods handles weeks, months, quarters, years
- aggregate_by_calendar_period groups by period_col
- anchor_mode flag controls partial period handling
- BUILDER_ALIGNMENT_MAP documents alignment for each builder type
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --from-1d to calendar builders (US and ISO)</name>
  <files>
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
  </files>
  <action>
Add --from-1d derivation support to both calendar builders:

For each builder (cal_us and cal_iso):

1. Add imports:
```python
from ta_lab2.scripts.bars.derive_multi_tf_from_1d import (
    derive_multi_tf_bars,
    validate_derivation_consistency,
    BUILDER_ALIGNMENT_MAP,
)
```

2. Add CLI arguments (same as main builder):
```python
parser.add_argument("--from-1d", action="store_true",
    help="Derive multi-TF bars from cmc_price_bars_1d instead of price_histories7")
parser.add_argument("--validate-derivation", action="store_true",
    help="Compare derived bars to direct computation (for migration validation)")
```

3. Add derivation path in processing:
```python
def process_id(engine: Engine, id: int, timeframes: list[str], args) -> int:
    # Determine alignment from builder type
    alignment, anchor_mode = BUILDER_ALIGNMENT_MAP["cal_us"]  # or "cal_iso"

    if args.from_1d:
        df_bars = derive_multi_tf_bars(
            engine=engine,
            id=id,
            timeframes=timeframes,
            alignment=alignment,
            anchor_mode=anchor_mode,
        )

        if args.validate_derivation:
            df_direct = compute_bars_directly(engine, id, timeframes)
            is_consistent, discrepancies = validate_derivation_consistency(df_bars, df_direct)
            if not is_consistent:
                logger.warning(f"Derivation discrepancies for id={id}: {discrepancies}")
    else:
        df_bars = compute_bars_directly(engine, id, timeframes)

    # Rest unchanged
```

4. Log alignment mode:
```python
if args.from_1d:
    logger.info(f"Deriving calendar {alignment} bars from cmc_price_bars_1d")
```

NOTE: cal_us uses Sunday week start, cal_iso uses Monday week start.
Both use anchor_mode=False (require complete periods).
  </action>
  <verify>
```bash
# Verify both builders have --from-1d
for script in refresh_cmc_price_bars_multi_tf_cal_us refresh_cmc_price_bars_multi_tf_cal_iso; do
    python src/ta_lab2/scripts/bars/${script}.py --help | grep -q "from-1d" && echo "$script: OK" || echo "$script: MISSING"
done
```
  </verify>
  <done>
- cal_us builder has --from-1d and --validate-derivation
- cal_iso builder has --from-1d and --validate-derivation
- cal_us uses calendar_us alignment (Sunday week start)
- cal_iso uses calendar_iso alignment (Monday week start)
- Both use anchor_mode=False (complete periods only)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add --from-1d to anchor builders (US and ISO)</name>
  <files>
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
  </files>
  <action>
Add --from-1d derivation support to both anchor builders:

For each builder (cal_anchor_us and cal_anchor_iso):

1. Add same imports as Task 2

2. Add same CLI arguments as Task 2

3. Add derivation path with anchor_mode=True:
```python
def process_id(engine: Engine, id: int, timeframes: list[str], args) -> int:
    # Determine alignment from builder type - NOTE anchor_mode=True
    alignment, anchor_mode = BUILDER_ALIGNMENT_MAP["cal_anchor_us"]  # or "cal_anchor_iso"
    # anchor_mode = True allows partial periods at boundaries

    if args.from_1d:
        df_bars = derive_multi_tf_bars(
            engine=engine,
            id=id,
            timeframes=timeframes,
            alignment=alignment,
            anchor_mode=anchor_mode,  # True - allows partial periods
        )
        # ... validation and rest
```

4. Log anchor mode:
```python
if args.from_1d:
    logger.info(f"Deriving anchored calendar {alignment} bars from cmc_price_bars_1d (partial periods allowed)")
```

Key difference from Task 2:
- anchor_mode=True allows partial periods at data boundaries
- is_partial_start/is_partial_end flags set for incomplete periods
- First week of data may be partial, last week may be partial
  </action>
  <verify>
```bash
# Verify both anchor builders have --from-1d
for script in refresh_cmc_price_bars_multi_tf_cal_anchor_us refresh_cmc_price_bars_multi_tf_cal_anchor_iso; do
    python src/ta_lab2/scripts/bars/${script}.py --help | grep -q "from-1d" && echo "$script: OK" || echo "$script: MISSING"
done

# Verify all 5 builders have --from-1d
ls src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf*.py | wc -l
# Expected: 5
for script in $(ls src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf*.py | xargs -n1 basename | sed 's/.py//'); do
    python src/ta_lab2/scripts/bars/${script}.py --help | grep -q "from-1d" && echo "$script: OK" || echo "$script: MISSING"
done
```
  </verify>
  <done>
- cal_anchor_us builder has --from-1d with anchor_mode=True
- cal_anchor_iso builder has --from-1d with anchor_mode=True
- Anchor mode allows partial periods at boundaries
- All 5 multi-TF builders now support --from-1d derivation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. All builders support --from-1d:
```bash
for script in refresh_cmc_price_bars_multi_tf refresh_cmc_price_bars_multi_tf_cal_us refresh_cmc_price_bars_multi_tf_cal_iso refresh_cmc_price_bars_multi_tf_cal_anchor_us refresh_cmc_price_bars_multi_tf_cal_anchor_iso; do
    python src/ta_lab2/scripts/bars/${script}.py --help | grep -q "from-1d" && echo "$script: OK" || echo "$script: MISSING"
done
# Expected: All 5 show OK
```

2. Calendar alignment validation:
```bash
# Run each builder with validation to confirm alignment is correct
for script in cal_us cal_iso cal_anchor_us cal_anchor_iso; do
    python src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_${script}.py \
        --ids 1 --from-1d --validate-derivation 2>&1 | grep -E "consistent|discrepancies"
done
```

3. Partial period handling:
```sql
-- Check that anchor builders produce partial periods
SELECT is_partial_start, is_partial_end, COUNT(*)
FROM cmc_price_bars_multi_tf_cal_anchor_us
WHERE id = 1
GROUP BY is_partial_start, is_partial_end;
-- Anchor should have TRUE values; non-anchor should not
```

4. Unit test verification:
```bash
pytest tests/test_bar_contract.py -v -k "calendar" --tb=short
```
</verification>

<success_criteria>
1. All 5 multi-TF builders have --from-1d flag
2. Calendar builders use correct alignment (US=Sunday, ISO=Monday)
3. Anchor builders allow partial periods (anchor_mode=True)
4. Non-anchor builders require complete periods (anchor_mode=False)
5. Derivation validation passes for all builders (identical to direct computation)
6. Default behavior unchanged (backward compatibility preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/22-critical-data-quality-fixes/22-05-SUMMARY.md`
</output>
