---
phase: 22-critical-data-quality-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ta_lab2/scripts/bars/common_snapshot_contract.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
  - src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Multi-TF builders log OHLC repairs to reject tables before applying fixes"
    - "Reject schema is shared via common_snapshot_contract.py (DRY)"
    - "Both violation_type AND repair_action are recorded for audit trail"
    - "Existing enforce_ohlc_sanity behavior unchanged (repair still happens)"
  artifacts:
    - path: "src/ta_lab2/scripts/bars/common_snapshot_contract.py"
      provides: "Shared reject table schema DDL and logging functions"
      contains: "create_rejects_table_ddl"
    - path: "src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py"
      provides: "Multi-TF builder with reject logging"
      contains: "log_to_rejects"
  key_links:
    - from: "refresh_cmc_price_bars_multi_tf.py"
      to: "common_snapshot_contract.py"
      via: "import log_to_rejects"
      pattern: "from.*common_snapshot_contract.*import.*log_to_rejects"
    - from: "enforce_ohlc_sanity calls"
      to: "rejects table"
      via: "log BEFORE repair"
      pattern: "log_to_rejects.*before.*enforce_ohlc_sanity"
---

<objective>
Create multi-TF reject tables for all 5 multi-TF bar builders to log OHLC repairs with complete audit trail.

Purpose: GAP-C01 identified that multi-TF builders silently repair OHLC violations via enforce_ohlc_sanity() with no visibility. This creates a data quality blind spot - we cannot audit what was repaired or track data quality trends.

Output: Shared reject schema in common_snapshot_contract.py + reject logging integration in all 5 multi-TF builders.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-critical-data-quality-fixes/22-CONTEXT.md

# Key source files
@src/ta_lab2/scripts/bars/common_snapshot_contract.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py
@src/ta_lab2/scripts/bars/refresh_cmc_price_bars_1d.py (reference for existing reject pattern)

# Phase 21 analysis
@.planning/phases/21-comprehensive-review/deliverables/gap-analysis.md (GAP-C01 details)
@.planning/phases/21-comprehensive-review/deliverables/validation-points.md (enforce_ohlc_sanity behavior)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shared reject schema to common_snapshot_contract.py</name>
  <files>src/ta_lab2/scripts/bars/common_snapshot_contract.py</files>
  <action>
Add the following to common_snapshot_contract.py:

1. Create reject table DDL function:
```python
def create_rejects_table_ddl(table_name: str, schema: str = "public") -> str:
    """
    Generate DDL for multi-TF bar rejects table.

    Schema includes:
    - violation_type: What was wrong (high_lt_low, high_lt_oc_max, etc.)
    - repair_action: What was done to fix it (high_low_swapped, high_adjusted, etc.)
    - Original OHLCV values before repair for audit trail
    """
```

2. Create log_to_rejects function:
```python
def log_to_rejects(
    engine: Engine,
    rejects_table: str,
    records: list[dict],
    schema: str = "public"
) -> int:
    """
    Insert reject records to rejects table.

    Each record should have:
    - id, tf, bar_seq, timestamp
    - violation_type, repair_action
    - original_open, original_high, original_low, original_close (before repair)

    Returns: Number of records inserted
    """
```

3. Create detect_ohlc_violations function:
```python
def detect_ohlc_violations(row: dict) -> list[tuple[str, str]]:
    """
    Detect OHLC violations and return list of (violation_type, repair_action) tuples.

    Violations checked (matching enforce_ohlc_sanity logic):
    - high_lt_low: high < low -> swap high/low
    - high_lt_oc_max: high < max(open, close) -> adjust high
    - low_gt_oc_min: low > min(open, close) -> adjust low

    Returns list because a single row can have multiple violations.
    """
```

Follow existing patterns in common_snapshot_contract.py (use sqlalchemy text(), same error handling style).

Table columns:
- id INTEGER
- tf TEXT
- bar_seq INTEGER
- timestamp TIMESTAMPTZ
- violation_type TEXT
- repair_action TEXT
- original_open DOUBLE PRECISION
- original_high DOUBLE PRECISION
- original_low DOUBLE PRECISION
- original_close DOUBLE PRECISION
- created_at TIMESTAMPTZ DEFAULT NOW()
- PRIMARY KEY (id, tf, bar_seq, timestamp, violation_type)
  </action>
  <verify>
```bash
python -c "from ta_lab2.scripts.bars.common_snapshot_contract import create_rejects_table_ddl, log_to_rejects, detect_ohlc_violations; print('Import OK')"
```
  </verify>
  <done>
- create_rejects_table_ddl function returns valid DDL string
- log_to_rejects function accepts engine and records, inserts to table
- detect_ohlc_violations detects all 3 violation types matching enforce_ohlc_sanity
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate reject logging into multi-TF builder</name>
  <files>src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py</files>
  <action>
Modify refresh_cmc_price_bars_multi_tf.py to log OHLC violations before repair:

1. Add import:
```python
from ta_lab2.scripts.bars.common_snapshot_contract import (
    # existing imports...
    create_rejects_table_ddl,
    log_to_rejects,
    detect_ohlc_violations,
)
```

2. Add CLI argument:
```python
parser.add_argument("--keep-rejects", action="store_true",
    help="Log OHLC violations to rejects table before repair")
parser.add_argument("--rejects-table", default="cmc_price_bars_multi_tf_rejects",
    help="Table name for rejects (default: cmc_price_bars_multi_tf_rejects)")
```

3. Create rejects table at script startup (if --keep-rejects):
```python
if args.keep_rejects:
    ddl = create_rejects_table_ddl(args.rejects_table, schema=args.output_schema)
    with engine.begin() as conn:
        conn.execute(text(ddl))
```

4. Before enforce_ohlc_sanity call, detect and log violations:
- Iterate over rows that will be repaired
- Call detect_ohlc_violations for each row
- Build list of reject records with original values
- Call log_to_rejects with accumulated records

5. Keep enforce_ohlc_sanity call UNCHANGED (repair still happens after logging)

Key integration point: Find where enforce_ohlc_sanity is called (likely in build_bars_for_id or similar), add violation detection BEFORE that call.

IMPORTANT: Do NOT change enforce_ohlc_sanity behavior - just add logging before it runs.
  </action>
  <verify>
```bash
# Test with dry run (no actual data changes)
python src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py --help | grep -E "keep-rejects|rejects-table"

# Verify import works
python -c "from ta_lab2.scripts.bars.refresh_cmc_price_bars_multi_tf import main; print('Import OK')"
```
  </verify>
  <done>
- --keep-rejects and --rejects-table CLI arguments available
- Rejects table created automatically when --keep-rejects used
- Violations logged BEFORE enforce_ohlc_sanity repair (original values captured)
- enforce_ohlc_sanity behavior unchanged (bars still repaired)
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate reject logging into remaining 4 calendar builders</name>
  <files>
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_us.py
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_iso.py
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_us.py
src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf_cal_anchor_iso.py
  </files>
  <action>
Apply the same pattern from Task 2 to all 4 calendar variant builders:

For each builder:
1. Add same imports (create_rejects_table_ddl, log_to_rejects, detect_ohlc_violations)
2. Add --keep-rejects and --rejects-table CLI arguments
3. Use builder-specific default rejects table names:
   - cal_us: cmc_price_bars_multi_tf_cal_us_rejects
   - cal_iso: cmc_price_bars_multi_tf_cal_iso_rejects
   - cal_anchor_us: cmc_price_bars_multi_tf_cal_anchor_us_rejects
   - cal_anchor_iso: cmc_price_bars_multi_tf_cal_anchor_iso_rejects
4. Create rejects table at startup (if --keep-rejects)
5. Add violation detection and logging before enforce_ohlc_sanity

All 4 builders should follow identical pattern - only the default rejects table name differs.

IMPORTANT: These builders likely share most code with refresh_cmc_price_bars_multi_tf.py. Look for common integration points (likely the same function where enforce_ohlc_sanity is called).
  </action>
  <verify>
```bash
# Verify all 4 builders have the new arguments
for script in refresh_cmc_price_bars_multi_tf_cal_us refresh_cmc_price_bars_multi_tf_cal_iso refresh_cmc_price_bars_multi_tf_cal_anchor_us refresh_cmc_price_bars_multi_tf_cal_anchor_iso; do
    python src/ta_lab2/scripts/bars/${script}.py --help | grep -q "keep-rejects" && echo "$script: OK" || echo "$script: MISSING"
done
```
  </verify>
  <done>
- All 4 calendar builders have --keep-rejects and --rejects-table arguments
- Each builder uses appropriate default rejects table name
- Violation logging works identically across all 5 multi-TF builders
- Shared code in common_snapshot_contract.py ensures consistent behavior
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema verification:
```sql
-- Check all 5 rejects tables can be created
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public' AND table_name LIKE '%_rejects';
```

2. Functional test (if test data available):
```bash
# Run one builder with --keep-rejects on test ID
python src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf.py --ids 1 --keep-rejects

# Check if any violations were logged
psql -c "SELECT violation_type, COUNT(*) FROM cmc_price_bars_multi_tf_rejects GROUP BY violation_type;"
```

3. Code pattern consistency:
```bash
# All builders should import log_to_rejects
grep -l "log_to_rejects" src/ta_lab2/scripts/bars/refresh_cmc_price_bars_multi_tf*.py | wc -l
# Expected: 5
```
</verification>

<success_criteria>
1. Shared reject schema exists in common_snapshot_contract.py (create_rejects_table_ddl, log_to_rejects, detect_ohlc_violations)
2. All 5 multi-TF builders have --keep-rejects and --rejects-table CLI arguments
3. Violations are logged BEFORE enforce_ohlc_sanity repair (original values captured)
4. enforce_ohlc_sanity behavior unchanged (repairs still happen, no breaking changes)
5. Reject tables have both violation_type AND repair_action columns for complete audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/22-critical-data-quality-fixes/22-01-SUMMARY.md`
</output>
