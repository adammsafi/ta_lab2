---
phase: 16-repository-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .archive/refactored/manifest.json
  - .archive/originals/manifest.json
  - src/ta_lab2/features/m_tf/ema_multi_timeframe.py
  - src/ta_lab2/features/m_tf/ema_multi_tf_cal.py
  - src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor.py
autonomous: true

must_haves:
  truths:
    - "All *_refactored.py files compared against originals and decision made"
    - "All *.original files archived (git history tracks originals)"
    - "Better refactored versions replace originals"
    - "Non-better refactored versions archived with reason"
  artifacts:
    - path: ".archive/refactored/manifest.json"
      provides: "Manifest for refactored files decisions"
      contains: "comparison_result"
    - path: ".archive/originals/manifest.json"
      provides: "Manifest for archived .original files"
      contains: "sha256_checksum"
  key_links:
    - from: "*_refactored.py decision"
      to: "manifest entry"
      via: "comparison_result field"
      pattern: "comparison_result.*(kept|replaced|archived)"
---

<objective>
Compare and decide on *_refactored.py files, archive all *.original files

Purpose: Resolve refactored/original file pairs per CLEAN-01 - diff and decide which is canonical
Output: Clean codebase with single canonical version of each file, decisions documented in manifests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-repository-cleanup/16-CONTEXT.md

# Files to compare
@src/ta_lab2/features/m_tf/ema_multi_timeframe.py
@src/ta_lab2/features/m_tf/ema_multi_timeframe_refactored.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal_refactored.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor.py
@src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor_refactored.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compare *_refactored.py files against originals</name>
  <files>
    src/ta_lab2/features/m_tf/ema_multi_timeframe.py
    src/ta_lab2/features/m_tf/ema_multi_timeframe_refactored.py
    src/ta_lab2/features/m_tf/ema_multi_tf_cal.py
    src/ta_lab2/features/m_tf/ema_multi_tf_cal_refactored.py
    src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor.py
    src/ta_lab2/features/m_tf/ema_multi_tf_cal_anchor_refactored.py
  </files>
  <action>
For each *_refactored.py file in `src/ta_lab2/features/m_tf/`:

1. **ema_multi_timeframe_refactored.py vs ema_multi_timeframe.py**
2. **ema_multi_tf_cal_refactored.py vs ema_multi_tf_cal.py**
3. **ema_multi_tf_cal_anchor_refactored.py vs ema_multi_tf_cal_anchor.py**

For each pair:

**Step 1: Read both files and compare**
- Check docstrings/module-level comments for purpose
- Count lines of code (refactored should not be significantly longer)
- Compare function signatures (should be compatible)
- Check for improved patterns: better error handling, type hints, cleaner logic

**Step 2: Determine which is better**
Criteria for "refactored is better":
- Has type hints where original doesn't
- Has better error handling
- Has cleaner, more readable code
- Has better documentation
- Removes dead code or unnecessary complexity
- Is actually used by callers (check imports from other files)

Criteria for "keep original":
- Refactored introduces bugs or changes behavior
- Refactored is incomplete (placeholder code)
- Original is simpler and refactored adds unnecessary complexity
- Refactored isn't actually being used

**Step 3: Make decision and document**
Create comparison results for manifest:
```python
comparison_result = {
    "original": "ema_multi_timeframe.py",
    "refactored": "ema_multi_timeframe_refactored.py",
    "original_lines": 150,
    "refactored_lines": 180,
    "has_type_hints": {"original": False, "refactored": True},
    "decision": "replace_with_refactored" | "keep_original",
    "reason": "Refactored version has type hints and better error handling"
}
```
  </action>
  <verify>
- Each pair has documented comparison result
- Decision (replace or keep) is clear for each pair
- Reasons are specific and justified
  </verify>
  <done>
All three *_refactored.py pairs compared with documented decisions for each.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute refactored file decisions</name>
  <files>
    .archive/refactored/2026-02-03/
    .archive/refactored/manifest.json
    src/ta_lab2/features/m_tf/
  </files>
  <action>
Based on Task 1 decisions, execute the appropriate action for each pair:

**If decision = "replace_with_refactored":**
1. Archive original to `.archive/refactored/2026-02-03/{original_name}_replaced.py`
2. Rename refactored to original name: `git mv {name}_refactored.py {name}.py`
3. Update manifest with action="replaced", reason

**If decision = "keep_original":**
1. Archive refactored to `.archive/refactored/2026-02-03/{refactored_name}`
2. Keep original in place
3. Update manifest with action="archived", reason

For each file operation:
1. Compute SHA256 checksum before move
2. Use `git mv` to preserve history
3. Commit with descriptive message: `refactor(16-02): replace {name} with refactored version`
4. Add entry to .archive/refactored/manifest.json

**Manifest entry format:**
```json
{
  "original_path": "src/ta_lab2/features/m_tf/ema_multi_timeframe.py",
  "archive_path": ".archive/refactored/2026-02-03/ema_multi_timeframe_replaced.py",
  "action": "replaced",
  "timestamp": "2026-02-03T...",
  "sha256_checksum": "...",
  "size_bytes": 1234,
  "comparison_result": {
    "decision": "replace_with_refactored",
    "reason": "Refactored has type hints and cleaner structure",
    "original_lines": 150,
    "refactored_lines": 180
  },
  "phase_number": "16",
  "archive_reason": "Replaced by refactored version during Phase 16 cleanup"
}
```
  </action>
  <verify>
- No *_refactored.py files remain in src/ta_lab2/features/m_tf/
- Canonical versions exist for ema_multi_timeframe.py, ema_multi_tf_cal.py, ema_multi_tf_cal_anchor.py
- .archive/refactored/manifest.json contains entries for all decisions
- `python -c "from ta_lab2.features.m_tf import ema_multi_timeframe"` imports without error
  </verify>
  <done>
Refactored file decisions executed. Canonical versions in place, archived versions tracked in manifest.
  </done>
</task>

<task type="auto">
  <name>Task 3: Archive all *.original files</name>
  <files>
    .archive/originals/2026-02-03/
    .archive/originals/manifest.json
  </files>
  <action>
Archive all *.original files to `.archive/originals/2026-02-03/`:

**Files to archive:**
From `src/ta_lab2/features/m_tf/`:
- ema_multi_tf_v2.original
- ema_multi_timeframe.original
- ema_multi_tf_cal.original
- ema_multi_tf_cal_anchor.original

From `src/ta_lab2/scripts/emas/`:
- refresh_cmc_ema_multi_tf_cal_anchor_from_bars.original
- refresh_cmc_ema_multi_tf_cal_from_bars.original
- refresh_cmc_ema_multi_tf_v2.original
- refresh_cmc_ema_multi_tf_from_bars.original

For each *.original file:
1. Calculate SHA256 checksum
2. Move with `git mv` to `.archive/originals/2026-02-03/`
3. Add entry to manifest with:
   - original_path
   - archive_path
   - sha256_checksum
   - size_bytes
   - archive_reason: "Git history tracks originals; .original backup files redundant"

**Create .archive/originals/ directory structure if needed:**
```
.archive/originals/
├── manifest.json
└── 2026-02-03/
    ├── ema_multi_tf_v2.original
    ├── ema_multi_timeframe.original
    └── ... (all .original files)
```

**Rationale:** Git history already tracks the original versions of these files. The *.original files were created as manual backups before refactoring. Since git provides a complete history with `git log --follow` and `git show {commit}:{path}`, these backup files are redundant.
  </action>
  <verify>
- `find src -name "*.original"` returns empty
- `ls .archive/originals/2026-02-03/` shows all archived .original files
- `cat .archive/originals/manifest.json | python -m json.tool` is valid JSON
- Checksum count matches file count
  </verify>
  <done>
All *.original files archived to .archive/originals/2026-02-03/ with manifest tracking. No .original files remain in src/.
  </done>
</task>

</tasks>

<verification>
Phase 16 Plan 02 verification:

1. No *_refactored.py files remain:
   ```bash
   find src -name "*_refactored.py" | wc -l  # Should be 0
   ```

2. No *.original files remain:
   ```bash
   find src -name "*.original" | wc -l  # Should be 0
   ```

3. Canonical files importable:
   ```bash
   python -c "from ta_lab2.features.m_tf import ema_multi_timeframe; print('OK')"
   python -c "from ta_lab2.features.m_tf import ema_multi_tf_cal; print('OK')"
   python -c "from ta_lab2.features.m_tf import ema_multi_tf_cal_anchor; print('OK')"
   ```

4. Manifests valid:
   ```bash
   python -c "import json; json.load(open('.archive/refactored/manifest.json'))"
   python -c "import json; json.load(open('.archive/originals/manifest.json'))"
   ```
</verification>

<success_criteria>
- Zero *_refactored.py files in src/
- Zero *.original files in src/
- Canonical ema_multi_*.py files exist and are importable
- .archive/refactored/manifest.json documents all comparison decisions
- .archive/originals/manifest.json tracks all archived .original files
- Git history preserved for all moves
</success_criteria>

<output>
After completion, create `.planning/phases/16-repository-cleanup/16-02-SUMMARY.md`
</output>
